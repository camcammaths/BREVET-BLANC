<!DOCTYPE html>
<html lang="fr"> 
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Brevet Blanc â€” MathÃ©matiques</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,700&family=Source+Serif+4:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Source+Code+Pro:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --cream:#faf6ef;--paper:#f4ede0;--paper2:#ede4d0;
  --ink:#1a1208;--ink2:#3a2e1e;--ink3:#6b5940;--ink4:rgba(26,18,8,.45);
  --navy:#1a3264;--navy2:rgba(26,50,100,.08);--navy3:rgba(26,50,100,.18);
  --green:#1d6b3a;--green2:rgba(29,107,58,.12);
  --gold:#b8870a;--gold2:rgba(184,135,10,.13);
  --red:#c0392b;--red2:rgba(192,57,43,.1);
  --border:rgba(26,18,8,.12);--border2:rgba(26,18,8,.07);
  --shadow:rgba(26,18,8,.10);--shadow2:rgba(26,18,8,.05);
  --premium:#7c3aed;--premium2:rgba(124,58,237,.10);--premium3:rgba(124,58,237,.20);
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{background:var(--paper);color:var(--ink);font-family:'Source Serif 4',Georgia,serif;font-size:16px;line-height:1.78;min-height:100vh}

/* â”€â”€ PAGE TRANSITIONS â”€â”€ */
.screen{display:none;min-height:100vh;animation:fadeIn .25s ease}
.screen.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ GLOBAL NAV BAR â”€â”€ */
.global-nav{
  position:sticky;top:0;z-index:300;
  background:var(--ink);
  border-bottom:1px solid rgba(255,255,255,.07);
  padding:0 48px;
  display:flex;align-items:center;height:52px;gap:0;
}
.nav-logo{font-family:'Playfair Display',serif;font-size:17px;font-weight:900;color:var(--cream);letter-spacing:-.5px;margin-right:32px;cursor:pointer;flex-shrink:0}
.nav-logo em{color:#e8c84a;font-style:italic}
.nav-links{display:flex;align-items:center;gap:0;flex:1}
.nav-link{
  display:flex;align-items:center;gap:7px;
  padding:0 16px;height:52px;
  font-size:13px;font-weight:600;color:rgba(250,246,239,.45);
  background:none;border:none;cursor:pointer;transition:all .15s;
  font-family:'Source Serif 4',serif;border-bottom:2px solid transparent;
  white-space:nowrap;
}
.nav-link:hover{color:rgba(250,246,239,.8)}
.nav-link.active{color:var(--cream);border-bottom-color:#e8c84a}
.nav-link .nav-icon{font-size:14px;opacity:.7}
.nav-right{display:flex;align-items:center;gap:10px;margin-left:auto}
.nav-free-badge{font-size:11px;font-weight:700;color:var(--ink3);background:var(--paper2);padding:3px 10px;border-radius:20px;letter-spacing:.5px}
.nav-premium-badge{font-size:11px;font-weight:700;color:var(--premium);background:var(--premium2);padding:3px 10px;border-radius:20px;border:1px solid var(--premium3);letter-spacing:.5px}
.btn-upgrade-nav{
  padding:6px 16px;
  font-family:'Source Serif 4',serif;font-size:12px;font-weight:700;
  background:var(--premium);color:white;border:none;border-radius:20px;cursor:pointer;
  transition:all .2s;letter-spacing:.3px;
}
.btn-upgrade-nav:hover{background:#6d28d9;transform:translateY(-1px)}
.btn-upgrade-nav.hidden{display:none}

/* â”€â”€ SHARED BUTTONS â”€â”€ */
.btn-primary{display:inline-flex;align-items:center;gap:8px;padding:11px 28px;font-family:'Source Serif 4',serif;font-size:14px;font-weight:600;background:var(--navy);color:var(--cream);border:none;border-radius:3px;cursor:pointer;transition:all .2s}
.btn-primary:hover{background:#0f2048;transform:translateY(-1px);box-shadow:0 4px 14px rgba(26,50,100,.3)}
.btn-secondary{display:inline-flex;align-items:center;gap:8px;padding:10px 24px;font-family:'Source Serif 4',serif;font-size:14px;background:transparent;color:var(--ink3);border:1.5px solid var(--border);border-radius:3px;cursor:pointer;transition:all .2s}
.btn-secondary:hover{border-color:var(--ink2);color:var(--ink2)}
.btn-green{display:inline-flex;align-items:center;gap:7px;padding:8px 20px;font-family:'Source Serif 4',serif;font-size:13px;font-weight:600;background:var(--green);color:white;border:none;border-radius:3px;cursor:pointer;transition:all .2s}
.btn-green:hover{background:#155c2e}
.btn-green:disabled{background:var(--border);color:var(--ink4);cursor:not-allowed}
.section-rule{display:flex;align-items:center;gap:14px;font-size:11px;font-weight:600;letter-spacing:2.5px;text-transform:uppercase;color:var(--ink4);margin-bottom:16px}
.section-rule::after{content:'';flex:1;height:1px;background:var(--border)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN 0 â€” SETUP / HOME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-setup{background:var(--cream)}
.setup-hero{background:var(--ink);position:relative;overflow:hidden}
.setup-hero::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(-45deg,transparent,transparent 38px,rgba(184,135,10,.06) 38px,rgba(184,135,10,.06) 39px)}
.setup-hero-inner{max-width:900px;margin:0 auto;padding:44px 48px 40px;position:relative;z-index:2;display:grid;grid-template-columns:1fr auto;gap:24px;align-items:end}
.header-badge{display:inline-flex;align-items:center;border:1.5px solid var(--gold);color:#e8c84a;font-size:9px;letter-spacing:3.5px;text-transform:uppercase;padding:4px 14px;margin-bottom:14px;font-family:'Source Serif 4',serif}
.setup-hero h1{font-family:'Playfair Display',serif;font-size:clamp(36px,5vw,60px);font-weight:900;line-height:1.0;letter-spacing:-1.5px;color:var(--cream)}
.setup-hero h1 em{color:#e8c84a;font-style:italic}
.setup-hero-sub{margin-top:10px;font-size:13px;font-weight:300;color:rgba(250,246,239,.5);display:flex;gap:16px;flex-wrap:wrap}
.setup-hero-sub span::before{content:'Â·';margin-right:6px;color:var(--gold)}
.hero-stats{display:flex;flex-direction:column;gap:8px}
.stat-box{display:flex;align-items:center;gap:10px;padding:10px 18px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);border-radius:3px}
.stat-box .val{font-family:'Playfair Display',serif;font-size:22px;font-weight:900;color:var(--cream);line-height:1}
.stat-box .lbl{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(250,246,239,.4)}

/* Free usage bar */
.free-usage-bar{background:var(--navy2);border:1px solid var(--navy3);border-radius:3px;padding:12px 18px;margin-bottom:28px;display:flex;align-items:center;gap:14px;flex-wrap:wrap}
.free-usage-bar.hidden{display:none}
.fub-text{font-size:13px;color:var(--navy);flex:1}
.fub-text strong{font-weight:700}
.fub-dots{display:flex;gap:5px}
.fub-dot{width:10px;height:10px;border-radius:50%;background:var(--navy3);transition:.3s}
.fub-dot.used{background:var(--navy)}

.setup-body{max-width:900px;margin:0 auto;padding:36px 48px 80px}
.setup-section{margin-bottom:34px}
.timer-row{display:flex;gap:8px;flex-wrap:wrap}
.timer-chip{padding:9px 20px;font-family:'Source Serif 4',serif;font-size:14px;background:white;border:1.5px solid var(--border);color:var(--ink2);border-radius:3px;cursor:pointer;transition:all .2s}
.timer-chip:hover{border-color:var(--navy);color:var(--navy)}
.timer-chip.selected{background:var(--navy);border-color:var(--navy);color:white}
.chapter-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px}
.chapter-chip{padding:12px 15px;background:white;border:1.5px solid var(--border);border-radius:3px;cursor:pointer;transition:all .2s;display:flex;align-items:flex-start;gap:10px;position:relative}
.chapter-chip:hover{border-color:var(--navy3);background:var(--navy2)}
.chapter-chip.selected{border-color:var(--navy);background:var(--navy2)}
.chapter-chip.locked{opacity:.55;cursor:default}
.chapter-chip.locked:hover{border-color:var(--border);background:white}
.ch-check{width:15px;height:15px;border:1.5px solid var(--border);border-radius:2px;flex-shrink:0;margin-top:3px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;transition:all .2s}
.chapter-chip.selected .ch-check{background:var(--navy);border-color:var(--navy);color:white}
.ch-name{font-size:14px;font-weight:600;color:var(--ink)}
.ch-sub{font-size:12px;color:var(--ink4);font-style:italic;margin-top:1px}
.lock-icon{position:absolute;top:10px;right:10px;font-size:11px;color:var(--premium);background:var(--premium2);padding:2px 7px;border-radius:10px;font-weight:700;font-style:normal}

.setup-cta{display:flex;align-items:center;gap:16px;margin-top:32px;flex-wrap:wrap}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN 1 â€” EXAM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-exam{background:var(--cream)}
.exam-topbar{background:var(--ink);box-shadow:0 2px 12px rgba(26,18,8,.2)}
.exam-topbar-inner{max-width:960px;margin:0 auto;padding:10px 48px;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.exam-title{font-family:'Playfair Display',serif;font-size:17px;font-weight:700;color:var(--cream)}
.exam-subtitle{font-size:11px;letter-spacing:1.5px;text-transform:uppercase;color:rgba(250,246,239,.4);margin-top:1px}
.timer-block{margin-left:auto;display:flex;align-items:center;gap:16px}
.timer-face{font-family:'Source Code Pro',monospace;font-size:20px;font-weight:500;color:#e8c84a;letter-spacing:2px;line-height:1}
.timer-face.warn{color:#fb923c}.timer-face.danger{color:#f87171;animation:blink .8s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
.live-score-box{text-align:right}
.live-score-num{font-family:'Playfair Display',serif;font-size:22px;font-weight:900;color:#e8c84a;line-height:1}
.live-score-lbl{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(250,246,239,.35)}
.btn-end{padding:7px 16px;font-family:'Source Serif 4',serif;font-size:12px;background:rgba(192,57,43,.2);border:1px solid rgba(192,57,43,.35);color:#fca5a5;border-radius:3px;cursor:pointer;transition:all .2s}
.btn-end:hover{background:var(--red);color:white}
.pills-nav{background:var(--paper2);border-bottom:1px solid var(--border)}
.pills-nav-inner{max-width:960px;margin:0 auto;padding:8px 48px;display:flex;align-items:center;gap:7px;overflow-x:auto}
.pill{padding:4px 14px;font-family:'Source Serif 4',serif;font-size:12px;font-weight:600;background:transparent;border:1.5px solid var(--border);color:var(--ink3);border-radius:2px;cursor:pointer;transition:all .2s;white-space:nowrap}
.pill:hover{border-color:var(--navy);color:var(--navy)}
.pill.answered{border-color:var(--navy);color:var(--navy);background:var(--navy2)}
.pill.corrected{border-color:var(--green);color:white;background:var(--green)}
.exam-main{max-width:960px;margin:0 auto;padding:36px 48px 100px}
.loading-box{text-align:center;padding:80px 20px}
.spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--navy);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-box p{font-size:13px;font-style:italic;color:var(--ink3)}

/* Exercise */
.exercise{background:var(--cream);border:1px solid var(--border);border-radius:4px;margin-bottom:36px;overflow:hidden;box-shadow:0 2px 8px var(--shadow2);scroll-margin-top:110px;position:relative}
.exercise::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;background:var(--navy)}
.exercise-head{padding:20px 28px 18px 36px;border-bottom:1px solid var(--border);background:rgba(250,246,239,.6);display:flex;align-items:flex-start;justify-content:space-between;gap:16px}
.ex-eyebrow{font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--navy);font-weight:600;margin-bottom:5px}
.ex-title{font-family:'Playfair Display',serif;font-size:20px;font-weight:700;color:var(--ink);line-height:1.2}
.ex-notion{font-size:13px;font-style:italic;color:var(--ink3);margin-top:3px}
.ex-pts-badge{flex-shrink:0;padding:8px 16px;background:var(--navy2);border:1px solid var(--navy3);border-radius:3px;text-align:center}
.ex-pts-badge .num{font-family:'Playfair Display',serif;font-size:28px;font-weight:900;color:var(--navy);line-height:1}
.ex-pts-badge .lbl{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--navy);opacity:.7}
.exercise-body{padding:22px 28px 28px 36px}
.exercise-body>p{margin-bottom:12px;color:var(--ink2)}

table{width:100%;border-collapse:collapse;margin:14px 0;font-size:14px}
th{background:var(--paper2);color:var(--ink);padding:9px 14px;text-align:left;font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;border:1px solid var(--border)}
td{padding:9px 14px;border:1px solid var(--border2);color:var(--ink2)}
tr:nth-child(even) td{background:rgba(26,18,8,.025)}
.f{font-family:'Source Code Pro',monospace;font-size:13px;color:var(--navy);background:var(--navy2);padding:1px 8px;border-radius:2px;margin:0 2px;border-bottom:1.5px solid var(--navy3)}

.question{margin:16px 0;border:1px solid var(--border);border-left:3px solid var(--navy);background:rgba(250,246,239,.5);border-radius:0 3px 3px 0;overflow:hidden}
.q-head{padding:10px 16px;border-bottom:1px solid var(--border2);display:flex;align-items:center;gap:10px}
.q-num{font-size:13px;font-weight:700;color:var(--navy);font-family:'Source Serif 4',serif}
.q-pts-badge{display:inline-flex;align-items:center;padding:3px 10px;background:var(--green);color:white;font-size:11px;font-weight:700;border-radius:3px;font-family:'Source Serif 4',serif}
.q-text{padding:13px 16px 15px;font-size:15px;color:var(--ink);line-height:1.72}

.answer-zone{padding:12px 16px 14px;background:rgba(26,50,100,.03);border-top:1px dashed var(--border)}
.answer-lbl{font-size:10px;letter-spacing:2.5px;text-transform:uppercase;color:var(--ink4);margin-bottom:7px;display:flex;align-items:center;gap:6px}
.answer-lbl::before{content:'âœ';font-size:13px;color:var(--navy)}
.answer-textarea{width:100%;min-height:80px;padding:10px 12px;font-family:'Source Serif 4',serif;font-size:15px;line-height:1.65;color:var(--ink);background:white;border:1.5px solid var(--border);border-radius:3px 3px 0 0;resize:vertical;outline:none;transition:border-color .2s,box-shadow .2s}
.answer-textarea::placeholder{color:var(--ink4);font-style:italic}
.answer-textarea:focus{border-color:var(--navy);box-shadow:0 0 0 3px rgba(26,50,100,.08)}
.answer-textarea.has-content{border-color:rgba(26,50,100,.35)}
.answer-textarea.locked{border-color:var(--green)!important;background:rgba(29,107,58,.04)!important;color:var(--ink2);resize:none;cursor:default}

.validate-bar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;padding:8px 12px;background:var(--paper2);border:1.5px solid var(--border);border-top:none;border-radius:0 0 3px 3px}
.btn-validate{display:inline-flex;align-items:center;gap:6px;padding:7px 18px;font-family:'Source Serif 4',serif;font-size:12px;font-weight:600;background:var(--navy);color:white;border:none;border-radius:3px;cursor:pointer;transition:all .2s}
.btn-validate:hover{background:#0f2048}
.btn-validate:disabled{background:var(--border);color:var(--ink4);cursor:not-allowed}
.btn-edit{display:none;align-items:center;gap:5px;padding:6px 14px;font-family:'Source Serif 4',serif;font-size:12px;background:transparent;border:1.5px solid var(--border);color:var(--ink3);border-radius:3px;cursor:pointer;transition:all .2s}
.btn-edit:hover{border-color:var(--ink2);color:var(--ink2)}
.validated-tag{display:none;align-items:center;gap:5px;font-size:12px;color:var(--green);font-weight:600}
.validated-tag.show{display:flex}
.validate-hint{font-size:11px;font-style:italic;color:var(--ink4);margin-left:auto}

.ai-result{display:none;margin-top:10px;border-radius:3px;overflow:hidden;border:1.5px solid var(--border);animation:fadeUp .3s ease}
.ai-result.visible{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(-5px)}to{opacity:1;transform:translateY(0)}}
.ai-result-header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;gap:10px}
.ai-result-header.correct-bg{background:rgba(29,107,58,.1);border-bottom:1px solid rgba(29,107,58,.2)}
.ai-result-header.partial-bg{background:rgba(184,135,10,.1);border-bottom:1px solid rgba(184,135,10,.2)}
.ai-result-header.wrong-bg{background:rgba(192,57,43,.08);border-bottom:1px solid rgba(192,57,43,.15)}
.ai-result-header.loading-bg{background:var(--paper2);border-bottom:1px solid var(--border)}
.ai-result-label{display:flex;align-items:center;gap:8px;font-size:13px;font-weight:600}
.ai-score{font-family:'Playfair Display',serif;font-size:22px;font-weight:900;line-height:1;white-space:nowrap}
.ai-score.correct-col{color:var(--green)}.ai-score.partial-col{color:var(--gold)}.ai-score.wrong-col{color:var(--red)}.ai-score.loading-col{color:var(--ink4);font-size:14px;font-family:'Source Serif 4',serif}
.ai-feedback{padding:11px 14px;font-size:14px;line-height:1.65;color:var(--ink2);background:white;font-style:italic}
.mini-spinner{display:inline-block;width:13px;height:13px;border:2px solid var(--border);border-top-color:var(--navy);border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle}

.correction-toggle{margin-top:22px;padding-top:18px;border-top:1px dashed var(--border);display:flex;align-items:center;gap:14px;flex-wrap:wrap}
.btn-see{display:inline-flex;align-items:center;gap:7px;padding:8px 20px;font-family:'Source Serif 4',serif;font-size:13px;font-weight:600;background:transparent;border:1.5px solid var(--gold);color:var(--gold);border-radius:3px;cursor:pointer;transition:all .2s}
.btn-see:hover:not(:disabled){background:var(--gold2)}
.btn-see.active{background:var(--gold);color:white;border-color:var(--gold)}
.btn-see:disabled{border-color:var(--border);color:var(--ink4);cursor:not-allowed;opacity:.5}
.toggle-hint{font-size:12px;font-style:italic;color:var(--ink4)}
.correction{display:none;margin-top:16px;padding:18px 22px;background:rgba(184,135,10,.07);border:1px solid rgba(184,135,10,.22);border-radius:3px}
.correction.open{display:block;animation:fadeUp .3s ease}
.corr-head{display:flex;align-items:center;gap:9px;padding-bottom:12px;margin-bottom:14px;border-bottom:1px solid rgba(184,135,10,.2)}
.corr-badge{width:20px;height:20px;background:var(--gold);color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;flex-shrink:0}
.corr-head span{font-size:10px;letter-spacing:2.5px;text-transform:uppercase;color:var(--gold);font-weight:600}
.correction p{margin-bottom:9px;font-size:14px;color:var(--ink2)}
.correction p:last-child{margin-bottom:0}
.ans{font-weight:700;color:var(--ink);font-style:normal}
.corr-block{margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid rgba(184,135,10,.12)}
.corr-block:last-child{border-bottom:none;padding-bottom:0;margin-bottom:0}
.corr-title{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--gold);font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:7px}
.corr-title::before{content:'Â§';font-size:14px}

.footer-strip{border-top:2px solid var(--border);padding:24px 48px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px;margin-top:8px}
.footer-strip p{font-size:13px;font-style:italic;color:var(--ink4)}
.footer-total{font-family:'Playfair Display',serif;font-size:48px;font-weight:900;color:var(--ink);line-height:1}
.footer-total sub{font-size:16px;font-weight:400;color:var(--ink4);vertical-align:middle}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN 2 â€” RESULTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-results{background:var(--cream)}
.results-banner{background:var(--ink);padding:44px 48px 40px;position:relative;overflow:hidden}
.results-banner::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(-45deg,transparent,transparent 38px,rgba(184,135,10,.06) 38px,rgba(184,135,10,.06) 39px)}
.results-inner{max-width:860px;margin:0 auto;position:relative;z-index:2;display:grid;grid-template-columns:1fr auto;gap:32px;align-items:center}
.results-eyebrow{font-size:10px;letter-spacing:3px;text-transform:uppercase;color:rgba(250,246,239,.4);font-weight:600;margin-bottom:10px}
.results-score{font-family:'Playfair Display',serif;font-size:clamp(64px,10vw,100px);font-weight:900;line-height:.9;letter-spacing:-3px;color:var(--cream)}
.results-score span{font-size:clamp(24px,4vw,38px);color:rgba(250,246,239,.35);font-weight:400}
.results-mention{font-size:16px;font-weight:600;color:#e8c84a;margin-top:12px}
.results-bar-wrap{margin-top:16px;height:6px;background:rgba(255,255,255,.1);border-radius:3px;overflow:hidden;max-width:440px}
.results-bar{height:100%;border-radius:3px;transition:width 1.2s ease}
.results-detail{display:flex;flex-direction:column;gap:10px;min-width:130px}
.res-stat{padding:11px 16px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);border-radius:3px;text-align:center}
.res-stat .val{font-family:'Playfair Display',serif;font-size:22px;font-weight:900;color:#e8c84a;line-height:1}
.res-stat .lbl{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(250,246,239,.35);margin-top:3px}

.results-body{max-width:860px;margin:0 auto;padding:32px 48px 72px;display:grid;grid-template-columns:1fr 1fr;gap:40px}
.breakdown-row{display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--border2)}
.breakdown-row:last-child{border-bottom:none}
.breakdown-notion{font-size:13px;font-weight:600;color:var(--ink3)}
.breakdown-pts{font-family:'Playfair Display',serif;font-size:17px;font-weight:700}
.breakdown-pct{height:3px;background:var(--border2);border-radius:2px;margin-top:3px;overflow:hidden}
.breakdown-pct-fill{height:100%;border-radius:2px;transition:width .9s ease}
.error-card{padding:12px 16px;background:white;border:1px solid var(--border);border-left:3px solid var(--red);border-radius:0 3px 3px 0;margin-bottom:8px}
.error-q{font-size:13px;color:var(--ink2);margin-bottom:5px}
.error-score{font-size:11px;font-weight:700;letter-spacing:.5px}
.error-fb{font-size:12px;font-style:italic;color:var(--ink4);margin-top:4px}
.results-cta{grid-column:1/-1;display:flex;gap:12px;flex-wrap:wrap;justify-content:center;padding-top:16px;border-top:1px solid var(--border)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN 3 â€” DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-dash{background:var(--cream)}
.dash-banner{background:var(--ink);padding:40px 48px 36px;position:relative;overflow:hidden}
.dash-banner::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(-45deg,transparent,transparent 38px,rgba(184,135,10,.06) 38px,rgba(184,135,10,.06) 39px)}
.dash-banner-inner{max-width:960px;margin:0 auto;position:relative;z-index:2}
.dash-banner h2{font-family:'Playfair Display',serif;font-size:clamp(28px,4vw,44px);font-weight:900;color:var(--cream);letter-spacing:-1px;line-height:1}
.dash-banner h2 em{color:#e8c84a;font-style:italic}
.dash-banner p{font-size:13px;color:rgba(250,246,239,.4);margin-top:8px}
.dash-body{max-width:960px;margin:0 auto;padding:32px 48px 72px}

/* Premium upsell in dash */
.dash-upsell{background:var(--premium2);border:1px solid var(--premium3);border-radius:4px;padding:20px 24px;margin-bottom:28px;display:flex;align-items:center;gap:20px;flex-wrap:wrap}
.dash-upsell.hidden{display:none}
.dash-upsell-text h3{font-family:'Playfair Display',serif;font-size:17px;font-weight:700;color:var(--premium);margin-bottom:4px}
.dash-upsell-text p{font-size:13px;color:var(--ink3)}
.btn-upgrade-upsell{padding:9px 22px;font-family:'Source Serif 4',serif;font-size:13px;font-weight:700;background:var(--premium);color:white;border:none;border-radius:3px;cursor:pointer;transition:all .2s;white-space:nowrap}
.btn-upgrade-upsell:hover{background:#6d28d9}

.stat-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:32px}
.stat-card{padding:18px 20px;background:white;border:1px solid var(--border);border-radius:3px;box-shadow:0 1px 4px var(--shadow2)}
.stat-card .s-val{font-family:'Playfair Display',serif;font-size:32px;font-weight:900;line-height:1;color:var(--ink)}
.stat-card .s-val.navy{color:var(--navy)}.stat-card .s-val.green{color:var(--green)}.stat-card .s-val.gold{color:var(--gold)}.stat-card .s-val.red{color:var(--red)}
.stat-card .s-lbl{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--ink4);margin-top:6px}

/* Chart */
.score-chart{margin-bottom:32px}
.chart-wrap{height:120px;display:flex;align-items:flex-end;gap:6px;padding:8px 0 0;border-bottom:1px solid var(--border)}
.chart-bar-col{display:flex;flex-direction:column;align-items:center;gap:4px;flex:1;min-width:0}
.chart-bar{width:100%;border-radius:2px 2px 0 0;transition:height .6s ease;min-height:2px;cursor:default}
.chart-bar:hover{filter:brightness(1.1)}
.chart-label{font-size:9px;color:var(--ink4);text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%}
.chart-val{font-size:10px;font-weight:700;color:var(--ink3);text-align:center}

.dash-grid{display:grid;grid-template-columns:3fr 2fr;gap:32px}

.hist-table{width:100%;border-collapse:collapse}
.hist-table th{padding:9px 12px;text-align:left;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--ink4);border-bottom:2px solid var(--border);font-weight:600}
.hist-table td{padding:10px 12px;border-bottom:1px solid var(--border2);font-size:14px;color:var(--ink2)}
.hist-table tr:hover td{background:rgba(26,18,8,.02);cursor:default}
.score-chip{display:inline-block;padding:3px 10px;border-radius:2px;font-family:'Playfair Display',serif;font-size:13px;font-weight:700}
.score-chip.a{background:rgba(29,107,58,.12);color:var(--green)}.score-chip.b{background:rgba(184,135,10,.12);color:var(--gold)}.score-chip.c{background:rgba(192,57,43,.1);color:var(--red)}

.notion-bar-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.nb-label{font-size:12px;font-weight:600;color:var(--ink3);width:150px;flex-shrink:0}
.nb-track{flex:1;height:5px;background:var(--border2);border-radius:3px;overflow:hidden}
.nb-fill{height:100%;border-radius:3px;transition:width .8s ease}
.nb-count{font-size:11px;font-weight:700;color:var(--ink4);width:24px;text-align:right}

.empty-dash{text-align:center;padding:60px 20px;color:var(--ink4)}
.empty-dash .e-icon{font-size:48px;display:block;margin-bottom:14px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN 4 â€” PRICING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-pricing{background:var(--cream)}
.pricing-banner{background:var(--ink);padding:44px 48px 40px;position:relative;overflow:hidden;text-align:center}
.pricing-banner::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(-45deg,transparent,transparent 38px,rgba(124,58,237,.06) 38px,rgba(124,58,237,.06) 39px)}
.pricing-banner-inner{max-width:640px;margin:0 auto;position:relative;z-index:2}
.pricing-eyebrow{display:inline-flex;align-items:center;gap:6px;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--premium);background:var(--premium2);padding:5px 16px;border-radius:20px;margin-bottom:16px;font-weight:700}
.pricing-banner h2{font-family:'Playfair Display',serif;font-size:clamp(32px,5vw,52px);font-weight:900;color:var(--cream);letter-spacing:-1.5px;line-height:1.05}
.pricing-banner h2 em{color:#e8c84a;font-style:italic}
.pricing-banner p{font-size:15px;color:rgba(250,246,239,.5);margin-top:12px;line-height:1.6}

.pricing-body{max-width:900px;margin:0 auto;padding:40px 48px 80px}

/* Toggle monthly/annual */
.billing-toggle{display:flex;align-items:center;justify-content:center;gap:14px;margin-bottom:36px}
.billing-toggle span{font-size:14px;font-weight:600;color:var(--ink3)}
.toggle-switch{position:relative;width:48px;height:26px;background:var(--navy);border-radius:13px;cursor:pointer;transition:.3s}
.toggle-switch.annual{background:var(--premium)}
.toggle-switch::after{content:'';position:absolute;top:3px;left:3px;width:20px;height:20px;background:white;border-radius:50%;transition:.3s}
.toggle-switch.annual::after{left:25px}
.billing-save{font-size:11px;font-weight:700;color:var(--premium);background:var(--premium2);padding:2px 10px;border-radius:10px;border:1px solid var(--premium3)}

.plans-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:44px}
@media(max-width:640px){.plans-grid{grid-template-columns:1fr}}

.plan-card{background:white;border:1.5px solid var(--border);border-radius:6px;padding:28px 28px 24px;position:relative;transition:.25s}
.plan-card.featured{border-color:var(--premium);box-shadow:0 0 0 3px var(--premium3)}
.plan-badge{position:absolute;top:-11px;left:50%;transform:translateX(-50%);background:var(--premium);color:white;font-size:10px;font-weight:800;letter-spacing:2px;text-transform:uppercase;padding:4px 16px;border-radius:20px;white-space:nowrap}
.plan-name{font-family:'Playfair Display',serif;font-size:22px;font-weight:900;color:var(--ink);margin-bottom:6px}
.plan-desc{font-size:13px;color:var(--ink3);margin-bottom:20px;font-style:italic}
.plan-price{display:flex;align-items:baseline;gap:5px;margin-bottom:6px}
.plan-price .amount{font-family:'Playfair Display',serif;font-size:42px;font-weight:900;color:var(--ink);line-height:1}
.plan-price .currency{font-size:20px;font-weight:700;color:var(--ink);margin-top:8px}
.plan-price .period{font-size:13px;color:var(--ink4)}
.plan-price-annual{font-size:12px;color:var(--premium);font-style:italic;margin-bottom:20px;min-height:18px}
.plan-features{list-style:none;margin-bottom:24px;display:flex;flex-direction:column;gap:8px}
.plan-features li{display:flex;align-items:flex-start;gap:10px;font-size:14px;color:var(--ink2)}
.plan-features li .fi{width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;flex-shrink:0;margin-top:2px}
.plan-features li .fi.yes{background:rgba(29,107,58,.12);color:var(--green)}
.plan-features li .fi.no{background:rgba(26,18,8,.06);color:var(--ink4)}
.plan-features li.dim{color:var(--ink4)}

.btn-plan-free{width:100%;padding:12px;font-family:'Source Serif 4',serif;font-size:14px;font-weight:600;background:transparent;border:1.5px solid var(--border);color:var(--ink3);border-radius:3px;cursor:pointer;transition:all .2s;text-align:center}
.btn-plan-free:hover{border-color:var(--ink2);color:var(--ink2)}
.btn-plan-premium{width:100%;padding:12px;font-family:'Source Serif 4',serif;font-size:14px;font-weight:700;background:var(--premium);color:white;border:none;border-radius:3px;cursor:pointer;transition:all .2s;text-align:center}
.btn-plan-premium:hover{background:#6d28d9;transform:translateY(-1px);box-shadow:0 4px 16px rgba(124,58,237,.3)}

/* Trust badges */
.trust-row{display:flex;align-items:center;justify-content:center;gap:28px;flex-wrap:wrap;padding-top:28px;border-top:1px solid var(--border)}
.trust-item{display:flex;align-items:center;gap:7px;font-size:12px;color:var(--ink4)}
.trust-item span{font-size:16px}

/* FAQ */
.faq-section{margin-top:40px}
.faq-item{border-bottom:1px solid var(--border);padding:16px 0}
.faq-q{display:flex;align-items:center;justify-content:space-between;cursor:pointer;font-size:15px;font-weight:600;color:var(--ink)}
.faq-q:hover{color:var(--navy)}
.faq-q .arrow{font-size:12px;color:var(--ink4);transition:.2s}
.faq-a{display:none;padding-top:10px;font-size:14px;color:var(--ink3);line-height:1.7}
.faq-item.open .faq-a{display:block}
.faq-item.open .arrow{transform:rotate(180deg)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN 5 â€” CHECKOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-checkout{background:var(--cream)}
.checkout-layout{max-width:860px;margin:0 auto;padding:40px 48px 80px;display:grid;grid-template-columns:1fr 380px;gap:40px;align-items:start}
@media(max-width:720px){.checkout-layout{grid-template-columns:1fr;padding:24px}}

/* Order summary */
.order-summary{background:white;border:1.5px solid var(--border);border-radius:6px;overflow:hidden;position:sticky;top:80px}
.order-summary-head{padding:20px 22px;background:var(--premium2);border-bottom:1px solid var(--premium3)}
.order-summary-head h3{font-family:'Playfair Display',serif;font-size:18px;font-weight:900;color:var(--premium)}
.order-rows{padding:18px 22px}
.order-row{display:flex;justify-content:space-between;align-items:baseline;padding:8px 0;border-bottom:1px solid var(--border2);font-size:14px;color:var(--ink2)}
.order-row:last-child{border-bottom:none}
.order-total-row{display:flex;justify-content:space-between;align-items:baseline;padding:14px 22px;background:var(--premium2);border-top:2px solid var(--premium3)}
.order-total-row .label{font-size:13px;font-weight:700;color:var(--premium)}
.order-total-row .amount{font-family:'Playfair Display',serif;font-size:26px;font-weight:900;color:var(--premium)}
.order-guarantee{padding:14px 22px;text-align:center;font-size:12px;color:var(--ink4);font-style:italic;border-top:1px solid var(--border2)}

/* Stripe-style payment form */
.checkout-form-wrap h2{font-family:'Playfair Display',serif;font-size:26px;font-weight:900;letter-spacing:-.5px;margin-bottom:6px}
.checkout-form-wrap p{font-size:13px;color:var(--ink3);margin-bottom:28px}

.form-section-label{font-size:10px;letter-spacing:2.5px;text-transform:uppercase;font-weight:700;color:var(--ink4);margin-bottom:12px;display:flex;align-items:center;gap:10px}
.form-section-label::after{content:'';flex:1;height:1px;background:var(--border)}

.form-row{display:grid;gap:12px;margin-bottom:14px}
.form-row.cols-2{grid-template-columns:1fr 1fr}
.form-row.cols-3{grid-template-columns:2fr 1fr 1fr}
.form-field{display:flex;flex-direction:column;gap:5px}
.form-field label{font-size:12px;font-weight:600;color:var(--ink2);letter-spacing:.3px}
.form-input{padding:11px 14px;font-family:'Source Serif 4',serif;font-size:15px;color:var(--ink);background:white;border:1.5px solid var(--border);border-radius:3px;outline:none;transition:.2s}
.form-input:focus{border-color:var(--navy);box-shadow:0 0 0 3px rgba(26,50,100,.08)}
.form-input::placeholder{color:var(--ink4)}
.card-icons{display:flex;gap:6px;margin-bottom:4px}
.card-icon{padding:3px 8px;background:var(--paper2);border:1px solid var(--border);border-radius:3px;font-size:11px;font-weight:700;color:var(--ink3)}
.card-field-wrap{position:relative}
.card-lock{position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:14px;color:var(--ink4)}

.btn-pay{width:100%;padding:14px;font-family:'Source Serif 4',serif;font-size:16px;font-weight:700;background:var(--premium);color:white;border:none;border-radius:3px;cursor:pointer;transition:all .2s;margin-top:20px;display:flex;align-items:center;justify-content:center;gap:10px}
.btn-pay:hover{background:#6d28d9;transform:translateY(-1px);box-shadow:0 4px 18px rgba(124,58,237,.35)}
.pay-secure{text-align:center;margin-top:12px;font-size:11px;color:var(--ink4);display:flex;align-items:center;justify-content:center;gap:6px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN 6 â€” SUCCESS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-success{background:var(--cream)}
.success-inner{max-width:560px;margin:0 auto;padding:80px 48px;text-align:center}
.success-check{width:80px;height:80px;background:rgba(29,107,58,.12);border:2px solid rgba(29,107,58,.3);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:32px;margin:0 auto 28px}
.success-inner h2{font-family:'Playfair Display',serif;font-size:36px;font-weight:900;letter-spacing:-1px;margin-bottom:12px}
.success-inner h2 em{color:var(--premium);font-style:italic}
.success-inner p{font-size:15px;color:var(--ink3);line-height:1.7;margin-bottom:32px}
.success-perks{display:flex;flex-direction:column;gap:10px;text-align:left;background:var(--premium2);border:1px solid var(--premium3);border-radius:6px;padding:20px 24px;margin-bottom:32px}
.perk-item{display:flex;align-items:center;gap:10px;font-size:14px;font-weight:600;color:var(--ink2)}
.perk-item span{font-size:16px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:680px){
  .global-nav{padding:0 16px}
  .nav-links{gap:0}
  .nav-link{padding:0 10px;font-size:12px}
  .setup-hero-inner,.setup-body,.exam-topbar-inner,.pills-nav-inner,.exam-main,.results-banner,.results-inner,.results-body,.dash-banner-inner,.dash-body,.pricing-body,.pricing-banner,.footer-strip{padding-left:16px;padding-right:16px}
  .setup-hero-inner{grid-template-columns:1fr}
  .results-inner{grid-template-columns:1fr}
  .results-body,.dash-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• GLOBAL NAV â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav class="global-nav" id="globalNav">
  <div class="nav-logo" onclick="showScreen('screen-setup')"><em>Brevet</em> Blanc</div>
  <div class="nav-links">
    <button class="nav-link active" id="navHome" onclick="navTo('screen-setup','navHome')">
      <span class="nav-icon">ğŸ </span> Accueil
    </button>
    <button class="nav-link" id="navDash" onclick="navTo('screen-dash','navDash');showDash()">
      <span class="nav-icon">ğŸ“Š</span> Tableau de bord
    </button>
    <button class="nav-link" id="navPricing" onclick="navTo('screen-pricing','navPricing')">
      <span class="nav-icon">â­</span> Premium
    </button>
  </div>
  <div class="nav-right">
    <span class="nav-free-badge" id="navFreeBadge">Gratuit Â· 3/3</span>
    <span class="nav-premium-badge hidden" id="navPremiumBadge">âœ¦ Premium</span>
    <button class="btn-upgrade-nav" id="btnUpgradeNav" onclick="navTo('screen-pricing','navPricing')">Passer Premium</button>
  </div>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• SCREEN 0 â€” SETUP â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen active" id="screen-setup">
  <div class="setup-hero">
    <div class="setup-hero-inner">
      <div>
        <div class="header-badge">MathÃ©matiques Â· DNB</div>
        <h1><em>Brevet</em> Blanc</h1>
        <div class="setup-hero-sub">
          <span>Exercices alÃ©atoires issus des vrais sujets</span>
          <span>Correction IA instantanÃ©e</span>
          <span>Suivi de progression</span>
        </div>
      </div>
      <div class="hero-stats">
        <div class="stat-box"><div class="val">100</div><div class="lbl">Points</div></div>
        <div class="stat-box"><div class="val" id="setupTimerVal">2h</div><div class="lbl">DurÃ©e</div></div>
      </div>
    </div>
  </div>

  <div class="setup-body">

    <!-- Free usage bar -->
    <div class="free-usage-bar" id="freeUsageBar">
      <div>
        <div class="fub-text" id="fubText"><strong>3 brevets gratuits</strong> disponibles aujourd'hui</div>
        <div style="font-size:11px;color:var(--ink4);margin-top:2px;font-style:italic">Passez Premium pour un accÃ¨s illimitÃ©</div>
      </div>
      <div class="fub-dots" id="fubDots">
        <div class="fub-dot"></div><div class="fub-dot"></div><div class="fub-dot"></div>
      </div>
      <button class="btn-upgrade-upsell" onclick="navTo('screen-pricing','navPricing')" style="font-size:12px;padding:7px 16px">Voir Premium â†’</button>
    </div>

    <div class="setup-section">
      <div class="section-rule">DurÃ©e de l'Ã©preuve</div>
      <div class="timer-row" id="timerRow">
        <div class="timer-chip selected" data-min="120" onclick="selectTimer(this)">2h â€” DurÃ©e rÃ©elle</div>
        <div class="timer-chip" data-min="60" onclick="selectTimer(this)">1 heure</div>
        <div class="timer-chip" data-min="30" onclick="selectTimer(this)">30 min</div>
        <div class="timer-chip" data-min="10" onclick="selectTimer(this)">10 min</div>
        <div class="timer-chip" data-min="5" onclick="selectTimer(this)">5 min</div>
      </div>
    </div>

    <div class="setup-section">
      <div class="section-rule">Notions Ã  travailler</div>
      <div class="chapter-grid" id="chapterGrid">
        <div class="chapter-chip selected" data-id="all" onclick="toggleChap(this)">
          <div class="ch-check">âœ“</div>
          <div><div class="ch-name">Toutes les notions</div><div class="ch-sub">Sujet complet type brevet</div></div>
        </div>
        <div class="chapter-chip" data-id="probabilites" onclick="toggleChap(this)">
          <div class="ch-check"></div>
          <div><div class="ch-name">ProbabilitÃ©s</div><div class="ch-sub">FrÃ©quences, Ã©vÃ©nements</div></div>
        </div>
        <div class="chapter-chip" data-id="proportionnalite" onclick="toggleChap(this)">
          <div class="ch-check"></div>
          <div><div class="ch-name">ProportionnalitÃ©</div><div class="ch-sub">Coefficients, pourcentages</div></div>
        </div>
        <div class="chapter-chip" data-id="statistiques" onclick="toggleChap(this)">
          <div class="ch-check"></div>
          <div><div class="ch-name">Statistiques</div><div class="ch-sub">Moyenne, mÃ©diane, quartiles</div></div>
        </div>
        <div class="chapter-chip" data-id="geometrie" onclick="toggleChap(this)">
          <div class="ch-check"></div>
          <div><div class="ch-name">GÃ©omÃ©trie</div><div class="ch-sub">Pythagore, trigonomÃ©trie</div></div>
        </div>
        <div class="chapter-chip" data-id="algebre" onclick="toggleChap(this)">
          <div class="ch-check"></div>
          <div><div class="ch-name">AlgÃ¨bre</div><div class="ch-sub">Ã‰quations, fonctions affines</div></div>
        </div>
        <div class="chapter-chip locked" data-id="puissances" onclick="promptUpgrade(this)">
          <div class="ch-check"></div>
          <div><div class="ch-name">Puissances & fractions</div><div class="ch-sub">Notation scientifique</div></div>
          <em class="lock-icon">âœ¦ Pro</em>
        </div>
        <div class="chapter-chip locked" data-id="pgcd" onclick="promptUpgrade(this)">
          <div class="ch-check"></div>
          <div><div class="ch-name">ArithmÃ©tique</div><div class="ch-sub">PGCD, facteurs premiers</div></div>
          <em class="lock-icon">âœ¦ Pro</em>
        </div>
        <div class="chapter-chip locked" data-id="programmation" onclick="promptUpgrade(this)">
          <div class="ch-check"></div>
          <div><div class="ch-name">Algorithmique</div><div class="ch-sub">Programmes de calcul</div></div>
          <em class="lock-icon">âœ¦ Pro</em>
        </div>
        <div class="chapter-chip locked" data-id="volumes" onclick="promptUpgrade(this)">
          <div class="ch-check"></div>
          <div><div class="ch-name">Volumes & grandeurs</div><div class="ch-sub">PavÃ©s, cylindres</div></div>
          <em class="lock-icon">âœ¦ Pro</em>
        </div>
      </div>
    </div>

    <div class="setup-cta">
      <button class="btn-primary" id="btnStartExam" onclick="startExam()" style="font-size:15px;padding:13px 32px">GÃ©nÃ©rer mon brevet blanc â†’</button>
      <span style="font-size:13px;font-style:italic;color:var(--ink4)" id="freeRemainingHint"></span>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• SCREEN 1 â€” EXAM â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-exam">
  <div class="exam-topbar">
    <div class="exam-topbar-inner">
      <div>
        <div class="exam-title">Brevet Blanc â€” MathÃ©matiques</div>
        <div class="exam-subtitle" id="examSubtitle">Chargementâ€¦</div>
      </div>
      <div class="timer-block">
        <div>
          <div class="timer-face" id="timerFace">02:00:00</div>
          <div style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(250,246,239,.3);text-align:center">Temps</div>
        </div>
        <div class="live-score-box">
          <div class="live-score-num" id="liveScore">0</div>
          <div class="live-score-lbl">pts</div>
        </div>
        <button class="btn-end" onclick="endEarly()">Terminer</button>
      </div>
    </div>
  </div>
  <div class="pills-nav"><div class="pills-nav-inner" id="pillsNav"></div></div>
  <div class="exam-main">
    <div class="loading-box" id="loadingBox"><div class="spinner"></div><p>GÃ©nÃ©ration des exercicesâ€¦</p></div>
    <div id="exContainer"></div>
    <div class="footer-strip" id="examFooter" style="display:none">
      <div>
        <div style="font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--ink4);font-weight:600;margin-bottom:4px">Total provisoire</div>
        <p>Validez vos rÃ©ponses pour calculer votre score</p>
      </div>
      <div class="footer-total"><span id="footerScore">0</span><sub> /100</sub></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• SCREEN 2 â€” RESULTS â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-results">
  <div class="results-banner">
    <div class="results-inner">
      <div>
        <div class="results-eyebrow">RÃ©sultats Â· Brevet Blanc</div>
        <div class="results-score" id="resScore">0 <span>/ 100</span></div>
        <div class="results-mention" id="resMention"></div>
        <div class="results-bar-wrap"><div class="results-bar" id="resBar" style="width:0%"></div></div>
      </div>
      <div class="results-detail">
        <div class="res-stat"><div class="val" id="resCorrect">0</div><div class="lbl">Correctes</div></div>
        <div class="res-stat"><div class="val" id="resPartial">0</div><div class="lbl">Partielles</div></div>
        <div class="res-stat"><div class="val" id="resWrong">0</div><div class="lbl">Incorrectes</div></div>
      </div>
    </div>
  </div>
  <div class="results-body">
    <div>
      <div class="section-rule">Par notion</div>
      <div id="resByNotion"></div>
    </div>
    <div>
      <div class="section-rule">Points Ã  retravailler</div>
      <div id="resErrors"></div>
    </div>
    <div class="results-cta">
      <button class="btn-primary" onclick="navTo('screen-setup','navHome')" style="font-size:14px;padding:12px 28px">â†º Nouveau brevet</button>
      <button class="btn-secondary" onclick="navTo('screen-dash','navDash');showDash()">ğŸ“Š Tableau de bord</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• SCREEN 3 â€” DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-dash">
  <div class="dash-banner">
    <div class="dash-banner-inner">
      <h2>Tableau de <em>bord</em></h2>
      <p>Votre historique complet et analyse de progression</p>
    </div>
  </div>
  <div class="dash-body">
    <!-- Premium upsell -->
    <div class="dash-upsell" id="dashUpsell">
      <div class="dash-upsell-text" style="flex:1">
        <h3>âœ¦ DÃ©bloquez l'analyse complÃ¨te</h3>
        <p>Historique illimitÃ©, graphiques de progression, analyse par notion et recommandations personnalisÃ©es.</p>
      </div>
      <button class="btn-upgrade-upsell" onclick="navTo('screen-pricing','navPricing')">Passer Premium â†’</button>
    </div>
    <div class="stat-row" id="dashStats"></div>
    <!-- Score chart -->
    <div class="score-chart" id="scoreChart" style="display:none">
      <div class="section-rule">Progression des scores</div>
      <div class="chart-wrap" id="chartWrap"></div>
    </div>
    <div class="dash-grid" id="dashGrid"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• SCREEN 4 â€” PRICING â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-pricing">
  <div class="pricing-banner">
    <div class="pricing-banner-inner">
      <div class="pricing-eyebrow">âœ¦ Passez Ã  la vitesse supÃ©rieure</div>
      <h2>PrÃ©parez votre brevet<br>avec <em>confiance</em></h2>
      <p>AccÃ¨s illimitÃ© Ã  tous les exercices, correction IA dÃ©taillÃ©e, suivi de progression complet.</p>
    </div>
  </div>
  <div class="pricing-body">

    <div class="billing-toggle">
      <span>Mensuel</span>
      <div class="toggle-switch" id="billingToggle" onclick="toggleBilling()"></div>
      <span>Annuel</span>
      <span class="billing-save">âˆ’40%</span>
    </div>

    <div class="plans-grid">
      <!-- FREE -->
      <div class="plan-card">
        <div class="plan-name">Gratuit</div>
        <div class="plan-desc">Pour dÃ©couvrir la plateforme</div>
        <div class="plan-price">
          <span class="currency">â‚¬</span>
          <span class="amount">0</span>
          <span class="period">/ mois</span>
        </div>
        <div class="plan-price-annual">&nbsp;</div>
        <ul class="plan-features">
          <li><span class="fi yes">âœ“</span> 3 brevets blancs par jour</li>
          <li><span class="fi yes">âœ“</span> 6 notions disponibles</li>
          <li><span class="fi yes">âœ“</span> Correction IA basique</li>
          <li class="dim"><span class="fi no">âœ—</span> Tableau de bord</li>
          <li class="dim"><span class="fi no">âœ—</span> Historique illimitÃ©</li>
          <li class="dim"><span class="fi no">âœ—</span> Toutes les notions</li>
          <li class="dim"><span class="fi no">âœ—</span> Analyse par notion</li>
        </ul>
        <button class="btn-plan-free" onclick="navTo('screen-setup','navHome')">Continuer gratuitement</button>
      </div>

      <!-- PREMIUM -->
      <div class="plan-card featured">
        <div class="plan-badge">RecommandÃ©</div>
        <div class="plan-name" style="color:var(--premium)">âœ¦ Premium</div>
        <div class="plan-desc">Pour rÃ©ussir son brevet</div>
        <div class="plan-price">
          <span class="currency" style="color:var(--premium)">â‚¬</span>
          <span class="amount" id="planAmount" style="color:var(--premium)">9</span>
          <span class="period">/ mois</span>
        </div>
        <div class="plan-price-annual" id="planAnnualNote">ou 64,80 â‚¬ / an (âˆ’40%)</div>
        <ul class="plan-features">
          <li><span class="fi yes">âœ“</span><strong>Brevets illimitÃ©s</strong></li>
          <li><span class="fi yes">âœ“</span> Toutes les 10 notions</li>
          <li><span class="fi yes">âœ“</span> Correction IA dÃ©taillÃ©e</li>
          <li><span class="fi yes">âœ“</span> Tableau de bord complet</li>
          <li><span class="fi yes">âœ“</span> Historique illimitÃ©</li>
          <li><span class="fi yes">âœ“</span> Graphiques de progression</li>
          <li><span class="fi yes">âœ“</span> Analyse des points faibles</li>
        </ul>
        <button class="btn-plan-premium" onclick="goCheckout()">Commencer maintenant â†’</button>
      </div>
    </div>

    <div class="trust-row">
      <div class="trust-item"><span>ğŸ”’</span> Paiement sÃ©curisÃ© Stripe</div>
      <div class="trust-item"><span>â†©ï¸</span> Remboursement 14 jours</div>
      <div class="trust-item"><span>âŒ</span> Sans engagement</div>
      <div class="trust-item"><span>ğŸ“</span> +2 000 Ã©lÃ¨ves prÃ©parÃ©s</div>
    </div>

    <div class="faq-section">
      <div class="section-rule" style="margin-top:36px">Questions frÃ©quentes</div>
      <div class="faq-item" onclick="toggleFaq(this)">
        <div class="faq-q">Puis-je annuler Ã  tout moment ? <span class="arrow">â–¼</span></div>
        <div class="faq-a">Oui, vous pouvez annuler votre abonnement Ã  tout moment depuis votre espace personnel. Vous gardez l'accÃ¨s Premium jusqu'Ã  la fin de la pÃ©riode en cours.</div>
      </div>
      <div class="faq-item" onclick="toggleFaq(this)">
        <div class="faq-q">Les exercices sont-ils vrais ? <span class="arrow">â–¼</span></div>
        <div class="faq-a">Oui, tous les exercices sont modÃ©lisÃ©s sur les vrais sujets du DiplÃ´me National du Brevet 2025, compilÃ©s par l'APMEP.</div>
      </div>
      <div class="faq-item" onclick="toggleFaq(this)">
        <div class="faq-q">Comment fonctionne la correction IA ? <span class="arrow">â–¼</span></div>
        <div class="faq-a">Vos rÃ©ponses sont analysÃ©es par Claude (Anthropic) qui compare votre dÃ©marche Ã  la rÃ©ponse officielle et vous attribue des points avec un feedback personnalisÃ©.</div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• SCREEN 5 â€” CHECKOUT â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-checkout">
  <div class="checkout-layout">
    <!-- Form -->
    <div class="checkout-form-wrap">
      <button class="btn-secondary" style="margin-bottom:24px;font-size:13px;padding:7px 16px" onclick="navTo('screen-pricing','navPricing')">â† Retour</button>
      <h2>Finaliser l'abonnement</h2>
      <p>Vous serez dÃ©bitÃ© <strong id="checkoutAmount">9 â‚¬/mois</strong>. Sans engagement, annulable Ã  tout moment.</p>

      <div class="form-section-label">Informations personnelles</div>
      <div class="form-row cols-2">
        <div class="form-field"><label>PrÃ©nom</label><input class="form-input" type="text" placeholder="Marie"></div>
        <div class="form-field"><label>Nom</label><input class="form-input" type="text" placeholder="Dupont"></div>
      </div>
      <div class="form-row">
        <div class="form-field"><label>Adresse e-mail</label><input class="form-input" type="email" placeholder="marie.dupont@gmail.com"></div>
      </div>

      <div class="form-section-label" style="margin-top:24px">Informations de paiement</div>
      <div class="card-icons">
        <span class="card-icon">VISA</span><span class="card-icon">MC</span><span class="card-icon">AMEX</span>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label>NumÃ©ro de carte</label>
          <div class="card-field-wrap">
            <input class="form-input" type="text" placeholder="1234 5678 9012 3456" maxlength="19" oninput="formatCard(this)" style="width:100%;padding-right:40px">
            <span class="card-lock">ğŸ”’</span>
          </div>
        </div>
      </div>
      <div class="form-row cols-3">
        <div class="form-field"><label>Date d'expiration</label><input class="form-input" type="text" placeholder="MM / AA" maxlength="7"></div>
        <div class="form-field"><label>CVC</label><input class="form-input" type="text" placeholder="123" maxlength="3"></div>
        <div class="form-field"><label>Code postal</label><input class="form-input" type="text" placeholder="75001"></div>
      </div>

      <button class="btn-pay" onclick="simulatePay()">
        <span>ğŸ”’</span> <span id="payBtnText">Payer 9 â‚¬/mois</span>
      </button>
      <div class="pay-secure"><span>ğŸ”’</span> Paiement sÃ©curisÃ© SSL Â· PropulsÃ© par Stripe</div>
    </div>

    <!-- Order summary -->
    <div class="order-summary">
      <div class="order-summary-head">
        <h3>âœ¦ Brevet Blanc Premium</h3>
      </div>
      <div class="order-rows">
        <div class="order-row"><span>Abonnement <span id="summaryPlan">mensuel</span></span><span id="summaryPrice">9,00 â‚¬</span></div>
        <div class="order-row"><span>AccÃ¨s immÃ©diat</span><span>âœ“</span></div>
        <div class="order-row"><span>Annulation</span><span>Ã€ tout moment</span></div>
        <div class="order-row" id="summaryDiscountRow" style="display:none"><span style="color:var(--green)">Ã‰conomie annuelle</span><span style="color:var(--green)" id="summaryDiscount">âˆ’64,80 â‚¬</span></div>
      </div>
      <div class="order-total-row"><span class="label">Total aujourd'hui</span><span class="amount" id="summaryTotal">9,00 â‚¬</span></div>
      <div class="order-guarantee">ğŸ›¡ï¸ Garantie satisfait ou remboursÃ© 14 jours</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• SCREEN 6 â€” SUCCESS â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-success">
  <div class="success-inner">
    <div class="success-check">âœ“</div>
    <h2>Bienvenue dans<br><em>Premium</em> !</h2>
    <p>Votre abonnement est actif. Vous avez maintenant accÃ¨s Ã  toutes les fonctionnalitÃ©s pour prÃ©parer votre brevet avec confiance.</p>
    <div class="success-perks">
      <div class="perk-item"><span>â™¾ï¸</span> Brevets blancs illimitÃ©s</div>
      <div class="perk-item"><span>ğŸ“š</span> Les 10 notions dÃ©bloquÃ©es</div>
      <div class="perk-item"><span>ğŸ¤–</span> Correction IA complÃ¨te</div>
      <div class="perk-item"><span>ğŸ“Š</span> Tableau de bord avancÃ©</div>
    </div>
    <button class="btn-primary" style="margin:0 auto;font-size:15px;padding:13px 32px" onclick="activatePremium()">Commencer â†’</button>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let selMin = 120;
let selChaps = ['all'];
let timerIv = null;
let secsLeft = 0;
let exerciseData = [];
let scores = {};
let validated = {};
let feedbacks = {};
let isPremium = false;
let freeUsed = 0;
let isAnnual = false;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVIGATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo({top:0,behavior:'smooth'});
}

function navTo(screenId, navId){
  showScreen(screenId);
  document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active'));
  if(navId) document.getElementById(navId)?.classList.add('active');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PREMIUM STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadPremiumState(){
  try{
    const d = await window.storage.get('isPremium');
    isPremium = d && d.value === 'true';
    const fu = await window.storage.get('freeUsed');
    if(fu) freeUsed = parseInt(fu.value)||0;
    // reset daily if needed
    const dayKey = new Date().toDateString();
    const lastDay = await window.storage.get('freeDay');
    if(!lastDay || lastDay.value !== dayKey){
      freeUsed = 0;
      await window.storage.set('freeDay', dayKey);
      await window.storage.set('freeUsed', '0');
    }
  }catch(e){}
  updatePremiumUI();
}

function updatePremiumUI(){
  const navFree = document.getElementById('navFreeBadge');
  const navPrem = document.getElementById('navPremiumBadge');
  const btnUpNav = document.getElementById('btnUpgradeNav');
  const fubBar = document.getElementById('freeUsageBar');
  const dashUpsell = document.getElementById('dashUpsell');

  if(isPremium){
    navFree.classList.add('hidden');
    navPrem.classList.remove('hidden');
    btnUpNav.classList.add('hidden');
    fubBar.classList.add('hidden');
    if(dashUpsell) dashUpsell.classList.add('hidden');
    // unlock all chapters
    document.querySelectorAll('.chapter-chip.locked').forEach(c=>{
      c.classList.remove('locked');
      c.onclick = ()=>toggleChap(c);
      const lock = c.querySelector('.lock-icon');
      if(lock) lock.remove();
    });
  } else {
    const rem = 3 - freeUsed;
    navFree.textContent = `Gratuit Â· ${Math.max(0,rem)}/3`;
    // Update dots
    const dots = document.getElementById('fubDots');
    if(dots){
      dots.querySelectorAll('.fub-dot').forEach((d,i)=>d.classList.toggle('used', i < freeUsed));
    }
    const fubText = document.getElementById('fubText');
    if(fubText) fubText.innerHTML = rem > 0 ? `<strong>${rem} brevet${rem>1?'s':''} gratuit${rem>1?'s':''}</strong> disponible${rem>1?'s':''} aujourd'hui` : '<strong>Limite atteinte</strong> pour aujourd\'hui';
    const hint = document.getElementById('freeRemainingHint');
    if(hint) hint.textContent = rem <= 0 ? 'Limite quotidienne atteinte â€” Passez Premium !' : '';
    const startBtn = document.getElementById('btnStartExam');
    if(startBtn) startBtn.disabled = rem <= 0;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXERCISE BANK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const BANK = {
  probabilites:[
    {title:"ProbabilitÃ©s â€” Urne et tirage alÃ©atoire",notion:"ProbabilitÃ©s",pts:20,
     intro:"Dans une urne de 40 boules indiscernables au toucher, 5 sont rouges, 20 sont vertes et 15 sont blanches. On tire une boule au hasard.",
     questions:[
       {pts:7,text:"Calculer la probabilitÃ© d'obtenir une boule verte. Justifier.",ans:"P(verte) = 20/40 = 1/2 = 0,5"},
       {pts:7,text:"Calculer la probabilitÃ© d'obtenir une boule qui n'est pas rouge.",ans:"P(non rouge) = (20+15)/40 = 35/40 = 7/8 â‰ˆ 0,875"},
       {pts:6,text:"On rÃ©pÃ¨te l'expÃ©rience 200 fois. Combien de boules vertes peut-on espÃ©rer approximativement ?",ans:"200 Ã— 1/2 = 100 boules vertes environ"}
     ]},
    {title:"ProbabilitÃ©s â€” DÃ© Ã©quilibrÃ©",notion:"ProbabilitÃ©s",pts:18,
     intro:"On lance un dÃ© Ã©quilibrÃ© Ã  6 faces numÃ©rotÃ©es de 1 Ã  6.",
     questions:[
       {pts:6,text:"Quelle est la probabilitÃ© d'obtenir un nombre pair ?",ans:"Issues paires : 2, 4, 6 â†’ P = 3/6 = 1/2"},
       {pts:6,text:"Quelle est la probabilitÃ© d'obtenir un nombre strictement supÃ©rieur Ã  4 ?",ans:"Issues : 5 et 6 â†’ P = 2/6 = 1/3"},
       {pts:6,text:"On lance 300 fois et on obtient 55 fois le chiffre 1. La frÃ©quence est-elle proche de la probabilitÃ© thÃ©orique ? Commenter.",ans:"P thÃ©orique = 1/6 â‰ˆ 16,7%. FrÃ©quence = 55/300 â‰ˆ 18,3%. Proche mais lÃ©gÃ¨rement supÃ©rieure â€” variation alÃ©atoire normale."}
     ]}
  ],
  proportionnalite:[
    {title:"ProportionnalitÃ© & Pourcentages",notion:"ProportionnalitÃ©",pts:20,
     intro:"Un article coÃ»te 25 â‚¬. Le magasin propose plusieurs opÃ©rations commerciales.",
     questions:[
       {pts:7,text:"Calculer le prix de l'article aprÃ¨s une augmentation de 14 %.",ans:"25 Ã— 1,14 = 28,50 â‚¬"},
       {pts:7,text:"Un second article coÃ»te 80 â‚¬ avec une rÃ©duction de 20 %. Calculer son nouveau prix.",ans:"80 Ã— 0,80 = 64 â‚¬"},
       {pts:6,text:"Un article passe de 45 â‚¬ Ã  36 â‚¬. Calculer le taux de rÃ©duction en %.",ans:"(45âˆ’36)/45 Ã— 100 = 20%"}
     ]},
    {title:"ProportionnalitÃ© â€” Agrandissement et aires",notion:"ProportionnalitÃ©",pts:20,
     intro:"Le polygone B est un agrandissement du polygone A. Coefficient d'agrandissement : 2,5. Aire de A : 7,5 cmÂ².",
     questions:[
       {pts:7,text:"Calculer l'aire du polygone B. Rappel : si les longueurs sont multipliÃ©es par k, les aires sont multipliÃ©es par kÂ².",ans:"Aire B = 7,5 Ã— 2,5Â² = 7,5 Ã— 6,25 = 46,875 cmÂ²"},
       {pts:7,text:"Le pÃ©rimÃ¨tre de A est 12 cm. Calculer le pÃ©rimÃ¨tre de B.",ans:"PÃ©rimÃ¨tre B = 12 Ã— 2,5 = 30 cm"},
       {pts:6,text:"Polygone C : coefficient 0,4 par rapport Ã  A. Calculer son aire.",ans:"Aire C = 7,5 Ã— 0,4Â² = 7,5 Ã— 0,16 = 1,2 cmÂ²"}
     ]}
  ],
  statistiques:[
    {title:"Statistiques â€” Indicateurs de position",notion:"Statistiques",pts:20,
     intro:"Dans une classe de 3Ã¨me, rÃ©partition des tailles des Ã©lÃ¨ves :",
     tableData:{headers:["Taille (cm)","152","157","160","162","165","170","174","180"],rows:[["Effectif","2","4","2","5","2","4","6","5"]]},
     questions:[
       {pts:8,text:"Calculer la moyenne des tailles (arrondir au dixiÃ¨me).",ans:"Somme = 5016. Effectif = 30. Moyenne = 167,2 cm"},
       {pts:6,text:"DÃ©terminer la mÃ©diane.",ans:"30 Ã©lÃ¨ves â†’ entre 15e et 16e. 15e = 165 cm, 16e = 170 cm. MÃ©diane = 167,5 cm"},
       {pts:6,text:"Calculer Q1, Q3 et l'Ã©cart interquartile.",ans:"Q1 = 8e valeur = 160 cm. Q3 = 23e valeur = 174 cm. IQR = 14 cm"}
     ]},
    {title:"Statistiques â€” Masses et probabilitÃ©s",notion:"Statistiques",pts:19,
     intro:"5 colis (A, B, C, D, E) de masses (kg) : 4, 9, 2, 7, 11.",
     questions:[
       {pts:7,text:"Calculer la moyenne des masses.",ans:"(4+9+2+7+11)/5 = 6,6 kg"},
       {pts:6,text:"DÃ©terminer la mÃ©diane. InterprÃ©ter.",ans:"TriÃ©es : 2,4,7,9,11. MÃ©diane = 7 kg. La moitiÃ© des colis pÃ¨sent moins de 7 kg."},
       {pts:6,text:"ProbabilitÃ© de choisir un colis de masse < 8 kg.",ans:"Colis < 8 : A(4), C(2), D(7) â†’ P = 3/5"}
     ]}
  ],
  geometrie:[
    {title:"GÃ©omÃ©trie â€” Pythagore & triangles semblables",notion:"GÃ©omÃ©trie",pts:24,
     intro:"Triangle CDE rectangle en D. CD = 21,6 cm, CE = 29,1 cm, FC = 17,2 cm. (GF) âˆ¥ (DE).",
     questions:[
       {pts:8,text:"Montrer que DE = 19,5 cm.",ans:"DEÂ² = CEÂ² âˆ’ CDÂ² = 29,1Â² âˆ’ 21,6Â² = 381,25. DE = 19,5 cm âœ“"},
       {pts:8,text:"Calculer l'aire du triangle CDE.",ans:"Aire = (21,6 Ã— 19,5)/2 = 210,6 cmÂ²"},
       {pts:8,text:"(GF) âˆ¥ (DE). Calculer GF au mm prÃ¨s.",ans:"GF = DE Ã— FC/DC = 19,5 Ã— 17,2/21,6 â‰ˆ 15,5 cm"}
     ]},
    {title:"GÃ©omÃ©trie â€” Terrain triangulaire",notion:"GÃ©omÃ©trie",pts:21,
     intro:"Triangle ABC rectangle en B. AB = 600 m, BC = 450 m, CD = 270 m.",
     questions:[
       {pts:7,text:"Montrer que AC = 750 m.",ans:"ACÂ² = 600Â² + 450Â² = 562500. AC = 750 m âœ“"},
       {pts:7,text:"Montrer que (DE) âˆ¥ (AB) et calculer DE.",ans:"CD/CB = 0,6. (DE) âˆ¥ (AB). DE = 600 Ã— 0,6 = 360 m"},
       {pts:7,text:"Calculer l'aire du triangle CDE.",ans:"Aire CDE = 135000 Ã— 0,36 = 48600 mÂ²"}
     ]}
  ],
  algebre:[
    {title:"AlgÃ¨bre â€” Programme de calcul",notion:"AlgÃ¨bre",pts:20,
     intro:"Programme : choisir x â†’ Ã—(âˆ’2) â†’ +4 â†’ Ã—4.",
     questions:[
       {pts:5,text:"Montrer que pour x = 1, le rÃ©sultat est 8.",ans:"1Ã—(âˆ’2)=âˆ’2. âˆ’2+4=2. 2Ã—4=8 âœ“"},
       {pts:5,text:"RÃ©sultat pour x = âˆ’2 ?",ans:"âˆ’2Ã—(âˆ’2)=4. 4+4=8. 8Ã—4=32"},
       {pts:5,text:"Montrer que le rÃ©sultat s'Ã©crit âˆ’8x + 16.",ans:"x â†’ âˆ’2x â†’ âˆ’2x+4 â†’ 4(âˆ’2x+4) = âˆ’8x+16 âœ“"},
       {pts:5,text:"RÃ©soudre âˆ’8x + 16 = 4.",ans:"âˆ’8x = âˆ’12. x = 3/2 = 1,5"}
     ]},
    {title:"AlgÃ¨bre â€” Rectangle et Ã©quation",notion:"AlgÃ¨bre",pts:20,
     intro:"Rectangle ABCD avec AD = x et AB = 16âˆ’2x. CarrÃ© EFGH avec EF = 2x.",
     questions:[
       {pts:5,text:"Pour x = 1,5, calculer le pÃ©rimÃ¨tre du carrÃ© EFGH.",ans:"EF = 3 cm. PÃ©rimÃ¨tre = 12 cm"},
       {pts:5,text:"Pour x = 1,5, calculer AB. VÃ©rifier AB > 0.",ans:"AB = 13 cm > 0 âœ“"},
       {pts:5,text:"Montrer que le pÃ©rimÃ¨tre du rectangle s'Ã©crit âˆ’2x + 32.",ans:"P = 2(x + 16âˆ’2x) = 32âˆ’2x âœ“"},
       {pts:5,text:"Trouver x pour que les deux pÃ©rimÃ¨tres soient Ã©gaux.",ans:"âˆ’2x+32 = 8x â†’ x = 3,2 cm"}
     ]}
  ],
  puissances:[
    {title:"Puissances & notation scientifique",notion:"Puissances",pts:15,
     intro:"Exercice de calcul sur les puissances de 10.",
     questions:[
       {pts:5,text:"Ã‰crire en puissance de 10 : a) 10â´ Ã— 10Â³   b) 10â· Ã· 10Â²   c) (10Â³)Â²",ans:"a) 10â·   b) 10âµ   c) 10â¶"},
       {pts:5,text:"Ã‰crire en notation scientifique : a) 0,000 045   b) 12 800 000",ans:"a) 4,5 Ã— 10â»âµ   b) 1,28 Ã— 10â·"},
       {pts:5,text:"DiamÃ¨tre d'un atome : 2,4 Ã— 10â»Â¹â° m. Atomes pour couvrir 1 mm ?",ans:"N = 10â»Â³ Ã· (2,4Ã—10â»Â¹â°) â‰ˆ 4,2 Ã— 10â¶ atomes"}
     ]}
  ],
  pgcd:[
    {title:"ArithmÃ©tique â€” PGCD et lots",notion:"ArithmÃ©tique",pts:15,
     intro:"350 poissons de type A et 300 de type B Ã  rÃ©partir en lots identiques.",
     questions:[
       {pts:5,text:"DÃ©composer 300 en facteurs premiers.",ans:"300 = 2Â² Ã— 3 Ã— 5Â²"},
       {pts:5,text:"DÃ©composer 350 en facteurs premiers.",ans:"350 = 2 Ã— 5Â² Ã— 7"},
       {pts:5,text:"Calculer le PGCD et le nombre maximal de lots.",ans:"PGCD = 50. Maximum 50 lots : 7 poissons A et 6 poissons B par lot."}
     ]}
  ],
  programmation:[
    {title:"Algorithmique â€” Deux programmes",notion:"Algorithmique",pts:20,
     intro:"Programme A : x â†’ Ã—3 â†’ +15 â†’ Ã·3 â†’ âˆ’x. Programme B : x â†’ (xâˆ’1)Ã—(xâˆ’6) â†’ +5.",
     questions:[
       {pts:5,text:"Montrer que pour x = 4, A donne 5.",ans:"4Ã—3=12. 12+15=27. 27Ã·3=9. 9âˆ’4=5 âœ“"},
       {pts:5,text:"Justifier que A donne toujours le mÃªme rÃ©sultat.",ans:"x â†’ 3x â†’ 3x+15 â†’ x+5 â†’ x+5âˆ’x = 5 âœ“"},
       {pts:5,text:"Pour x = 10, quel rÃ©sultat donne B ?",ans:"(10âˆ’1)Ã—(10âˆ’6)+5 = 9Ã—4+5 = 41"},
       {pts:5,text:"Trouver les deux valeurs pour lesquelles A = B.",ans:"xÂ²âˆ’7x+6=0 â†’ x=1 ou x=6"}
     ]}
  ],
  volumes:[
    {title:"Volumes â€” Aquariums",notion:"Volumes",pts:18,
     intro:"Il faut â‰¥ 15 L par poisson. Aquariums remplis aux 4/5 de leur hauteur.",
     questions:[
       {pts:7,text:"Aquarium cylindrique : âˆ… 30 cm, h = 25 cm. Volume d'eau ? Suffisant ?",ans:"V eau = Ï€Ã—15Â²Ã—25Ã—(4/5) â‰ˆ 14137 cmÂ³ â‰ˆ 14,1 L < 15 L â€” insuffisant."},
       {pts:7,text:"Aquarium pavÃ© droit 28Ã—28Ã—30 cm. Volume d'eau ? Convient-il ?",ans:"V eau = 23520 Ã— 0,8 = 18816 cmÂ³ = 18,8 L > 15 L â€” convient âœ“"},
       {pts:4,text:"Poisson : 15 â‚¬, aquarium : 40 â‚¬. Remise de 15%. Prix final ?",ans:"Total = 55 â‚¬. Remise = 8,25 â‚¬. Prix = 46,75 â‚¬"}
     ]}
  ]
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETUP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function selectTimer(el){
  document.querySelectorAll('.timer-chip').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected'); selMin = parseInt(el.dataset.min);
  const h=Math.floor(selMin/60),m=selMin%60;
  document.getElementById('setupTimerVal').textContent = h>0?(m>0?h+'h'+m:h+'h'):m+' min';
}

function toggleChap(el){
  if(el.classList.contains('locked')) return;
  const id=el.dataset.id;
  if(id==='all'){
    document.querySelectorAll('.chapter-chip:not(.locked)').forEach(c=>{c.classList.remove('selected');c.querySelector('.ch-check').textContent='';});
    el.classList.add('selected'); el.querySelector('.ch-check').textContent='âœ“';
    selChaps=['all'];
  } else {
    const allChip=document.querySelector('.chapter-chip[data-id="all"]');
    allChip.classList.remove('selected'); allChip.querySelector('.ch-check').textContent='';
    el.classList.toggle('selected');
    el.querySelector('.ch-check').textContent = el.classList.contains('selected')?'âœ“':'';
    selChaps=[...document.querySelectorAll('.chapter-chip.selected:not(.locked)')].map(c=>c.dataset.id).filter(i=>i!=='all');
    if(!selChaps.length){ allChip.classList.add('selected'); allChip.querySelector('.ch-check').textContent='âœ“'; selChaps=['all']; }
  }
}

function promptUpgrade(el){
  if(isPremium) return;
  // flash the chip
  el.style.borderColor = 'var(--premium)';
  el.style.background = 'var(--premium2)';
  setTimeout(()=>{el.style.borderColor='';el.style.background='';},600);
  navTo('screen-pricing','navPricing');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXAM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function pickExercises(){
  let pool=[];
  const availBankKeys = isPremium ? Object.keys(BANK) : ['probabilites','proportionnalite','statistiques','geometrie','algebre'];
  if(selChaps.includes('all')) availBankKeys.forEach(k=>pool.push(...BANK[k]));
  else selChaps.forEach(ch=>{if(BANK[ch]&&(isPremium||availBankKeys.includes(ch)))pool.push(...BANK[ch]);});
  for(let i=pool.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[pool[i],pool[j]]=[pool[j],pool[i]];}
  return pool.slice(0,5);
}

async function startExam(){
  if(!isPremium && freeUsed >= 3){ navTo('screen-pricing','navPricing'); return; }
  const picked=pickExercises();
  if(!picked.length) return;

  // increment free usage
  if(!isPremium){
    freeUsed++;
    try{ await window.storage.set('freeUsed', String(freeUsed)); }catch(e){}
    updatePremiumUI();
  }

  exerciseData=picked; scores={}; validated={}; feedbacks={};
  navTo('screen-exam', null);
  document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active'));
  document.getElementById('exContainer').innerHTML='';
  document.getElementById('examFooter').style.display='none';
  document.getElementById('loadingBox').style.display='block';
  document.getElementById('examSubtitle').textContent='Chargementâ€¦';
  startTimer(selMin*60);
  setTimeout(renderExercises, 300);
}

function renderExercises(){
  document.getElementById('loadingBox').style.display='none';
  const container=document.getElementById('exContainer');
  const pillsNav=document.getElementById('pillsNav');
  pillsNav.innerHTML=''; container.innerHTML='';
  document.getElementById('examSubtitle').textContent=[...new Set(exerciseData.map(e=>e.notion))].join(' Â· ');

  exerciseData.forEach((ex,ei)=>{
    const exId=`ex${ei+1}`;
    const totalPts=ex.questions.reduce((s,q)=>s+q.pts,0);
    const pill=document.createElement('button');
    pill.className='pill'; pill.id=`pill-${exId}`;
    pill.textContent=`Ex. ${ei+1} â€” ${ex.notion}`;
    pill.onclick=()=>document.getElementById(exId)?.scrollIntoView({behavior:'smooth',block:'start'});
    pillsNav.appendChild(pill);

    let tableHTML='';
    if(ex.tableData){
      tableHTML=`<table><tr>${ex.tableData.headers.map(h=>`<th>${h}</th>`).join('')}</tr>${ex.tableData.rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')}</table>`;
    }
    let qHTML='';
    ex.questions.forEach((q,qi)=>{
      const qId=`${exId}q${qi+1}`;
      const ansEsc=escQ(q.ans);
      qHTML+=`
      <div class="question">
        <div class="q-head">
          <span class="q-num">Question ${ei+1}.${qi+1}</span>
          <span class="q-pts-badge">${q.pts} pts</span>
        </div>
        <div class="q-text">${q.text}</div>
        <div class="answer-zone">
          <div class="answer-lbl">Ma rÃ©ponse</div>
          <textarea class="answer-textarea" id="a-${qId}" placeholder="RÃ©digez votre rÃ©ponse iciâ€¦" oninput="onType(this)"></textarea>
          <div class="validate-bar">
            <button class="btn-green" id="vbtn-${qId}" onclick="doValidate('${qId}','${exId}',${q.pts},'${ansEsc}')" disabled>âœ“ Valider</button>
            <button class="btn-edit" id="ebtn-${qId}" onclick="doEdit('${qId}','${exId}')">âœ Modifier</button>
            <span class="validated-tag" id="vtag-${qId}">âœ… ValidÃ©e</span>
            <span class="validate-hint" id="vhint-${qId}">RÃ©digez puis validez</span>
          </div>
          <div class="ai-result" id="ar-${qId}"></div>
        </div>
      </div>`;
    });
    const corrBlocks=ex.questions.map((q,qi)=>`<div class="corr-block"><div class="corr-title">Q${ei+1}.${qi+1}</div><p>${q.ans}</p></div>`).join('');
    container.insertAdjacentHTML('beforeend',`
    <div class="exercise" id="${exId}">
      <div class="exercise-head">
        <div>
          <div class="ex-eyebrow">Exercice ${ei+1}</div>
          <div class="ex-title">${ex.title}</div>
          <div class="ex-notion">${ex.notion}</div>
        </div>
        <div class="ex-pts-badge"><div class="num">${totalPts}</div><div class="lbl">points</div></div>
      </div>
      <div class="exercise-body">
        <p>${ex.intro}</p>${tableHTML}${qHTML}
        <div class="correction-toggle">
          <button class="btn-see" id="cBtn-${exId}" onclick="toggleCorr('corr-${exId}','cBtn-${exId}')" disabled>â–¶ Voir la correction</button>
          <span class="toggle-hint" id="chint-${exId}">Validez toutes vos rÃ©ponses pour accÃ©der Ã  la correction</span>
        </div>
        <div class="correction" id="corr-${exId}">
          <div class="corr-head"><div class="corr-badge">âœ“</div><span>Correction dÃ©taillÃ©e</span></div>
          ${corrBlocks}
        </div>
      </div>
    </div>`);
  });
  document.getElementById('examFooter').style.display='flex';
  updateLive();
}

function escQ(s){return(s||'').replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'&quot;');}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startTimer(secs){ clearInterval(timerIv); secsLeft=secs; renderTimer(); timerIv=setInterval(()=>{secsLeft--;renderTimer();if(secsLeft<=0){clearInterval(timerIv);endExam();}},1000); }
function renderTimer(){ const h=Math.floor(secsLeft/3600),m=Math.floor((secsLeft%3600)/60),s=secsLeft%60; const el=document.getElementById('timerFace'); el.textContent=`${pad(h)}:${pad(m)}:${pad(s)}`; el.className='timer-face'+(secsLeft<300?' danger':secsLeft<600?' warn':''); }
function pad(n){return String(n).padStart(2,'0');}
function endEarly(){if(confirm('Terminer le brevet maintenant ?'))endExam();}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANSWERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function onType(el){
  const has=el.value.trim().length>0; el.classList.toggle('has-content',has);
  const qId=el.id.replace('a-','');
  const btn=document.getElementById('vbtn-'+qId); if(btn)btn.disabled=!has;
  const hint=document.getElementById('vhint-'+qId); if(hint)hint.textContent=has?'Cliquez pour valider':'RÃ©digez puis validez';
}

async function doValidate(qId,exId,maxPts,officialAnsEsc){
  const ta=document.getElementById('a-'+qId);
  const answer=ta.value.trim(); if(!answer)return;
  validated[qId]=true; ta.classList.add('locked'); ta.readOnly=true;
  document.getElementById('vbtn-'+qId).style.display='none';
  document.getElementById('ebtn-'+qId).style.display='inline-flex';
  document.getElementById('vtag-'+qId).classList.add('show');
  const hint=document.getElementById('vhint-'+qId); if(hint)hint.textContent='';
  const ar=document.getElementById('ar-'+qId);
  ar.classList.add('visible');
  ar.innerHTML=`<div class="ai-result-header loading-bg"><span class="ai-result-label"><span class="mini-spinner"></span>&nbsp; Correction en coursâ€¦</span><span class="ai-score loading-col">â€¦</span></div>`;
  const officialAns=officialAnsEsc.replace(/&quot;/g,'"');
  const prompt=`Tu es un correcteur du brevet des collÃ¨ges en mathÃ©matiques. La question vaut ${maxPts} points.\nRÃ©ponse officielle : "${officialAns}"\nRÃ©ponse de l'Ã©lÃ¨ve : "${answer}"\nÃ‰value et rÃ©ponds UNIQUEMENT en JSON valide sans aucun texte autour :\n{"pts": <entier 0 Ã  ${maxPts}>, "feedback": "<1-2 phrases courtes en franÃ§ais>"}`;
  let pts=0,feedback='';
  try{
    const resp=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:200,messages:[{role:'user',content:prompt}]})});
    const data=await resp.json();
    const raw=data.content?.[0]?.text||'{}';
    const parsed=JSON.parse(raw.replace(/```json|```/g,'').trim());
    pts=Math.max(0,Math.min(maxPts,Math.round(parsed.pts))); feedback=parsed.feedback||'';
  }catch(e){feedback='Correction indisponible.';}
  scores[qId]=pts; feedbacks[qId]=feedback;
  updateLive(); updatePill(exId);
  const ratio=pts/maxPts;
  let cls,icon,label;
  if(ratio>=.85){cls='correct';icon='âœ“';label='Correct';}
  else if(ratio>=.4){cls='partial';icon='~';label='Partiellement correct';}
  else{cls='wrong';icon='âœ—';label='Incorrect';}
  ar.innerHTML=`<div class="ai-result-header ${cls}-bg"><span class="ai-result-label" style="color:${cls==='correct'?'var(--green)':cls==='partial'?'var(--gold)':'var(--red)'}">${icon} ${label}</span><span class="ai-score ${cls}-col">${pts}<span style="font-size:13px;opacity:.5;font-weight:400"> / ${maxPts} pts</span></span></div><div class="ai-feedback">${feedback}</div>`;
}

function doEdit(qId,exId){
  validated[qId]=false; delete scores[qId]; delete feedbacks[qId];
  const ta=document.getElementById('a-'+qId); ta.classList.remove('locked'); ta.readOnly=false; ta.focus();
  document.getElementById('vbtn-'+qId).style.display='inline-flex';
  document.getElementById('vbtn-'+qId).disabled=false;
  document.getElementById('ebtn-'+qId).style.display='none';
  document.getElementById('vtag-'+qId).classList.remove('show');
  const hint=document.getElementById('vhint-'+qId); if(hint)hint.textContent='Modifiez puis revalidez';
  const ar=document.getElementById('ar-'+qId); ar.classList.remove('visible'); ar.innerHTML='';
  updateLive(); updatePill(exId);
}

function toggleCorr(corrId,btnId){
  const p=document.getElementById(corrId),b=document.getElementById(btnId);
  const open=p.classList.contains('open');
  if(open){p.classList.remove('open');b.textContent='â–¶ Voir la correction';b.classList.remove('active');}
  else{p.classList.add('open');b.textContent='â–¼ Masquer';b.classList.add('active');setTimeout(()=>p.scrollIntoView({behavior:'smooth',block:'nearest'}),80);}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCORING & PILLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function totalScore(){return Object.values(scores).reduce((s,v)=>s+v,0);}
function updateLive(){
  const t=totalScore();
  const el=document.getElementById('liveScore');if(el)el.textContent=t;
  const fe=document.getElementById('footerScore');if(fe)fe.textContent=t;
}
function updatePill(exId){
  const idx=parseInt(exId.replace('ex',''))-1;
  const ex=exerciseData[idx];if(!ex)return;
  const qIds=ex.questions.map((_,i)=>`${exId}q${i+1}`);
  const pill=document.getElementById(`pill-${exId}`);if(!pill)return;
  const anyVal=qIds.some(q=>validated[q]);
  const allGraded=qIds.every(q=>scores[q]!==undefined);
  pill.classList.toggle('answered',anyVal&&!allGraded);
  pill.classList.toggle('corrected',allGraded);
  const cBtn=document.getElementById(`cBtn-${exId}`);
  const chint=document.getElementById(`chint-${exId}`);
  if(cBtn){
    const rem=qIds.filter(q=>!validated[q]).length;
    if(allGraded){ cBtn.disabled=false; if(chint)chint.textContent='Correction disponible'; }
    else if(anyVal){ if(chint)chint.textContent=`Encore ${rem} rÃ©ponse${rem>1?'s':''} Ã  valider`; }
  }
}
function getMention(s){
  if(s>=90)return'ğŸ† FÃ©licitations â€” Excellent';if(s>=80)return'ğŸŒŸ TrÃ¨s Bien';
  if(s>=70)return'ğŸ‘ Bien';if(s>=60)return'âœ… Assez Bien';
  if(s>=50)return'ğŸ“š Admis';return'ğŸ’ª Ã€ retravailler';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   END EXAM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function endExam(){
  clearInterval(timerIv);
  const total=totalScore();
  const maxTotal=exerciseData.reduce((s,ex)=>s+ex.questions.reduce((s2,q)=>s2+q.pts,0),0);
  const scaled=Math.round(total/maxTotal*100);
  saveSession(scaled,total,maxTotal);
  navTo('screen-results',null);
  document.querySelector('.nav-link.active')?.classList.remove('active');

  document.getElementById('resScore').innerHTML=`${scaled} <span>/ 100</span>`;
  document.getElementById('resMention').textContent=getMention(scaled);
  const barColor=scaled>=70?'#1d6b3a':scaled>=50?'#b8870a':'#c0392b';
  setTimeout(()=>{document.getElementById('resBar').style.width=scaled+'%';document.getElementById('resBar').style.background=barColor;},100);

  let correct=0,partial=0,wrong=0;
  exerciseData.forEach((ex,i)=>{ex.questions.forEach((q,j)=>{const qId=`ex${i+1}q${j+1}`;const r=(scores[qId]||0)/q.pts;if(r>=.85)correct++;else if(r>=.4)partial++;else wrong++;});});
  document.getElementById('resCorrect').textContent=correct;
  document.getElementById('resPartial').textContent=partial;
  document.getElementById('resWrong').textContent=wrong;

  const ns={};
  exerciseData.forEach((ex,i)=>{const n=ex.notion;if(!ns[n])ns[n]={e:0,m:0};ex.questions.forEach((q,j)=>{const qId=`ex${i+1}q${j+1}`;ns[n].e+=scores[qId]||0;ns[n].m+=q.pts;});});
  let nHTML='';
  Object.entries(ns).forEach(([n,v])=>{const pct=Math.round(v.e/v.m*100);const col=pct>=70?'var(--green)':pct>=40?'var(--gold)':'var(--red)';nHTML+=`<div class="breakdown-row"><div><div class="breakdown-notion">${n}</div><div class="breakdown-pct"><div class="breakdown-pct-fill" style="width:${pct}%;background:${col}"></div></div></div><div class="breakdown-pts" style="color:${col}">${v.e}/${v.m}</div></div>`;});
  document.getElementById('resByNotion').innerHTML=nHTML||'<p style="color:var(--ink4);font-style:italic">Aucune question validÃ©e.</p>';

  let errHTML='',errCount=0;
  exerciseData.forEach((ex,i)=>{ex.questions.forEach((q,j)=>{const qId=`ex${i+1}q${j+1}`;const sc=scores[qId]||0;if(sc<q.pts*.85&&feedbacks[qId]){errCount++;const col=sc===0?'var(--red)':'var(--gold)';errHTML+=`<div class="error-card"><div class="error-q">${q.text.substring(0,90)}â€¦</div><div class="error-score" style="color:${col}">${sc}/${q.pts} pts</div><div class="error-fb">${feedbacks[qId]}</div></div>`;}});});
  document.getElementById('resErrors').innerHTML=errCount?errHTML:'<p style="color:var(--green);font-weight:600">ğŸ‰ Excellente performance !</p>';

  setTimeout(()=>document.querySelectorAll('.breakdown-pct-fill').forEach(el=>{const w=el.style.width;el.style.width='0';setTimeout(()=>el.style.width=w,50);}),100);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STORAGE & SESSION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function saveSession(scaled,raw,max){
  const s={date:new Date().toLocaleDateString('fr-FR'),ts:Date.now(),score:scaled,raw,max,notions:[...new Set(exerciseData.map(e=>e.notion))],duration:selMin,errors:[]};
  exerciseData.forEach((ex,i)=>{ex.questions.forEach((q,j)=>{const qId=`ex${i+1}q${j+1}`;const sc=scores[qId]||0;if(sc<q.pts*.85)s.errors.push({notion:ex.notion,pts:sc,maxPts:q.pts,fb:feedbacks[qId]||'',qText:q.text.substring(0,80)});});});
  try{
    let sessions=[];
    try{const d=await window.storage.get('sessions');if(d)sessions=JSON.parse(d.value);}catch(e){}
    sessions.push(s);
    if(sessions.length>100)sessions.splice(0,sessions.length-100);
    await window.storage.set('sessions',JSON.stringify(sessions));
  }catch(e){}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function showDash(){
  let sessions=[];
  try{const d=await window.storage.get('sessions');if(d)sessions=JSON.parse(d.value);}catch(e){}

  if(!sessions.length){
    document.getElementById('dashStats').innerHTML='';
    document.getElementById('scoreChart').style.display='none';
    document.getElementById('dashGrid').innerHTML=`<div class="empty-dash" style="grid-column:1/-1"><span class="e-icon">ğŸ“Š</span><p>Aucun brevet blanc effectuÃ© pour l'instant.<br>Lancez votre premier brevet pour voir vos statistiques !</p><button class="btn-primary" style="margin:20px auto 0;font-size:14px;padding:11px 24px" onclick="navTo('screen-setup','navHome')">Commencer â†’</button></div>`;
    return;
  }

  const avg=Math.round(sessions.reduce((s,x)=>s+x.score,0)/sessions.length);
  const best=Math.max(...sessions.map(x=>x.score));
  const last=sessions[sessions.length-1].score;
  const totalErrs=sessions.reduce((s,x)=>s+x.errors.length,0);
  const trend=sessions.length>1?last-sessions[sessions.length-2].score:0;
  const trendStr=trend>0?`â†‘ +${trend}`:trend<0?`â†“ ${trend}`:'â†’ stable';
  const trendCol=trend>0?'var(--green)':trend<0?'var(--red)':'var(--ink4)';

  document.getElementById('dashStats').innerHTML=`
    <div class="stat-card"><div class="s-val navy">${sessions.length}</div><div class="s-lbl">Brevets blancs</div></div>
    <div class="stat-card"><div class="s-val green">${avg}<span style="font-size:18px">/100</span></div><div class="s-lbl">Moyenne gÃ©nÃ©rale</div></div>
    <div class="stat-card"><div class="s-val gold">${best}<span style="font-size:18px">/100</span></div><div class="s-lbl">Meilleur score</div></div>
    <div class="stat-card"><div class="s-val" style="font-size:22px;color:${trendCol}">${trendStr}</div><div class="s-lbl">Tendance</div></div>
    <div class="stat-card"><div class="s-val red">${totalErrs}</div><div class="s-lbl">Erreurs totales</div></div>`;

  // Chart
  if(sessions.length >= 2){
    document.getElementById('scoreChart').style.display='block';
    const recent=sessions.slice(-12);
    const chartWrap=document.getElementById('chartWrap');
    chartWrap.innerHTML=recent.map(s=>{
      const h=Math.round(s.score*100/100);
      const col=s.score>=70?'var(--green)':s.score>=50?'var(--gold)':'var(--red)';
      return `<div class="chart-bar-col">
        <div class="chart-val">${s.score}</div>
        <div class="chart-bar" style="height:${h}px;background:${col};opacity:.75" title="${s.date}: ${s.score}/100"></div>
        <div class="chart-label">${s.date.split('/').slice(0,2).join('/')}</div>
      </div>`;
    }).join('');
  }

  // History + weaknesses
  let hHTML=`<table class="hist-table"><thead><tr><th>Date</th><th>Notions</th><th>Score</th><th>DurÃ©e</th></tr></thead><tbody>`;
  [...sessions].reverse().slice(0,20).forEach(s=>{
    const chip=s.score>=70?'a':s.score>=50?'b':'c';
    hHTML+=`<tr><td>${s.date}</td><td style="font-size:11px;color:var(--ink4);max-width:140px">${(s.notions||[]).join(', ').substring(0,36)}</td><td><span class="score-chip ${chip}">${s.score}/100</span></td><td style="font-size:12px;color:var(--ink4)">${s.duration}m</td></tr>`;
  });
  hHTML+='</tbody></table>';

  const nErrs={};
  sessions.forEach(s=>{s.errors.forEach(e=>{if(!nErrs[e.notion])nErrs[e.notion]=0;nErrs[e.notion]++;});});
  const sorted=Object.entries(nErrs).sort((a,b)=>b[1]-a[1]);
  let wHTML='';
  if(!sorted.length){wHTML='<p style="color:var(--green);font-weight:600">Aucun point faible identifiÃ© ğŸ‰</p>';}
  else{const maxE=Math.max(...sorted.map(([,v])=>v),1);sorted.slice(0,8).forEach(([n,v])=>{const pct=Math.round(v/maxE*100);const col=pct>60?'var(--red)':pct>30?'var(--gold)':'var(--green)';wHTML+=`<div class="notion-bar-row"><div class="nb-label">${n}</div><div class="nb-track"><div class="nb-fill" style="width:${pct}%;background:${col}"></div></div><div class="nb-count">${v}</div></div>`;});}

  document.getElementById('dashGrid').innerHTML=`
    <div>
      <div class="section-rule">Historique</div>
      <div>${hHTML}</div>
    </div>
    <div>
      <div class="section-rule">Points faibles par notion</div>
      <div>${wHTML}</div>
      ${sessions.length>=3?`<div style="margin-top:24px"><div class="section-rule">DerniÃ¨res erreurs</div>${sessions[sessions.length-1].errors.slice(0,3).map(e=>`<div class="error-card"><div class="error-q">${e.qText||''}â€¦</div><div class="error-score" style="color:var(--red)">${e.pts}/${e.maxPts} pts</div><div class="error-fb">${e.fb}</div></div>`).join('')||'<p style="font-style:italic;color:var(--ink4)">Aucune erreur !</p>'}</div>`:''}
    </div>`;

  setTimeout(()=>document.querySelectorAll('.nb-fill').forEach(el=>{const w=el.style.width;el.style.width='0';setTimeout(()=>el.style.width=w,50);}),100);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRICING & CHECKOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleBilling(){
  isAnnual=!isAnnual;
  document.getElementById('billingToggle').classList.toggle('annual',isAnnual);
  const monthlyPrice=isAnnual?5.40:9;
  document.getElementById('planAmount').textContent=isAnnual?'5,40':'9';
  document.getElementById('planAnnualNote').textContent=isAnnual?'soit 64,80 â‚¬/an â€” Ã©conomisez 43,20 â‚¬':'ou 64,80 â‚¬/an (âˆ’40%)';
  // Update checkout summary
  const desc=isAnnual?'annuel':'mensuel';
  const total=isAnnual?'64,80 â‚¬':'9,00 â‚¬';
  document.getElementById('summaryPlan').textContent=desc;
  document.getElementById('summaryPrice').textContent=isAnnual?'5,40 â‚¬/mois':'9,00 â‚¬';
  document.getElementById('summaryTotal').textContent=total;
  document.getElementById('summaryDiscountRow').style.display=isAnnual?'flex':'none';
  document.getElementById('checkoutAmount').textContent=isAnnual?'64,80 â‚¬/an (5,40 â‚¬/mois)':'9 â‚¬/mois';
  document.getElementById('payBtnText').textContent=isAnnual?'Payer 64,80 â‚¬/an':'Payer 9 â‚¬/mois';
}

function goCheckout(){
  const plan=isAnnual?'annuel':'mensuel';
  document.getElementById('summaryPlan').textContent=plan;
  document.getElementById('summaryPrice').textContent=isAnnual?'5,40 â‚¬/mois':'9,00 â‚¬';
  document.getElementById('summaryTotal').textContent=isAnnual?'64,80 â‚¬':'9,00 â‚¬';
  document.getElementById('summaryDiscountRow').style.display=isAnnual?'flex':'none';
  document.getElementById('checkoutAmount').textContent=isAnnual?'64,80 â‚¬/an (5,40 â‚¬/mois)':'9 â‚¬/mois';
  document.getElementById('payBtnText').textContent=isAnnual?'Payer 64,80 â‚¬/an':'Payer 9 â‚¬/mois';
  navTo('screen-checkout',null);
  document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active'));
}

function formatCard(el){
  let v=el.value.replace(/\D/g,'').substring(0,16);
  el.value=v.replace(/(.{4})/g,'$1 ').trim();
}

function simulatePay(){
  const btn=document.querySelector('.btn-pay');
  btn.textContent='â³ Traitementâ€¦'; btn.disabled=true;
  setTimeout(()=>{ navTo('screen-success',null); document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active')); btn.innerHTML='<span>ğŸ”’</span><span id="payBtnText">Payer</span>'; btn.disabled=false; }, 1800);
}

async function activatePremium(){
  isPremium=true;
  try{ await window.storage.set('isPremium','true'); }catch(e){}
  updatePremiumUI();
  navTo('screen-setup','navHome');
}

function toggleFaq(el){
  el.classList.toggle('open');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.addEventListener('DOMContentLoaded', ()=>{
  loadPremiumState();
});
</script>
</body>
</html>
