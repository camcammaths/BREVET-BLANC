<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Brevet Blanc Maths – Exercices Corrigés en Ligne | 3ème</title>
<meta name="description" content="Préparez votre brevet blanc de maths avec des exercices interactifs corrigés par IA. Simulateur d'examen chronométré, corrigés détaillés, suivi de progression. Gratuit pour les élèves de 3ème.">
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,700;1,800&family=Barlow:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Source+Code+Pro:wght@400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{
  background:#fff;
  color:#0a0a0a;
  font-family:'Barlow',system-ui,sans-serif;
  font-size:15px;
  line-height:1.65;
  min-height:100vh;
  -webkit-font-smoothing:antialiased;
}
.screen{display:none;min-height:100vh;animation:pgIn .18s ease}
.screen.active{display:block}
@keyframes pgIn{from{opacity:0}to{opacity:1}}

/* ── Design tokens — Swiss palette ── */
:root{
  --k:    #002FA7;   /* Klein Blue IKB */
  --k1:   #0038CC;
  --k-bg: rgba(0,47,167,.06);
  --k-bd: rgba(0,47,167,.18);

  --ink:  #0a0a0a;
  --ink2: #1a1a1a;
  --ink3: #4a4a4a;
  --ink4: #888;
  --ink5: #bbb;

  --rule: #d8d4cf;
  --rule2:#e8e4df;
  --bg:   #fff;
  --bg2:  #f5f3ef;
  --bg3:  #eeebe6;

  --green: #0a6b38;
  --green2:rgba(10,107,56,.08);
  --amber: #8a5c00;
  --amber2:rgba(138,92,0,.10);
  --red:   #be2e27;
  --red2:  rgba(190,46,39,.08);

  /* Legacy aliases */
  --cream:var(--bg2); --paper2:var(--bg3);
  --navy:var(--k); --navy2:var(--k-bg); --navy3:var(--k-bd);
  --border:var(--rule); --border2:var(--rule2);
  --gold:var(--amber); --gold2:var(--amber2);
  --shadow:rgba(0,0,0,.07); --shadow2:rgba(0,0,0,.035);
  --blue:var(--k); --blue2:var(--k-bg); --blue3:var(--k-bd);
  --klein:var(--k);
}

/* ═══════════════════════════════════════
   GLOBAL NAV — Swiss grid bar
   ═══════════════════════════════════════ */
.gnav{
  position:sticky;top:0;z-index:300;
  background:#fff;
  border-bottom:2px solid var(--ink);
  display:flex;align-items:stretch;
  height:48px;padding:0;
}
.gnav-logo{
  font-family:'Barlow Condensed',sans-serif;
  font-size:15px;font-weight:700;
  letter-spacing:.5px;text-transform:uppercase;
  color:var(--ink);
  cursor:pointer;
  padding:0 24px;
  display:flex;align-items:center;
  border-right:2px solid var(--ink);
  white-space:nowrap;
  transition:background .1s;
}
.gnav-logo em{
  font-style:normal;
  color:var(--k);
}
.gnav-logo:hover{background:var(--k);color:#fff}
.gnav-logo:hover em{color:#fff}
.gnav-links{display:flex;align-items:stretch;flex:1}
.gnav-link{
  display:flex;align-items:center;
  padding:0 20px;
  font-family:'Barlow Condensed',sans-serif;
  font-size:13px;font-weight:600;
  letter-spacing:.8px;text-transform:uppercase;
  color:var(--ink4);
  background:none;border:none;
  border-right:1px solid var(--rule);
  cursor:pointer;transition:all .1s;white-space:nowrap;
}
.gnav-link:hover{color:var(--ink);background:var(--bg2)}
.gnav-link.active{color:var(--k);background:var(--k-bg);border-bottom:2px solid var(--k);margin-bottom:-2px}

/* ═══════════════════════════════════════
   BUTTON SYSTEM — Swiss: functional, pill
   ═══════════════════════════════════════ */
.btn{
  display:inline-flex;align-items:center;gap:8px;
  padding:10px 22px;
  font-family:'Barlow Condensed',sans-serif;
  font-size:13px;font-weight:700;
  letter-spacing:1.2px;text-transform:uppercase;
  border:none;cursor:pointer;
  border-radius:100px;
  transition:background .1s,color .1s;
}
.btn-dark{background:var(--ink);color:#fff}
.btn-dark:hover{background:var(--ink2)}
.btn-primary{background:var(--k);color:#fff}
.btn-primary:hover{background:var(--k1)}
.btn-light{background:var(--bg2);color:var(--ink);border:1.5px solid var(--rule)}
.btn-light:hover{background:var(--bg3);border-color:var(--ink)}
.btn-ghost{
  background:none;color:var(--ink3);
  border:1.5px solid var(--rule);
  border-radius:100px;padding:10px 22px;
}
.btn-ghost:hover{border-color:var(--ink);color:var(--ink)}
.btn-sm{padding:6px 14px;font-size:12px}
.btn-green{background:var(--green);color:#fff}
.btn-green:hover{background:#094f2a}
.btn-red-ghost{
  background:none;color:#c05050;
  border:1.5px solid rgba(190,46,39,.25);
  padding:7px 16px;font-size:12px;border-radius:100px;
}
.btn-red-ghost:hover{background:var(--red);color:#fff}

/* Legacy btn aliases */
.btn-navy{display:inline-flex;align-items:center;gap:8px;padding:10px 22px;font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;letter-spacing:1px;text-transform:uppercase;background:var(--k);color:#fff;border:none;cursor:pointer;border-radius:100px;transition:background .1s}
.btn-navy:hover{background:var(--k1)}
.btn-outline{display:inline-flex;align-items:center;gap:8px;padding:9px 20px;font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:600;letter-spacing:.8px;text-transform:uppercase;background:none;color:var(--ink3);border:1.5px solid var(--rule);cursor:pointer;border-radius:100px;transition:all .1s}
.btn-outline:hover{border-color:var(--ink);color:var(--ink)}
.btn-green-sm{display:inline-flex;align-items:center;gap:6px;padding:7px 16px;font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;background:var(--green);color:#fff;border:none;cursor:pointer;border-radius:100px;transition:background .1s}
.btn-green-sm:hover{background:#094f2a}
.btn-green-sm:disabled{background:var(--rule);color:var(--ink4);cursor:not-allowed}

/* Rule divider */
.rule{display:flex;align-items:center;gap:10px;font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--ink5);margin-bottom:16px}
.rule::after{content:'';flex:1;height:1px;background:var(--rule)}

/* ═══════════════════════════════════════
   SCREEN 0 — LANDING
   Full viewport, Swiss grid layout
   ═══════════════════════════════════════ */
#screen-landing{
  background:var(--bg);
  height:calc(100vh - 48px);
  overflow:hidden;
  display:none;
}
#screen-landing.active{display:flex;flex-direction:column}
.lp{flex:1;display:flex;flex-direction:column;min-height:0}

/* Hero — strict 2-col grid */
.lp-hero{
  flex:1;display:grid;
  grid-template-columns:55% 45%;
  min-height:0;
}

/* LEFT panel */
.lp-left{
  display:flex;flex-direction:column;justify-content:center;
  padding:64px 56px;
  border-right:2px solid var(--ink);
  position:relative;
}

/* Swiss kicker — uppercase label, grid-line style */
.lp-kicker{
  display:flex;align-items:center;gap:0;
  font-family:'Barlow Condensed',sans-serif;
  font-size:10px;font-weight:700;letter-spacing:3px;
  text-transform:uppercase;color:var(--ink4);
  margin-bottom:28px;
}
.lp-kicker::before{
  content:'';display:inline-block;
  width:2px;height:14px;background:var(--k);
  margin-right:12px;flex-shrink:0;
}

/* Swiss headline — condensed, tight, massive */
.lp-h1{
  font-family:'Barlow Condensed',sans-serif;
  font-size:clamp(72px,9vw,120px);
  font-weight:800;
  line-height:.88;
  letter-spacing:-2px;
  text-transform:uppercase;
  color:var(--ink);
  margin:0 0 28px;
}
.lp-h1 em{
  font-style:normal;
  color:var(--k);
}

/* Tagline — Barlow regular, generous leading */
.lp-tagline{
  font-family:'Barlow',sans-serif;
  font-size:14px;font-weight:400;
  color:var(--ink3);line-height:1.72;
  max-width:360px;margin-bottom:40px;
}

.lp-cta-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

/* Klein accent — vertical bar left */
.lp-left::before{
  content:'';position:absolute;
  left:0;top:64px;bottom:64px;
  width:3px;background:var(--k);
}

/* RIGHT panel — 2 stat blocks */
.lp-right{
  display:grid;
  grid-template-rows:1fr 1fr;
}
.lp-tile{
  display:flex;flex-direction:column;justify-content:flex-end;
  padding:32px 40px 36px;
  border-bottom:2px solid var(--ink);
  position:relative;overflow:hidden;
}
.lp-tile:last-child{border-bottom:none}

/* Tile 1 — Klein filled */
.lp-tile:nth-child(1){background:var(--k)}
/* Tile 2 — white */
.lp-tile:nth-child(2){background:var(--bg)}

/* Giant number — Swiss tabular style */
.lp-tile-n{
  font-family:'Barlow Condensed',sans-serif;
  font-size:clamp(80px,10vw,130px);
  font-weight:800;
  line-height:.85;
  letter-spacing:-4px;
  text-transform:uppercase;
}
.lp-tile:nth-child(1) .lp-tile-n{color:#fff}
.lp-tile:nth-child(2) .lp-tile-n{color:var(--ink)}

.lp-tile-label{
  font-family:'Barlow Condensed',sans-serif;
  font-size:11px;font-weight:600;letter-spacing:2px;
  text-transform:uppercase;
  margin-top:12px;line-height:1.4;
}
.lp-tile:nth-child(1) .lp-tile-label{color:rgba(255,255,255,.55)}
.lp-tile:nth-child(2) .lp-tile-label{color:var(--ink4)}

/* Bottom strip — 4 columns, Swiss ticker */
.lp-strip{
  flex-shrink:0;
  display:grid;grid-template-columns:repeat(4,1fr);
  border-top:2px solid var(--ink);
  background:var(--bg);
}
.lp-strip-item{
  padding:12px 18px;
  border-right:1px solid var(--rule);
  display:flex;align-items:center;gap:10px;
}
.lp-strip-item:last-child{border-right:none}
.lp-strip-dot{
  width:5px;height:5px;border-radius:50%;
  background:var(--k);flex-shrink:0;
}
.lp-strip-text{
  font-family:'Barlow Condensed',sans-serif;
  font-size:11px;font-weight:600;letter-spacing:1.2px;
  text-transform:uppercase;color:var(--ink3);line-height:1.3;
}

/* ═══════════════════════════════════════
   SCREEN 1 — SETUP
   ═══════════════════════════════════════ */
#screen-setup{
  background:var(--bg);
  height:calc(100vh - 48px);
  min-height:0!important;
  overflow:hidden;
  display:none;
  flex-direction:column;
}
#screen-setup.active{display:flex!important}

.setup-header{
  border-bottom:2px solid var(--ink);
  padding:0 48px;height:48px;
  display:flex;align-items:center;justify-content:space-between;
}
.setup-header-title{
  font-family:'Barlow Condensed',sans-serif;
  font-size:13px;font-weight:700;letter-spacing:1.5px;
  text-transform:uppercase;color:var(--ink);
}
.setup-header-sub{
  font-family:'Barlow Condensed',sans-serif;
  font-size:11px;font-weight:500;letter-spacing:.8px;
  text-transform:uppercase;color:var(--ink4);
}

/* Setup hero — Klein BG, condensed type */
.setup-hero{background:var(--k);padding:0}
.setup-hero-inner{
  max-width:920px;margin:0 auto;
  display:grid;grid-template-columns:1fr auto;
  gap:32px;align-items:start;
}
.setup-eyebrow{
  font-family:'Barlow Condensed',sans-serif;
  font-size:10px;letter-spacing:4px;text-transform:uppercase;
  color:rgba(255,255,255,.45);font-weight:700;
  margin-bottom:12px;display:block;
}
.setup-h1{
  font-family:'Barlow Condensed',sans-serif;
  font-size:clamp(32px,4vw,48px);
  font-weight:800;letter-spacing:-1px;
  line-height:.92;text-transform:uppercase;
  color:#fff;margin:0;
}
.setup-h1 em{font-style:normal;color:rgba(255,255,255,.55)}
.setup-hero-meta{
  margin-top:12px;font-family:'Barlow Condensed',sans-serif;
  font-size:12px;font-weight:500;letter-spacing:.8px;
  text-transform:uppercase;color:rgba(255,255,255,.38);
  display:flex;gap:16px;flex-wrap:wrap;
}
.setup-hero-meta span::before{content:'—';margin-right:6px;color:rgba(255,255,255,.25)}
.setup-stats{
  display:flex;flex-direction:column;gap:0;
  border-left:2px solid rgba(255,255,255,.2);
  padding-left:28px;
}
.setup-stat{padding:10px 0;border-bottom:1px solid rgba(255,255,255,.12)}
.setup-stat:first-child{border-top:1px solid rgba(255,255,255,.12)}
.setup-stat-n{
  font-family:'Barlow Condensed',sans-serif;
  font-size:28px;font-weight:800;color:#fff;
  line-height:1;letter-spacing:-1px;
}
.setup-stat-l{
  font-family:'Barlow Condensed',sans-serif;
  font-size:10px;letter-spacing:2px;text-transform:uppercase;
  color:rgba(255,255,255,.35);margin-top:2px;font-weight:600;
}
.setup-body{width:100%;max-width:920px;margin:0 auto;padding:20px 48px 24px;box-sizing:border-box}
.setup-block{margin-bottom:20px}
.setup-block-title{
  font-family:'Barlow Condensed',sans-serif;
  font-size:11px;font-weight:700;letter-spacing:3px;
  text-transform:uppercase;color:var(--k);
  padding-bottom:8px;margin-bottom:12px;
  border-bottom:2px solid var(--ink);
}

/* Duration chips */
.timer-row{display:flex;gap:6px;flex-wrap:wrap}
.timer-chip{
  padding:8px 18px;
  font-family:'Barlow Condensed',sans-serif;
  font-size:13px;font-weight:700;letter-spacing:.8px;
  text-transform:uppercase;color:var(--ink3);
  background:var(--bg);border:1.5px solid var(--rule);
  cursor:pointer;transition:all .1s;border-radius:100px;
}
.timer-chip:hover{border-color:var(--ink);color:var(--ink)}
.timer-chip.sel{background:var(--ink);border-color:var(--ink);color:#fff}

/* Chapter grid */
.chap-grid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:1px;background:var(--rule);
  border:1.5px solid var(--ink);
}
.chap-chip{
  padding:10px 14px;background:var(--bg);
  cursor:pointer;transition:background .1s;
  display:flex;align-items:flex-start;gap:10px;
}
.chap-chip:hover{background:var(--bg2)}
.chap-chip.sel{background:var(--k-bg)}
.chk{
  width:14px;height:14px;border:2px solid var(--rule);
  flex-shrink:0;margin-top:3px;
  display:flex;align-items:center;justify-content:center;
  font-size:9px;font-weight:700;transition:all .1s;
  border-radius:2px;
}
.chap-chip.sel .chk{background:var(--k);border-color:var(--k);color:#fff}
.ch-name{
  font-family:'Barlow Condensed',sans-serif;
  font-size:14px;font-weight:700;letter-spacing:.3px;
  color:var(--ink);line-height:1.2;
}
.ch-sub{
  font-family:'Barlow',sans-serif;
  font-size:11px;color:var(--ink4);margin-top:2px;
}
.setup-cta{
  margin-top:16px;display:flex;align-items:center;gap:14px;
  flex-wrap:wrap;padding-top:16px;border-top:1px solid var(--rule);
}

/* ═══════════════════════════════════════
   SCREEN 2 — EXAM
   ═══════════════════════════════════════ */
#screen-exam{background:var(--bg)}
.exam-top{
  background:var(--ink);position:sticky;top:48px;z-index:200;
  border-bottom:none;
}
.exam-top-inner{
  max-width:960px;margin:0 auto;
  padding:10px 48px;
  display:flex;align-items:center;gap:16px;flex-wrap:wrap;
}
.exam-title-wrap h2{
  font-family:'Barlow Condensed',sans-serif;
  font-size:15px;font-weight:700;letter-spacing:.5px;
  text-transform:uppercase;color:#fff;
}
.exam-title-wrap .sub{
  font-family:'Barlow Condensed',sans-serif;
  font-size:10px;letter-spacing:2px;text-transform:uppercase;
  color:rgba(255,255,255,.3);margin-top:1px;font-weight:600;
}
.timer-block{margin-left:auto;display:flex;align-items:center;gap:20px}
.timer-face{
  font-family:'Source Code Pro',monospace;
  font-size:20px;font-weight:500;color:#fff;
  letter-spacing:3px;line-height:1;
}
.timer-face.warn{color:#f59e0b}
.timer-face.danger{color:#f87171;animation:blink .8s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.35}}
.live-sc-box{text-align:right}
.live-sc-num{
  font-family:'Barlow Condensed',sans-serif;
  font-size:22px;font-weight:800;color:#fff;line-height:1;letter-spacing:-1px;
}
.live-sc-lbl{
  font-family:'Barlow Condensed',sans-serif;
  font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,.3);font-weight:600;
}
.btn-end{
  padding:7px 16px;
  font-family:'Barlow Condensed',sans-serif;
  font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;
  background:none;border:1.5px solid rgba(255,255,255,.15);border-radius:100px;
  color:rgba(255,255,255,.25);cursor:not-allowed;transition:all .2s;
}
.btn-end:not([disabled]){
  border-color:rgba(255,255,255,.5);color:#fff;
  cursor:pointer;background:rgba(255,255,255,.08);
}
.btn-end:not([disabled]):hover{background:var(--red);border-color:var(--red);color:#fff}
.btn-end-ready{animation:pulseEnd 1.5s ease-in-out 3}
@keyframes pulseEnd{0%,100%{box-shadow:none}50%{box-shadow:0 0 0 4px rgba(190,46,39,.4)}}

.pills-bar{background:var(--bg2);border-bottom:1px solid var(--rule)}
.pills-bar-inner{
  max-width:960px;margin:0 auto;
  padding:8px 48px;
  display:flex;align-items:center;gap:6px;overflow-x:auto;
}
.pill{
  padding:4px 12px;
  font-family:'Barlow Condensed',sans-serif;
  font-size:11px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;
  background:transparent;border:1.5px solid var(--rule);
  color:var(--ink4);cursor:pointer;transition:all .1s;
  white-space:nowrap;border-radius:100px;
}
.pill:hover{border-color:var(--ink);color:var(--ink)}
.pill.answered{border-color:var(--k);color:var(--k);background:var(--k-bg)}
.pill.corrected{border-color:var(--green);color:#fff;background:var(--green)}

.exam-main{max-width:960px;margin:0 auto;padding:36px 48px 100px}
.loading-box{text-align:center;padding:80px 20px}
.spinner{
  width:28px;height:28px;border:2px solid var(--rule);border-top-color:var(--k);
  border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 16px;
}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-box p{
  font-family:'Barlow Condensed',sans-serif;
  font-size:12px;font-weight:600;letter-spacing:2px;text-transform:uppercase;
  color:var(--ink4);
}

/* Exercise card — Swiss: ruled, no decoration */
.exercise{
  background:var(--bg);
  border:1.5px solid var(--ink);
  border-radius:0; /* Swiss: no rounding */
  margin-bottom:24px;overflow:hidden;
  scroll-margin-top:120px;
}
.ex-head{
  padding:18px 24px;
  border-bottom:2px solid var(--ink);
  background:var(--bg2);
  display:flex;align-items:flex-start;
  justify-content:space-between;gap:16px;
}
.ex-eyebrow{
  font-family:'Barlow Condensed',sans-serif;
  font-size:10px;letter-spacing:3px;text-transform:uppercase;
  color:var(--k);font-weight:700;margin-bottom:5px;
}
.ex-title{
  font-family:'Barlow Condensed',sans-serif;
  font-size:20px;font-weight:800;letter-spacing:-.3px;
  text-transform:uppercase;color:var(--ink);line-height:1.1;
}
.ex-notion{
  font-family:'Barlow Condensed',sans-serif;
  font-size:11px;letter-spacing:1px;text-transform:uppercase;
  color:var(--ink4);font-weight:600;margin-top:4px;
}
.ex-pts{
  flex-shrink:0;padding:8px 16px;
  background:var(--k);text-align:center;
  border-radius:0;
}
.ex-pts .n{
  font-family:'Barlow Condensed',sans-serif;
  font-size:28px;font-weight:800;color:#fff;line-height:1;letter-spacing:-1px;
}
.ex-pts .l{
  font-family:'Barlow Condensed',sans-serif;
  font-size:9px;letter-spacing:2px;text-transform:uppercase;
  color:rgba(255,255,255,.55);margin-top:2px;font-weight:600;
}
.ex-body{padding:20px 24px 24px}
.ex-body>p{margin-bottom:12px;color:var(--ink2);font-size:15px;line-height:1.7}

/* Figure */
.ex-figure{
  margin:14px 0;padding:20px;
  background:var(--bg2);
  border:1px solid var(--rule);
  display:flex;justify-content:center;align-items:center;
}
.ex-figure svg{max-width:100%;height:auto;display:block}

/* Calc program */
.calc-program{margin:14px 0;border:1.5px solid var(--ink);overflow:hidden}
.calc-program-title{
  padding:7px 14px;background:var(--k);
  font-family:'Barlow Condensed',sans-serif;
  font-size:10px;letter-spacing:2.5px;text-transform:uppercase;
  color:rgba(255,255,255,.8);font-weight:700;
}
.calc-program-steps{
  display:flex;align-items:center;flex-wrap:wrap;
  padding:14px 18px;gap:0;background:var(--bg2);
}
.calc-step{
  display:flex;flex-direction:column;align-items:center;
  padding:8px 14px;background:#fff;
  border:1px solid var(--rule);border-radius:0;
  min-width:72px;text-align:center;
}
.calc-step-label{
  font-family:'Barlow Condensed',sans-serif;
  font-size:9px;letter-spacing:1.5px;text-transform:uppercase;
  color:var(--ink4);margin-bottom:3px;font-weight:600;
}
.calc-step-val{
  font-family:'Source Code Pro',monospace;
  font-size:13px;font-weight:500;color:var(--ink);
}
.calc-arrow{font-size:16px;color:var(--k);padding:0 4px;flex-shrink:0;font-weight:400}

/* Table */
table{width:100%;border-collapse:collapse;margin:14px 0;font-size:14px}
th{
  background:var(--k);color:#fff;
  padding:8px 12px;text-align:left;
  font-family:'Barlow Condensed',sans-serif;
  font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;
}
td{padding:8px 12px;border:1px solid var(--rule2);color:var(--ink2);font-size:14px}
tr:nth-child(even) td{background:var(--bg2)}

/* Question */
.question{
  margin:12px 0;border:1px solid var(--rule);border-left:3px solid var(--k);
  background:var(--bg);overflow:hidden;
}
.q-head{
  padding:8px 14px;border-bottom:1px solid var(--rule2);
  display:flex;align-items:center;gap:10px;background:var(--bg2);
}
.q-num{
  font-family:'Barlow Condensed',sans-serif;
  font-size:11px;font-weight:700;color:var(--k);
  letter-spacing:1px;text-transform:uppercase;
}
.q-pts-badge{
  display:inline-flex;align-items:center;
  padding:2px 10px;background:var(--green);
  color:#fff;
  font-family:'Barlow Condensed',sans-serif;
  font-size:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;
  border-radius:100px;
}
.q-text{padding:12px 14px 14px;font-size:15px;color:var(--ink);line-height:1.72}

/* Answer */
.answer-zone{padding:10px 14px 14px;background:var(--bg2);border-top:1px dashed var(--rule)}
.answer-lbl{
  font-family:'Barlow Condensed',sans-serif;
  font-size:10px;letter-spacing:2.5px;text-transform:uppercase;
  color:var(--ink5);margin-bottom:6px;
  display:flex;align-items:center;gap:6px;font-weight:700;
}
.answer-lbl::before{content:'';width:3px;height:10px;background:var(--k);display:inline-block}
.answer-ta{
  width:100%;min-height:76px;padding:10px 12px;
  font-family:'Barlow',sans-serif;font-size:15px;
  line-height:1.65;color:var(--ink);
  background:var(--bg);border:1.5px solid var(--rule);border-radius:0;
  resize:vertical;outline:none;transition:border-color .1s;
}
.answer-ta::placeholder{color:var(--ink5);font-style:italic}
.answer-ta:focus{border-color:var(--k)}
.answer-ta.has-content{border-color:var(--k-bd)}
.answer-ta.locked{border-color:var(--green)!important;background:var(--green2)!important;color:var(--ink2);resize:none;cursor:default}
.val-bar{
  display:flex;align-items:center;gap:8px;flex-wrap:wrap;
  padding:8px 0 0;
}
.btn-val{
  display:inline-flex;align-items:center;gap:6px;padding:7px 16px;
  font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;
  letter-spacing:1px;text-transform:uppercase;
  background:var(--k);color:#fff;border:none;cursor:pointer;
  border-radius:100px;transition:background .1s;
}
.btn-val:hover{background:var(--k1)}
.btn-val:disabled{background:var(--rule);color:var(--ink4);cursor:not-allowed}
.btn-edit{
  display:none;align-items:center;gap:5px;padding:6px 14px;
  font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:600;
  letter-spacing:.8px;text-transform:uppercase;
  background:none;border:1.5px solid var(--rule);color:var(--ink4);
  cursor:pointer;border-radius:100px;transition:all .1s;
}
.btn-edit:hover{border-color:var(--ink);color:var(--ink)}
.val-tag{display:none;align-items:center;gap:5px;
  font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;
  letter-spacing:.8px;text-transform:uppercase;color:var(--green);
}
.val-tag.show{display:flex}
.val-hint{
  font-family:'Barlow',sans-serif;
  font-size:11px;font-style:italic;color:var(--ink5);margin-left:auto;
}

/* AI result */
.ai-result{display:none!important}
.ai-result.visible{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(-3px)}to{opacity:1;transform:translateY(0)}}
.ai-rh{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;gap:10px}
.ai-rh.correct-bg{background:var(--green2);border-bottom:1px solid rgba(10,107,56,.14)}
.ai-rh.partial-bg{background:var(--amber2);border-bottom:1px solid rgba(138,92,0,.14)}
.ai-rh.wrong-bg{background:var(--red2);border-bottom:1px solid rgba(190,46,39,.12)}
.ai-rh.loading-bg{background:var(--bg2);border-bottom:1px solid var(--rule)}
.ai-rl{display:flex;align-items:center;gap:8px;
  font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;
  letter-spacing:.5px;text-transform:uppercase;
}
.ai-sc{
  font-family:'Barlow Condensed',sans-serif;
  font-size:24px;font-weight:800;line-height:1;
  letter-spacing:-1px;white-space:nowrap;
}
.ai-sc.correct-col{color:var(--green)}
.ai-sc.partial-col{color:var(--amber)}
.ai-sc.wrong-col{color:var(--red)}
.ai-sc.loading-col{
  color:var(--ink4);font-size:13px;letter-spacing:1px;
  font-family:'Barlow Condensed',sans-serif;
}
.ai-fb{
  padding:10px 14px;font-size:14px;line-height:1.65;
  color:var(--ink2);background:var(--bg);
  font-family:'Barlow',sans-serif;font-style:italic;
}
.mini-sp{
  display:inline-block;width:12px;height:12px;
  border:2px solid var(--rule);border-top-color:var(--k);
  border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;
}

/* Correction */
.corr-toggle{
  margin-top:16px;padding-top:14px;border-top:1px dashed var(--rule);
  display:flex;align-items:center;gap:12px;flex-wrap:wrap;
}
.btn-see{
  display:inline-flex;align-items:center;gap:7px;padding:7px 16px;
  font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;
  letter-spacing:1px;text-transform:uppercase;
  background:none;border:1.5px solid var(--amber);color:var(--amber);
  cursor:pointer;transition:all .1s;border-radius:100px;
}
.btn-see:hover:not(:disabled){background:var(--amber2)}
.btn-see.active{background:var(--amber);color:#fff}
.btn-see:disabled{border-color:var(--rule);color:var(--ink4);cursor:not-allowed;opacity:.5}
.corr-hint{
  font-family:'Barlow',sans-serif;
  font-size:11px;font-style:italic;color:var(--ink5);
}
.correction{
  display:none;margin-top:12px;padding:16px 18px;
  background:var(--amber2);border:1.5px solid rgba(138,92,0,.2);
}
.correction.open{display:block;animation:fadeUp .2s ease}
.corr-head{
  display:flex;align-items:center;gap:9px;
  padding-bottom:12px;margin-bottom:12px;
  border-bottom:1px solid rgba(138,92,0,.18);
}
.corr-badge{
  width:16px;height:16px;background:var(--amber);color:#fff;
  border-radius:50%;display:flex;align-items:center;
  justify-content:center;font-size:8px;font-weight:700;flex-shrink:0;
}
.corr-head span{
  font-family:'Barlow Condensed',sans-serif;
  font-size:10px;letter-spacing:2.5px;text-transform:uppercase;
  color:var(--amber);font-weight:700;
}
.correction p{margin-bottom:9px;font-size:14px;color:var(--ink2)}
.correction p:last-child{margin-bottom:0}
.corr-block{margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid rgba(138,92,0,.12)}
.corr-block:last-child{border-bottom:none;padding-bottom:0;margin-bottom:0}
.corr-title{
  font-family:'Barlow Condensed',sans-serif;
  font-size:10px;letter-spacing:2px;text-transform:uppercase;
  color:var(--amber);font-weight:700;margin-bottom:6px;
  display:flex;align-items:center;gap:7px;
}
.corr-title::before{content:'§';font-size:13px}

.exam-footer{
  border-top:2px solid var(--ink);padding:20px 48px;
  display:flex;align-items:center;justify-content:space-between;
  flex-wrap:wrap;gap:16px;margin-top:8px;
}
.exam-footer p{
  font-family:'Barlow Condensed',sans-serif;
  font-size:11px;font-style:normal;letter-spacing:1px;text-transform:uppercase;
  color:var(--ink5);font-weight:600;
}
.footer-score{
  font-family:'Barlow Condensed',sans-serif;
  font-size:56px;font-weight:800;color:var(--ink);
  line-height:1;letter-spacing:-2px;
}
.footer-score sub{
  font-family:'Barlow Condensed',sans-serif;
  font-size:18px;font-weight:600;color:var(--ink4);
  vertical-align:middle;letter-spacing:0;
}

/* ═══════════════════════════════════════
   SCREEN 3 — RESULTS
   ═══════════════════════════════════════ */
#screen-results{background:var(--bg)}
.res-banner{background:var(--k)}
.res-banner-inner{
  max-width:880px;margin:0 auto;padding:52px 48px 44px;
  display:grid;grid-template-columns:1fr auto;gap:32px;align-items:center;
}
.res-eyebrow{
  font-family:'Barlow Condensed',sans-serif;
  font-size:10px;letter-spacing:4px;text-transform:uppercase;
  color:rgba(255,255,255,.4);font-weight:700;margin-bottom:12px;display:block;
}
.res-score{
  font-family:'Barlow Condensed',sans-serif;
  font-size:clamp(72px,12vw,110px);
  font-weight:800;line-height:.85;
  letter-spacing:-4px;color:#fff;
}
.res-score span{font-size:clamp(22px,3.5vw,32px);color:rgba(255,255,255,.3);font-weight:600;letter-spacing:0}
.res-mention{
  font-family:'Barlow Condensed',sans-serif;
  font-size:13px;font-weight:700;letter-spacing:1px;text-transform:uppercase;
  color:rgba(255,255,255,.6);margin-top:14px;
}
.res-bar-wrap{margin-top:12px;height:3px;background:rgba(255,255,255,.15);overflow:hidden;max-width:400px}
.res-bar{height:100%;background:rgba(255,255,255,.7);transition:width 1.2s ease}
.res-detail{display:flex;flex-direction:column;gap:8px;min-width:110px}
.res-stat{
  padding:12px 16px;background:rgba(255,255,255,.1);
  border:1px solid rgba(255,255,255,.12);text-align:center;
}
.res-stat .v{
  font-family:'Barlow Condensed',sans-serif;
  font-size:24px;font-weight:800;color:#fff;line-height:1;letter-spacing:-1px;
}
.res-stat .l{
  font-family:'Barlow Condensed',sans-serif;
  font-size:9px;letter-spacing:2px;text-transform:uppercase;
  color:rgba(255,255,255,.3);margin-top:3px;font-weight:700;
}
.res-body{
  max-width:880px;margin:0 auto;padding:40px 48px 72px;
  display:grid;grid-template-columns:1fr 1fr;gap:48px;
}
.bdown-row{
  display:flex;align-items:center;justify-content:space-between;
  padding:8px 0;border-bottom:1px solid var(--rule2);
}
.bdown-row:last-child{border-bottom:none}
.bdown-notion{
  font-family:'Barlow Condensed',sans-serif;
  font-size:13px;font-weight:700;letter-spacing:.3px;color:var(--ink3);
}
.bdown-pts{
  font-family:'Barlow Condensed',sans-serif;
  font-size:18px;font-weight:800;letter-spacing:-1px;
}
.bdown-pct{height:2px;background:var(--rule2);margin-top:3px;overflow:hidden}
.bdown-pct-fill{height:100%;background:var(--k);transition:width .9s ease}
.err-card{
  padding:10px 14px;background:var(--bg);border:1.5px solid var(--rule);
  border-left:3px solid var(--red);margin-bottom:8px;
}
.err-q{font-size:13px;color:var(--ink2);margin-bottom:4px}
.err-sc{
  font-family:'Barlow Condensed',sans-serif;
  font-size:11px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;
}
.err-fb{font-size:12px;font-style:italic;color:var(--ink4);margin-top:3px}
.res-cta{
  grid-column:1/-1;display:flex;gap:10px;flex-wrap:wrap;
  justify-content:flex-start;padding-top:16px;border-top:2px solid var(--ink);
}

/* ═══════════════════════════════════════
   SCREEN 4 — DASHBOARD
   ═══════════════════════════════════════ */
#screen-dash{background:var(--bg)}
.dash-banner{background:var(--ink)}
.dash-banner-inner{max-width:960px;margin:0 auto;padding:48px 48px 40px}
.dash-banner-inner .lp-overline{
  font-family:'Barlow Condensed',sans-serif;
  font-size:10px;letter-spacing:4px;text-transform:uppercase;
  color:rgba(255,255,255,.3);display:block;margin-bottom:10px;font-weight:700;
}
.dash-banner h2{
  font-family:'Barlow Condensed',sans-serif;
  font-size:clamp(36px,5.5vw,64px);font-weight:800;
  letter-spacing:-1.5px;text-transform:uppercase;
  color:#fff;line-height:.92;margin:0;
}
.dash-banner h2 em{font-style:normal;color:rgba(150,180,255,.85)}
.dash-banner p{
  font-family:'Barlow Condensed',sans-serif;
  font-size:12px;font-weight:500;letter-spacing:1px;text-transform:uppercase;
  color:rgba(255,255,255,.3);margin-top:10px;
}
.dash-body{max-width:960px;margin:0 auto;padding:36px 48px 72px}
.stat-row{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
  gap:1px;background:var(--ink);border:1.5px solid var(--ink);
  margin-bottom:40px;
}
.stat-card{padding:20px;background:var(--bg)}
.sc-val{
  font-family:'Barlow Condensed',sans-serif;
  font-size:36px;font-weight:800;line-height:1;
  letter-spacing:-1.5px;color:var(--ink);
}
.sc-val.navy,.sc-val.blue{color:var(--k)}
.sc-val.green{color:var(--green)}
.sc-val.gold{color:var(--amber)}
.sc-val.red{color:var(--red)}
.sc-lbl{
  font-family:'Barlow Condensed',sans-serif;
  font-size:10px;letter-spacing:2.5px;text-transform:uppercase;
  color:var(--ink5);margin-top:6px;font-weight:700;
}
.chart-section{margin-bottom:40px}
.chart-wrap{height:100px;display:flex;align-items:flex-end;gap:4px;border-bottom:2px solid var(--ink)}
.chart-col{display:flex;flex-direction:column;align-items:center;gap:4px;flex:1;min-width:0}
.chart-bar{width:100%;transition:height .5s ease;min-height:2px}
.chart-lbl{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:600;letter-spacing:.5px;color:var(--ink5);text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%}
.chart-val{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:800;color:var(--ink4);text-align:center}
.dash-grid{display:grid;grid-template-columns:3fr 2fr;gap:40px}
.hist-table{width:100%;border-collapse:collapse}
.hist-table th{
  padding:8px 10px;text-align:left;
  font-family:'Barlow Condensed',sans-serif;
  font-size:10px;letter-spacing:2.5px;text-transform:uppercase;
  color:var(--ink5);border-bottom:2px solid var(--ink);font-weight:700;
}
.hist-table td{
  padding:9px 10px;border-bottom:1px solid var(--rule2);
  font-size:13px;color:var(--ink2);
}
.hist-table tr:hover td{background:var(--bg2)}
.score-chip{
  display:inline-block;padding:2px 10px;border-radius:100px;
  font-family:'Barlow Condensed',sans-serif;
  font-size:12px;font-weight:800;letter-spacing:.5px;text-transform:uppercase;
}
.score-chip.a{background:var(--green2);color:var(--green)}
.score-chip.b{background:var(--amber2);color:var(--amber)}
.score-chip.c{background:var(--red2);color:var(--red)}
.nb-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.nb-label{
  font-family:'Barlow Condensed',sans-serif;
  font-size:12px;font-weight:700;letter-spacing:.3px;text-transform:uppercase;
  color:var(--ink3);width:150px;flex-shrink:0;
}
.nb-track{flex:1;height:3px;background:var(--rule2);overflow:hidden}
.nb-fill{height:100%;transition:width .8s ease}
.nb-count{
  font-family:'Barlow Condensed',sans-serif;
  font-size:12px;font-weight:800;color:var(--ink4);width:24px;text-align:right;
}
.empty-state{text-align:center;padding:72px 20px;color:var(--ink5)}
.empty-state .ei{font-size:32px;display:block;margin-bottom:16px;opacity:.3}

/* ═══════════════════════════════════════
   RESPONSIVE
   ═══════════════════════════════════════ */
@media(max-width:760px){
  .gnav{padding:0}.gnav-links{display:none}
  #screen-landing{height:auto;overflow:visible}
  .lp-hero{grid-template-columns:1fr}
  .lp-right{grid-template-rows:auto;grid-template-columns:1fr 1fr}
  .lp-tile{padding:20px 24px}
  .lp-left{padding:40px 24px;border-right:none;border-bottom:2px solid var(--ink)}
  .lp-left::before{display:none}
  .lp-strip{grid-template-columns:1fr 1fr}
  .lp-strip-item:nth-child(3){border-top:1px solid var(--rule)}
  .setup-header{padding:0 20px}
  .setup-hero{padding:32px 20px}
  .setup-hero-inner{grid-template-columns:1fr}
  .setup-stats{border-left:none;padding-left:0;border-top:2px solid rgba(255,255,255,.2);padding-top:20px;display:grid;grid-template-columns:repeat(3,1fr)}
  .setup-body{padding:28px 20px 60px}
  .exam-top-inner{padding:8px 20px}
  .pills-bar-inner{padding:6px 20px}
  .exam-main{padding:20px 16px 80px}
  .exam-footer{padding:16px 20px}
  .res-banner-inner{grid-template-columns:1fr;padding:32px 20px}
  .res-body{grid-template-columns:1fr;padding:24px 20px 60px;gap:28px}
  .dash-banner-inner{padding:32px 20px}
  .dash-body{padding:20px 16px 60px}
  .dash-grid{grid-template-columns:1fr}
}

/* ── Blocs Scratch style ── */
.scratch-wrap{
  margin:14px 0;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
  align-items:start;
}
.scratch-wrap.single{grid-template-columns:1fr auto;align-items:start}
.scratch-code{
  background:#1e1e2e;
  border-radius:8px;
  padding:14px 16px;
  font-size:0;
  line-height:1;
  overflow:hidden;
}
.scratch-hat{
  display:inline-flex;align-items:center;gap:6px;
  padding:8px 14px 8px 12px;
  border-radius:20px 20px 4px 4px;
  font-family:'Barlow Condensed',sans-serif;
  font-size:12px;font-weight:700;letter-spacing:.3px;
  color:#fff;margin-bottom:4px;
}
.sb-event{background:#ffab19}
.sb-control{background:#ffab19}
.sb-motion{background:#4c97ff}
.sb-op{background:#ff8c1a}
.sb-variable{background:#ff8c1a}
.sb-looks{background:#9966ff}
.sb-sensor{background:#5cb1d6}

.scratch-block{
  display:flex;align-items:center;gap:6px;
  padding:7px 12px 7px 20px;
  margin:3px 0 3px 12px;
  border-radius:4px;
  font-family:'Barlow Condensed',sans-serif;
  font-size:12px;font-weight:700;letter-spacing:.3px;
  color:#fff;position:relative;
  flex-wrap:wrap;
}
.scratch-block::before{
  content:'';position:absolute;
  left:0;top:50%;transform:translateY(-50%);
  width:0;height:0;
  border-top:7px solid transparent;
  border-bottom:7px solid transparent;
}
.scratch-block.sb-motion{background:#4c97ff}
.scratch-block.sb-motion::before{border-left:7px solid #3373cc}
.scratch-block.sb-control{background:#ffab19}
.scratch-block.sb-control::before{border-left:7px solid #cc8800}
.scratch-block.sb-op{background:#59c059}
.scratch-block.sb-op::before{border-left:7px solid #389438}
.scratch-block.sb-variable{background:#ff8c1a}
.scratch-block.sb-variable::before{border-left:7px solid #cc6600}
.scratch-block.sb-looks{background:#9966ff}
.scratch-block.sb-looks::before{border-left:7px solid #7744cc}
.scratch-block.sb-sensor{background:#5cb1d6}
.scratch-block.sb-sensor::before{border-left:7px solid #3d8ea8}

.scratch-val{
  display:inline-flex;align-items:center;
  background:rgba(255,255,255,.2);
  border-radius:3px;padding:1px 6px;
  font-size:11px;font-weight:800;
}
.scratch-oval{
  display:inline-flex;align-items:center;
  background:rgba(255,255,255,.2);
  border-radius:20px;padding:1px 8px;
  font-size:11px;font-weight:700;
}
.scratch-repeat{
  display:block;
  margin:3px 0 3px 12px;
  padding:6px 10px 6px 14px;
  background:#ffab19;border-radius:4px;
  font-family:'Barlow Condensed',sans-serif;
  font-size:12px;font-weight:700;color:#fff;
}
.scratch-repeat-body{
  margin:2px 0 2px 12px;
  padding:4px 0;
  border-left:3px solid rgba(255,255,255,.4);
}
.scratch-result{
  background:#f0f0f0;
  border:1.5px solid #d0d0d0;
  border-radius:8px;
  padding:12px;
  display:flex;flex-direction:column;align-items:center;
  gap:8px;
}
.scratch-result-label{
  font-family:'Barlow Condensed',sans-serif;
  font-size:10px;font-weight:700;letter-spacing:2px;
  text-transform:uppercase;color:#888;
}
.scratch-result svg{display:block}


/* ── Correction inline (affichée après validation) ── */
.inline-corr-wrap{margin-top:10px}
.inline-corr{
  display:flex;gap:12px;align-items:flex-start;
  padding:12px 16px;border-radius:0;
  border:1.5px solid;
  animation:fadeUp .2s ease;
}
.inline-corr.correct-corr{
  background:var(--green2);
  border-color:rgba(10,107,56,.25);
  border-left:4px solid var(--green);
}
.inline-corr.partial-corr{
  background:var(--amber2);
  border-color:rgba(138,92,0,.25);
  border-left:4px solid var(--amber);
}
.inline-corr.wrong-corr{
  background:var(--red2);
  border-color:rgba(190,46,39,.2);
  border-left:4px solid var(--red);
}
.inline-corr-icon{
  font-size:20px;font-weight:900;line-height:1;
  flex-shrink:0;margin-top:1px;
  font-family:'Barlow Condensed',sans-serif;
}
.correct-corr .inline-corr-icon{color:var(--green)}
.partial-corr .inline-corr-icon{color:var(--amber)}
.wrong-corr .inline-corr-icon{color:var(--red)}
.inline-corr-body{flex:1;min-width:0}
.inline-corr-label{
  font-family:'Barlow Condensed',sans-serif;
  font-size:11px;font-weight:800;letter-spacing:1.5px;
  text-transform:uppercase;margin-bottom:5px;
}
.correct-corr .inline-corr-label{color:var(--green)}
.partial-corr .inline-corr-label{color:var(--amber)}
.wrong-corr .inline-corr-label{color:var(--red)}
.inline-corr-feedback{
  font-size:13px;color:var(--ink2);
  line-height:1.6;margin-bottom:8px;
  font-style:italic;
}
.inline-corr-official{
  font-size:13px;color:var(--ink2);
  line-height:1.65;
  padding:10px 12px;
  background:rgba(255,255,255,.7);
  border:1px solid rgba(0,0,0,.08);
}
.inline-corr-official strong{
  font-family:'Barlow Condensed',sans-serif;
  font-size:10px;letter-spacing:2px;text-transform:uppercase;
  font-weight:800;color:var(--ink4);
  display:block;margin-bottom:4px;
}


/* ── Live score — upgraded ── */
.live-sc-box{
  text-align:right;
  position:relative;
  padding:4px 14px 4px 14px;
  border-left:1px solid rgba(255,255,255,.12);
}
.live-sc-num{
  font-family:'Barlow Condensed',sans-serif;
  font-size:28px;font-weight:900;color:#fff;
  line-height:1;letter-spacing:-1.5px;
  transition:all .25s cubic-bezier(.34,1.56,.64,1);
}
.live-sc-num.bump{
  transform:scale(1.3);
  color:#7ef7a0;
}
.live-sc-denom{
  font-family:'Barlow Condensed',sans-serif;
  font-size:12px;font-weight:600;
  color:rgba(255,255,255,.35);
  letter-spacing:.5px;
}
.live-sc-lbl{
  font-family:'Barlow Condensed',sans-serif;
  font-size:9px;font-weight:700;letter-spacing:2px;
  text-transform:uppercase;color:rgba(255,255,255,.3);
  margin-top:2px;text-align:right;
}
/* Progress bar under exam top */
.exam-progress-bar{
  height:3px;
  background:rgba(255,255,255,.08);
  overflow:hidden;
  position:relative;
}
.exam-progress-fill{
  height:100%;
  background:linear-gradient(90deg,#002FA7,#4d80d9);
  width:0%;
  transition:width .5s ease, background .5s ease;
}
/* Score flash on question card */
.q-score-flash{
  position:absolute;top:-8px;right:10px;
  font-family:'Barlow Condensed',sans-serif;
  font-size:13px;font-weight:900;
  padding:2px 10px;border-radius:100px;
  animation:scoreFlash .6s ease forwards;
  pointer-events:none;z-index:10;
}
@keyframes scoreFlash{
  0%{opacity:0;transform:translateY(0) scale(.8)}
  30%{opacity:1;transform:translateY(-12px) scale(1.1)}
  70%{opacity:1;transform:translateY(-18px) scale(1)}
  100%{opacity:0;transform:translateY(-28px) scale(.9)}
}
.q-score-flash.correct{background:#0a6b38;color:#fff}
.q-score-flash.partial{background:#8a5c00;color:#fff}
.q-score-flash.wrong{background:#be2e27;color:#fff}

/* Footer score bar */
.footer-score-wrap{
  display:flex;flex-direction:column;align-items:flex-end;gap:6px;
}
.footer-score{
  font-family:'Barlow Condensed',sans-serif;
  font-size:56px;font-weight:900;color:var(--ink);
  line-height:1;letter-spacing:-2.5px;
}
.footer-score sub{
  font-family:'Barlow Condensed',sans-serif;
  font-size:20px;font-weight:600;color:var(--ink4);
  vertical-align:middle;letter-spacing:0;
}
.footer-bar-track{
  width:180px;height:4px;
  background:var(--rule2);
  overflow:hidden;border-radius:2px;
}
.footer-bar-fill{
  height:100%;border-radius:2px;
  background:var(--k);
  transition:width .6s ease;
  width:0%;
}
/* Question pts badge — updated dynamically */
.q-pts-earned{
  display:inline-flex;align-items:center;
  font-family:'Barlow Condensed',sans-serif;
  font-size:11px;font-weight:800;letter-spacing:.5px;text-transform:uppercase;
  padding:2px 10px;border-radius:100px;
  margin-left:8px;
  transition:all .2s ease;
}
.q-pts-earned.earned-full{background:var(--green2);color:var(--green)}
.q-pts-earned.earned-partial{background:var(--amber2);color:var(--amber)}
.q-pts-earned.earned-none{background:var(--red2);color:var(--red)}


/* ════════════════════════════════════
   SCREEN 3 — RESULTS (redesigned)
   ════════════════════════════════════ */
#screen-results{background:var(--bg);min-height:100vh}

.res-hero{
  background:var(--ink);
  border-bottom:none;
}
.res-hero-inner{
  max-width:1040px;margin:0 auto;
  padding:52px 48px 44px;
  display:grid;
  grid-template-columns:1fr auto;
  gap:40px;align-items:end;
}
.res-score-col{}
.res-eyebrow{
  font-family:'Barlow Condensed',sans-serif;
  font-size:10px;letter-spacing:4px;text-transform:uppercase;
  color:rgba(255,255,255,.35);font-weight:700;
  margin-bottom:14px;display:block;
}
.res-score{
  font-family:'Barlow Condensed',sans-serif;
  font-size:clamp(80px,12vw,120px);
  font-weight:900;line-height:.85;
  letter-spacing:-5px;color:#fff;
}
.res-score span{
  font-size:clamp(24px,4vw,36px);
  color:rgba(255,255,255,.25);
  font-weight:600;letter-spacing:-1px;
  margin-left:6px;
}
.res-mention{
  font-family:'Barlow Condensed',sans-serif;
  font-size:14px;font-weight:700;letter-spacing:2px;
  text-transform:uppercase;
  color:rgba(255,255,255,.55);
  margin-top:16px;
}
.res-bar-wrap{
  margin-top:16px;height:4px;
  background:rgba(255,255,255,.12);overflow:hidden;
  max-width:480px;
}
.res-bar{height:100%;background:#fff;transition:width 1.4s cubic-bezier(.22,1,.36,1)}

/* Stats column */
.res-stats-col{
  display:flex;flex-direction:column;gap:8px;
  min-width:120px;
}
.res-stat-box{
  padding:14px 20px;
  background:rgba(255,255,255,.07);
  border:1px solid rgba(255,255,255,.1);
  text-align:center;
  transition:background .2s;
}
.res-stat-box.partial{background:rgba(138,92,0,.2);border-color:rgba(138,92,0,.3)}
.res-stat-box.wrong{background:rgba(190,46,39,.18);border-color:rgba(190,46,39,.25)}
.res-stat-n{
  font-family:'Barlow Condensed',sans-serif;
  font-size:26px;font-weight:900;color:#fff;
  line-height:1;letter-spacing:-1px;
}
.res-stat-l{
  font-family:'Barlow Condensed',sans-serif;
  font-size:9px;letter-spacing:2px;text-transform:uppercase;
  color:rgba(255,255,255,.3);font-weight:700;margin-top:3px;
}

/* 3-col body */
.res-main{
  max-width:1040px;margin:0 auto;
  padding:40px 48px 80px;
  display:grid;
  grid-template-columns:1fr 1fr 1.3fr;
  gap:40px;
  align-items:start;
}
.res-col{}
.res-col-title{
  font-family:'Barlow Condensed',sans-serif;
  font-size:11px;font-weight:800;letter-spacing:3px;
  text-transform:uppercase;color:var(--k);
  padding-bottom:12px;margin-bottom:18px;
  border-bottom:2px solid var(--ink);
}

/* Notion rows */
.bdown-row{
  display:flex;align-items:center;justify-content:space-between;
  padding:9px 0;border-bottom:1px solid var(--rule2);
}
.bdown-row:last-child{border-bottom:none}
.bdown-notion{
  font-family:'Barlow Condensed',sans-serif;
  font-size:13px;font-weight:700;letter-spacing:.3px;color:var(--ink3);
}
.bdown-pts{
  font-family:'Barlow Condensed',sans-serif;
  font-size:17px;font-weight:900;letter-spacing:-1px;
}
.bdown-pct{height:2px;background:var(--rule2);margin-top:3px;overflow:hidden}
.bdown-pct-fill{height:100%;transition:width .9s ease}

/* Error cards */
.err-card{
  padding:10px 14px;background:var(--bg);
  border:1.5px solid var(--rule);
  border-left:3px solid var(--red);
  margin-bottom:8px;
}
.err-q{font-size:13px;color:var(--ink2);margin-bottom:4px;line-height:1.45}
.err-sc{
  font-family:'Barlow Condensed',sans-serif;
  font-size:11px;font-weight:800;letter-spacing:1px;text-transform:uppercase;
}
.err-fb{font-size:12px;font-style:italic;color:var(--ink4);margin-top:3px;line-height:1.5}

/* Advice column */
.res-col-advice{
  background:var(--bg2);
  border:1.5px solid var(--rule);
  padding:20px 22px;
}
.advice-loading{
  display:flex;align-items:center;gap:10px;
  font-family:'Barlow Condensed',sans-serif;
  font-size:12px;font-weight:600;letter-spacing:1.5px;
  text-transform:uppercase;color:var(--ink4);
  padding:16px 0;
}
.advice-section{margin-bottom:20px}
.advice-section:last-child{margin-bottom:0}
.advice-section-title{
  font-family:'Barlow Condensed',sans-serif;
  font-size:10px;font-weight:800;letter-spacing:2.5px;
  text-transform:uppercase;color:var(--k);
  margin-bottom:10px;
  display:flex;align-items:center;gap:8px;
}
.advice-section-title::before{
  content:'';display:inline-block;
  width:3px;height:12px;background:var(--k);
}
.advice-item{
  padding:9px 12px;
  background:var(--bg);border:1px solid var(--rule2);
  border-left:3px solid var(--k);
  margin-bottom:7px;
  font-size:13px;color:var(--ink2);
  line-height:1.55;
}
.advice-item:last-child{margin-bottom:0}
.advice-item.priority-high{border-left-color:var(--red)}
.advice-item.priority-mid{border-left-color:var(--amber)}
.advice-item.priority-low{border-left-color:var(--green)}
.advice-tag{
  font-family:'Barlow Condensed',sans-serif;
  font-size:9px;font-weight:800;letter-spacing:1.5px;
  text-transform:uppercase;padding:1px 8px;border-radius:100px;
  display:inline-block;margin-bottom:5px;
}
.advice-tag.red{background:var(--red2);color:var(--red)}
.advice-tag.amber{background:var(--amber2);color:var(--amber)}
.advice-tag.green{background:var(--green2);color:var(--green)}
.advice-tag.blue{background:var(--k-bg);color:var(--k)}
.advice-encouragement{
  margin-top:18px;padding:14px 16px;
  background:var(--k);
  font-family:'Barlow Condensed',sans-serif;
  font-size:14px;font-weight:700;letter-spacing:.3px;
  color:#fff;line-height:1.5;
}

/* Footer CTA */
.res-footer{
  max-width:1040px;margin:0 auto;
  padding:0 48px 48px;
  display:flex;gap:12px;flex-wrap:wrap;
  border-top:none;
}


.dash-advice-col{background:var(--bg2);border:1.5px solid var(--rule);padding:18px 20px}
.res-col-title{
  font-family:'Barlow Condensed',sans-serif;
  font-size:11px;font-weight:800;letter-spacing:3px;
  text-transform:uppercase;color:var(--k);
  padding-bottom:10px;margin-bottom:16px;
  border-bottom:2px solid var(--ink);
}


/* ── Score hero comment ── */
.res-comment-wrap{
  border-top:1px solid rgba(255,255,255,.1);
}
.res-comment{
  display:flex;align-items:flex-start;gap:14px;
  max-width:680px;
}
.res-comment-text{
  font-family:'Barlow',sans-serif;
  font-size:15px;line-height:1.72;
  color:rgba(255,255,255,.82);
  font-style:italic;
}
.res-comment-text strong{
  font-style:normal;
  font-family:'Barlow Condensed',sans-serif;
  font-size:11px;font-weight:800;letter-spacing:2px;
  text-transform:uppercase;
  color:rgba(255,255,255,.45);
  display:block;margin-bottom:6px;
}
.res-cta-top{
  background:var(--bg2);
  border-bottom:1px solid var(--rule);
}
.res-cta-top .res-hero-inner{
  display:flex;gap:10px;align-items:center;flex-wrap:wrap;
}


.exam-toast{
  position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(12px);
  background:var(--ink);color:#fff;
  font-family:'Barlow Condensed',sans-serif;
  font-size:12px;font-weight:700;letter-spacing:1px;text-transform:uppercase;
  padding:10px 24px;border-radius:100px;
  opacity:0;transition:opacity .3s,transform .3s;
  pointer-events:none;z-index:999;white-space:nowrap;
  border:1px solid rgba(255,255,255,.1);
}
.exam-toast.show{opacity:1;transform:translateX(-50%) translateY(0)}


.hist-table td:last-child{
  font-style:italic;
  color:var(--ink3);
  font-size:12px;
  line-height:1.45;
}

</style>

</head>
<body>

<!-- ══════════ GLOBAL NAV ══════════ -->
<nav class="gnav" id="gnav">
  <div class="gnav-logo" onclick="go('screen-landing','navLanding')"><em>Brevet</em> Blanc Maths</div>
  <div class="gnav-links">
    <button class="gnav-link active" id="navLanding" onclick="go('screen-landing','navLanding')">Accueil</button>
    <button class="gnav-link" id="navSetup" onclick="go('screen-setup','navSetup')">Commencer</button>
    <button class="gnav-link" id="navDash" onclick="go('screen-dash','navDash');renderDash()">Tableau de bord</button>
  </div>
</nav>

<!-- ══════════════════════════════════════════════
  SCREEN 0 — LANDING PAGE
══════════════════════════════════════════════ -->
<div class="screen active" id="screen-landing">
<div class="lp">

  <!-- HERO — plein viewport -->
  <div class="lp-hero">

    <!-- Left: pitch -->
    <div class="lp-left">
      <span class="lp-kicker">Diplôme National du Brevet · 3ème</span>
      <h1 class="lp-h1">
        Préparez<br>vous.<br><em>Réussissez.</em>
      </h1>
      <p class="lp-tagline">
        Exercices officiels DNB corrigés par IA, chronomètre d'examen réel,
        suivi de progression. Gratuit, sans inscription.
      </p>
      <div class="lp-cta-row">
        <button class="btn btn-primary" style="padding:13px 28px;font-size:14px" onclick="go('screen-setup','navSetup')">
          Commencer →
        </button>

      </div>
    </div>

    <!-- Right: 3 stat tiles -->
    <div class="lp-right">
      <div class="lp-tile">
        <div class="lp-tile-n">48</div>
        <div class="lp-tile-label">exercices issus des vrais sujets DNB 2023–2024</div>
      </div>
      <div class="lp-tile">
        <div class="lp-tile-n">10</div>
        <div class="lp-tile-label">notions du programme officiel de 3ème</div>
      </div>

    </div>

  </div>

  <!-- STRIP — 4 points clés -->
  <div class="lp-strip">
    <div class="lp-strip-item">
      <div class="lp-strip-dot"></div>
      <div class="lp-strip-text">Simulateur d'examen chronométré</div>
    </div>
    <div class="lp-strip-item">
      <div class="lp-strip-dot"></div>
      <div class="lp-strip-text">Corrigés détaillés étape par étape</div>
    </div>
    <div class="lp-strip-item">
      <div class="lp-strip-dot"></div>
      <div class="lp-strip-text">Suivi de progression par notion</div>
    </div>
    <div class="lp-strip-item">
      <div class="lp-strip-dot"></div>
      <div class="lp-strip-text">100 % gratuit · aucune inscription</div>
    </div>
  </div>

</div>
</div>

<div class="screen" id="screen-setup">

  <!-- ── Hero ── -->
  <div class="setup-hero" style="flex-shrink:0">
    <div class="setup-hero-inner" style="max-width:920px;margin:0 auto;padding:28px 48px 20px">
      <div>
        <span class="setup-eyebrow">Nouveau brevet blanc</span>
        <h1 class="setup-h1">
          Choisissez votre<br><em>épreuve.</em>
        </h1>
        <div class="setup-hero-meta">
          <span>100 points au total</span>
          <span>Durée au choix</span>
          <span>Notions ciblées</span>
        </div>
      </div>
      <div class="setup-stats">
        <div class="setup-stat">
          <div class="setup-stat-n">100</div>
          <div class="setup-stat-l">points</div>
        </div>
        <div class="setup-stat">
          <div class="setup-stat-n" id="setupTimerVal">2h</div>
          <div class="setup-stat-l">durée choisie</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ── Config body ── -->
  <div class="setup-body" style="flex:1;overflow-y:auto;min-height:0">

    <div class="setup-block">
      <div class="setup-block-title">Durée de l'épreuve</div>
      <div class="timer-row" id="timerRow">
        <div class="timer-chip sel" data-min="120" onclick="selTimer(this)">2h — Durée réelle</div>
        <div class="timer-chip" data-min="60" onclick="selTimer(this)">1 heure</div>
        <div class="timer-chip" data-min="30" onclick="selTimer(this)">30 min</div>
        <div class="timer-chip" data-min="10" onclick="selTimer(this)">10 min</div>
        <div class="timer-chip" data-min="5" onclick="selTimer(this)">5 min</div>
      </div>
    </div>

    <div class="setup-block">
      <div class="setup-block-title">Notions à travailler</div>
      <div class="chap-grid" id="chapGrid">
        <div class="chap-chip sel" data-id="all" onclick="selChap(this)"><div class="chk">✓</div><div><div class="ch-name">Toutes les notions</div><div class="ch-sub">Sujet complet type brevet</div></div></div>
        <div class="chap-chip" data-id="probabilites" onclick="selChap(this)"><div class="chk"></div><div><div class="ch-name">Probabilités</div><div class="ch-sub">Fréquences, événements</div></div></div>
        <div class="chap-chip" data-id="proportionnalite" onclick="selChap(this)"><div class="chk"></div><div><div class="ch-name">Proportionnalité</div><div class="ch-sub">Tableaux, pourcentages</div></div></div>
        <div class="chap-chip" data-id="statistiques" onclick="selChap(this)"><div class="chk"></div><div><div class="ch-name">Statistiques</div><div class="ch-sub">Moyenne, médiane, étendue</div></div></div>
        <div class="chap-chip" data-id="geometrie" onclick="selChap(this)"><div class="chk"></div><div><div class="ch-name">Géométrie</div><div class="ch-sub">Pythagore, Thalès, angles</div></div></div>
        <div class="chap-chip" data-id="algebre" onclick="selChap(this)"><div class="chk"></div><div><div class="ch-name">Algèbre &amp; Fonctions</div><div class="ch-sub">Équations, fonctions affines</div></div></div>
        <div class="chap-chip" data-id="arithmetique" onclick="selChap(this)"><div class="chk"></div><div><div class="ch-name">Arithmétique</div><div class="ch-sub">PGCD, PPCM, nombres premiers</div></div></div>
        <div class="chap-chip" data-id="volumes" onclick="selChap(this)"><div class="chk"></div><div><div class="ch-name">Volumes &amp; Grandeurs</div><div class="ch-sub">Solides, unités</div></div></div>
        <div class="chap-chip" data-id="puissances" onclick="selChap(this)"><div class="chk"></div><div><div class="ch-name">Puissances</div><div class="ch-sub">Notation scientifique</div></div></div>
        <div class="chap-chip" data-id="algorithmique" onclick="selChap(this)"><div class="chk"></div><div><div class="ch-name">Algorithmique</div><div class="ch-sub">Scratch, programmes</div></div></div>
      </div>
    </div>

    <div class="setup-cta">
      <button class="btn btn-dark" style="padding:13px 32px;font-size:14px" onclick="startExam()">
        Démarrer le brevet
      </button>
    </div>

  </div>
</div>

<!-- ══════════════════════════════════════════════
  SCREEN 2 — EXAM
══════════════════════════════════════════════ -->
<div class="screen" id="screen-exam">
  <div class="exam-top">
    <div class="exam-top-inner">
      <div class="exam-title-wrap">
        <h2>Brevet Blanc — Mathématiques</h2>
        <div class="sub" id="examSub">Chargement…</div>
      </div>
      <div class="timer-block">
        <div>
          <div class="timer-face" id="timerFace">02:00:00</div>
          <div style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,.28);text-align:center;margin-top:2px">Temps restant</div>
        </div>
        <div class="live-sc-box">
          <div style="display:flex;align-items:baseline;gap:3px;justify-content:flex-end">
            <div class="live-sc-num" id="liveSc">0</div>
            <span class="live-sc-denom" id="liveScMax">/0</span>
          </div>
          <div class="live-sc-lbl">points</div>
        </div>
        <button class="btn-end" id="btnEnd" onclick="endExam()" disabled title="Validez toutes vos réponses pour terminer">Terminer</button>
      </div>
    </div>
  </div>
  <div class="exam-progress-bar"><div class="exam-progress-fill" id="examProgressFill"></div></div>
  <div class="pills-bar"><div class="pills-bar-inner" id="pillsBar"></div></div>
  <div class="exam-main">
    <div class="loading-box" id="loadingBox">
      <div class="spinner"></div>
      <p>Génération des exercices…</p>
    </div>
    <div id="exContainer"></div>
    <div class="exam-footer" id="examFooter" style="display:none">
      <div>
        <div style="font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--ink5);font-weight:600;margin-bottom:4px">Total provisoire</div>
        <p style="font-size:13px;font-style:italic;color:var(--ink4)">Validez vos réponses pour calculer votre score</p>
      </div>
      <div class="footer-score-wrap">
        <div class="footer-score"><span id="footerSc">0</span><sub> pts</sub></div>
        <div class="footer-bar-track"><div class="footer-bar-fill" id="footerBarFill"></div></div>
      </div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════════
  SCREEN 3 — RESULTS
══════════════════════════════════════════════ -->
<div class="screen" id="screen-results">

  <!-- ═══════════════════════════════════
       SCORE HERO — full width, above fold
       ═══════════════════════════════════ -->
  <div class="res-hero">
    <div class="res-hero-inner">

      <!-- Score + mention + barre -->
      <div class="res-score-col">
        <div class="res-eyebrow">Brevet Blanc · Résultats</div>
        <div class="res-score" id="resScore">—<span>/100</span></div>
        <div class="res-mention" id="resMention"></div>
        <div class="res-bar-wrap"><div class="res-bar" id="resBar" style="width:0%"></div></div>
      </div>

      <!-- Stats rapides -->
      <div class="res-stats-col">
        <div class="res-stat-box">
          <div class="res-stat-n" id="resCorrect">—</div>
          <div class="res-stat-l">Correctes</div>
        </div>
        <div class="res-stat-box partial">
          <div class="res-stat-n" id="resPartial">—</div>
          <div class="res-stat-l">Partielles</div>
        </div>
        <div class="res-stat-box wrong">
          <div class="res-stat-n" id="resWrong">—</div>
          <div class="res-stat-l">Incorrectes</div>
        </div>
      </div>

    </div>

    <!-- Commentaire IA — sous le score, dans le hero -->
    <div class="res-comment-wrap">
      <div class="res-hero-inner" style="padding-top:0;padding-bottom:36px">
        <div id="resComment" class="res-comment">
          <span class="mini-sp" style="width:14px;height:14px;border-width:2px;border-top-color:rgba(255,255,255,.6);border-color:rgba(255,255,255,.2)"></span>
          <span style="font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:rgba(255,255,255,.4)">Analyse en cours…</span>
        </div>
      </div>
    </div>

  </div>

  <!-- ═══════════════════════════════════
       CTA — juste après le score
       ═══════════════════════════════════ -->
  <div class="res-cta-top">
    <div class="res-hero-inner" style="padding:20px 48px">
      <button class="btn btn-primary" onclick="go('screen-setup','navSetup')">Nouveau brevet</button>
      <button class="btn btn-light" onclick="go('screen-dash','navDash');renderDash()">Tableau de bord</button>
      <button class="btn btn-ghost" onclick="document.getElementById('res-details').scrollIntoView({behavior:'smooth'})">Voir le détail ↓</button>
    </div>
  </div>

  <!-- ═══════════════════════════════════
       DÉTAILS — 3 colonnes
       ═══════════════════════════════════ -->
  <div class="res-main" id="res-details">

    <div class="res-col">
      <div class="res-col-title">Score par notion</div>
      <div id="resByNotion"></div>
    </div>

    <div class="res-col">
      <div class="res-col-title">Points à retravailler</div>
      <div id="resErrors"></div>
    </div>

    <div class="res-col res-col-advice">
      <div class="res-col-title">Conseils de révision</div>
      <div id="resAdvice">
        <div class="advice-loading">
          <span class="mini-sp" style="width:14px;height:14px;border-width:2px"></span>
          <span>Chargement…</span>
        </div>
      </div>
    </div>

  </div>

  <div class="res-footer">
    <button class="btn btn-primary" onclick="go('screen-setup','navSetup')">Nouveau brevet</button>
    <button class="btn btn-light" onclick="go('screen-dash','navDash');renderDash()">Tableau de bord</button>
  </div>

</div>

<!-- ══════════════════════════════════════════════
  SCREEN 4 — DASHBOARD
══════════════════════════════════════════════ -->
<div class="screen" id="screen-dash">

  <!-- Banner -->
  <div class="dash-banner">
    <div class="dash-banner-inner" style="padding:36px 48px 28px">
      <span class="lp-overline" style="color:rgba(255,255,255,.3);font-family:'Barlow Condensed',sans-serif;font-size:10px;letter-spacing:4px;text-transform:uppercase;font-weight:700;display:block;margin-bottom:8px">Votre espace</span>
      <h2 style="font-family:'Barlow Condensed',sans-serif;font-size:clamp(36px,5vw,56px);font-weight:900;letter-spacing:-1.5px;text-transform:uppercase;color:#fff;line-height:.92;margin:0">Tableau de <em style="font-style:normal;color:rgba(150,180,255,.85)">bord</em></h2>
    </div>
  </div>

  <div class="dash-body">

    <!-- KPI row -->
    <div class="stat-row" id="dashStats"></div>

    <!-- Chart -->
    <div class="chart-section" id="chartSection" style="display:none;margin-bottom:32px">
      <div class="rule">Progression des scores</div>
      <div class="chart-wrap" id="chartWrap"></div>
    </div>

    <!-- 3-col grid: history | notions | AI advice -->
    <div style="display:grid;grid-template-columns:1.2fr 1fr 1.1fr;gap:36px;align-items:start" id="dashGrid"></div>

  </div>
</div>



<script>
/* ═══════════════════════════════
   STATE
═══════════════════════════════ */
let selMin = 120, selChaps = ['all'];
let timerIv = null, secsLeft = 0;
let exerciseData = [], scores = {}, validated = {}, feedbacks = {};

/* ═══════════════════════════════
   NAV
═══════════════════════════════ */
function go(screenId, navId){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(screenId).classList.add('active');
  document.querySelectorAll('.gnav-link').forEach(n=>n.classList.remove('active'));
  if(navId) document.getElementById(navId)?.classList.add('active');
  window.scrollTo({top:0,behavior:'smooth'});
}
function scrollToId(id){ document.getElementById(id)?.scrollIntoView({behavior:'smooth'}); }
function toggleFaq(el){ el.classList.toggle('open'); }

/* ═══════════════════════════════
   EXERCISE BANK
═══════════════════════════════ */
const BANK = {
  probabilites:[
    {title:"Probabilités — Urne et tirage aléatoire",notion:"Probabilités",pts:20,
     intro:"Dans une urne contenant 40 boules indiscernables au toucher, 5 sont rouges, 20 sont vertes et 15 sont blanches. On tire une boule au hasard.",
     figure:`<svg viewBox="0 0 260 180" xmlns="http://www.w3.org/2000/svg">
  <defs><style>text{font:12px 'DM Sans',sans-serif;fill:#0a0a0a}.lb{font-weight:600}</style></defs>
  <ellipse cx="130" cy="155" rx="70" ry="18" fill="#e0dbd3" stroke="#888" stroke-width="1.5"/>
  <path d="M60,70 Q55,155 130,173 Q205,155 200,70 Q170,90 130,92 Q90,90 60,70Z" fill="#f6f4f0" stroke="#888" stroke-width="1.5"/>
  <ellipse cx="130" cy="70" rx="70" ry="18" fill="#e0dbd3" stroke="#888" stroke-width="1.5"/>
  <!-- Boules: rouges -->
  <circle cx="98" cy="115" r="10" fill="#e63946" stroke="#c8252d" stroke-width="1"/>
  <circle cx="118" cy="125" r="10" fill="#e63946" stroke="#c8252d" stroke-width="1"/>
  <!-- vertes -->
  <circle cx="140" cy="112" r="10" fill="#2dc653" stroke="#1d9c3c" stroke-width="1"/>
  <circle cx="158" cy="122" r="10" fill="#2dc653" stroke="#1d9c3c" stroke-width="1"/>
  <circle cx="126" cy="140" r="10" fill="#2dc653" stroke="#1d9c3c" stroke-width="1"/>
  <!-- blanches -->
  <circle cx="108" cy="135" r="9" fill="#fff" stroke="#ccc" stroke-width="1"/>
  <circle cx="150" cy="135" r="9" fill="#fff" stroke="#ccc" stroke-width="1"/>
  <!-- legend -->
  <circle cx="30" cy="35" r="7" fill="#e63946"/><text x="42" y="40" class="lb">5 rouges</text>
  <circle cx="30" cy="58" r="7" fill="#2dc653"/><text x="42" y="63" class="lb">20 vertes</text>
  <circle cx="30" cy="81" r="7" fill="#fff" stroke="#ccc" stroke-width="1"/><text x="42" y="86" class="lb">15 blanches</text>
</svg>`,
     questions:[
       {pts:7,text:"Calculer la probabilité d'obtenir une boule verte. Justifier.",ans:"P(verte) = 20/40 = 1/2 = 0,5"},
       {pts:7,text:"Calculer la probabilité d'obtenir une boule qui n'est pas rouge.",ans:"P(non rouge) = (20+15)/40 = 35/40 = 7/8 ≈ 0,875"},
       {pts:6,text:"On répète l'expérience 200 fois. Combien de boules vertes peut-on espérer approximativement ?",ans:"200 × 1/2 = 100 boules vertes environ"}
     ]},
    {title:"Probabilités — Dé équilibré",notion:"Probabilités",pts:18,
     intro:"On lance un dé équilibré à 6 faces numérotées de 1 à 6.",
     questions:[
       {pts:6,text:"Quelle est la probabilité d'obtenir un nombre pair ?",ans:"Issues paires : 2, 4, 6 → P = 3/6 = 1/2"},
       {pts:6,text:"Quelle est la probabilité d'obtenir un nombre strictement supérieur à 4 ?",ans:"Issues : 5 et 6 → P = 2/6 = 1/3"},
       {pts:6,text:"On répète l'expérience 300 fois et on obtient 55 fois le chiffre 1. Commenter.",ans:"P théorique = 1/6 ≈ 16,7%. Fréquence = 55/300 ≈ 18,3%. Proche — variation aléatoire normale."}
     ]}
  ],
  proportionnalite:[
    {title:"Proportionnalité & Pourcentages",notion:"Proportionnalité",pts:20,
     intro:"Un article coûte 25 €. Le magasin propose plusieurs opérations commerciales.",
     questions:[
       {pts:7,text:"Calculer le prix de l'article après une augmentation de 14 %.",ans:"25 × 1,14 = 28,50 €"},
       {pts:7,text:"Un second article coûte 80 € avec une réduction de 20 %. Calculer son nouveau prix.",ans:"80 × 0,80 = 64 €"},
       {pts:6,text:"Un article passe de 45 € à 36 €. Calculer le taux de réduction en %.",ans:"(45−36)/45 × 100 = 20%"}
     ]},
    {title:"Proportionnalité — Agrandissement et aires",notion:"Proportionnalité",pts:20,
     intro:"Le polygone B est un agrandissement du polygone A. Coefficient d'agrandissement : 2,5. Aire de A : 7,5 cm².",
     questions:[
       {pts:7,text:"Calculer l'aire du polygone B. Rappel : si les longueurs sont multipliées par k, les aires sont multipliées par k².",ans:"Aire B = 7,5 × 2,5² = 46,875 cm²"},
       {pts:7,text:"Le périmètre de A est 12 cm. Calculer le périmètre de B.",ans:"Périmètre B = 12 × 2,5 = 30 cm"},
       {pts:6,text:"Polygone C : coefficient 0,4 par rapport à A. Calculer son aire.",ans:"Aire C = 7,5 × 0,4² = 1,2 cm²"}
     ]}
  ],
  statistiques:[
    {title:"Statistiques — Indicateurs de position",notion:"Statistiques",pts:20,
     intro:"Dans une classe de 3ème, répartition des tailles des élèves :",
     tableData:{headers:["Taille (cm)","152","157","160","162","165","170","174","180"],rows:[["Effectif","2","4","2","5","2","4","6","5"]]},
     questions:[
       {pts:8,text:"Calculer la moyenne des tailles (arrondir au dixième).",ans:"Somme = 5016. Effectif = 30. Moyenne = 167,2 cm"},
       {pts:6,text:"Déterminer la médiane.",ans:"30 élèves → entre 15e et 16e. 15e = 165 cm, 16e = 170 cm. Médiane = 167,5 cm"},
       {pts:6,text:"Calculer Q1, Q3 et l'écart interquartile.",ans:"Q1 = 8e valeur = 160 cm. Q3 = 23e valeur = 174 cm. IQR = 14 cm"}
     ]},
    {title:"Statistiques — Masses et probabilités",notion:"Statistiques",pts:19,
     intro:"5 colis (A, B, C, D, E) de masses (kg) : 4, 9, 2, 7, 11.",
     questions:[
       {pts:7,text:"Calculer la moyenne des masses.",ans:"(4+9+2+7+11)/5 = 6,6 kg"},
       {pts:6,text:"Déterminer la médiane. Interpréter.",ans:"Triées : 2,4,7,9,11. Médiane = 7 kg. La moitié des colis pèsent moins de 7 kg."},
       {pts:6,text:"Probabilité de choisir un colis de masse < 8 kg.",ans:"Colis < 8 : A(4), C(2), D(7) → P = 3/5"}
     ]}
  ],
  geometrie:[
    {title:"Géométrie — Pythagore & triangles semblables",notion:"Géométrie",pts:24,
     intro:"Triangle CDE rectangle en D. CD = 21,6 cm, CE = 29,1 cm. F est un point de [CD] avec FC = 17,2 cm et (GF) ∥ (DE).",
     figure:`<svg viewBox="0 0 300 200" xmlns="http://www.w3.org/2000/svg">
  <defs><style>text{font:12px 'DM Sans',sans-serif;fill:#0a0a0a}.lb{font-weight:700}.dim{fill:#666;font-size:11px}</style></defs>
  <polygon points="60,20 60,175 255,175" fill="rgba(0,47,167,.05)" stroke="#002FA7" stroke-width="2" stroke-linejoin="round"/>
  <rect x="60" y="157" width="18" height="18" fill="none" stroke="#002FA7" stroke-width="1.5"/>
  <text x="47" y="16" class="lb">C</text><text x="42" y="192" class="lb">D</text><text x="258" y="192" class="lb">E</text>
  <circle cx="60" cy="100" r="3.5" fill="#002FA7"/>
  <circle cx="166" cy="111" r="3.5" fill="#002FA7"/>
  <line x1="60" y1="100" x2="166" y2="111" stroke="#002FA7" stroke-width="1.5" stroke-dasharray="5,3"/>
  <text x="38" y="104" fill="#002FA7" class="lb">F</text><text x="170" y="109" fill="#002FA7" class="lb">G</text>
  <text x="19" y="105" class="dim">21,6</text><text x="130" y="192" class="dim">DE=?</text>
  <text x="95" y="107" class="dim" transform="rotate(-4 95 107)">FC=17,2</text>
</svg>`,
     questions:[
       {pts:8,text:"Montrer que DE = 19,5 cm.",ans:"DE² = CE² − CD² = 29,1² − 21,6² = 381,25. DE = 19,5 cm ✓"},
       {pts:8,text:"Calculer l'aire du triangle CDE.",ans:"Aire = (21,6 × 19,5)/2 = 210,6 cm²"},
       {pts:8,text:"(GF) ∥ (DE). Calculer GF au mm près.",ans:"GF = DE × FC/DC = 19,5 × 17,2/21,6 ≈ 15,5 cm"}
     ]},
    {title:"Géométrie — Terrain triangulaire",notion:"Géométrie",pts:21,
     intro:"Triangle ABC rectangle en B. AB = 600 m, BC = 450 m. D est sur [BC] avec CD = 270 m, E est sur [BA], (DE) ∥ (AB).",
     figure:`<svg viewBox="0 0 300 200" xmlns="http://www.w3.org/2000/svg">
  <defs><style>text{font:12px 'DM Sans',sans-serif;fill:#0a0a0a}.lb{font-weight:700}.dim{fill:#666;font-size:11px}</style></defs>
  <polygon points="60,175 60,30 270,175" fill="rgba(0,47,167,.05)" stroke="#002FA7" stroke-width="2" stroke-linejoin="round"/>
  <rect x="60" y="157" width="18" height="18" fill="none" stroke="#002FA7" stroke-width="1.5"/>
  <text x="47" y="24" class="lb">A</text><text x="42" y="192" class="lb">B</text><text x="273" y="192" class="lb">C</text>
  <circle cx="138" cy="175" r="3.5" fill="#002FA7"/><circle cx="60" cy="111" r="3.5" fill="#002FA7"/>
  <line x1="60" y1="111" x2="138" y2="175" stroke="#002FA7" stroke-width="1.5" stroke-dasharray="5,3"/>
  <text x="140" y="192" fill="#002FA7" class="lb">D</text><text x="38" y="116" fill="#002FA7" class="lb">E</text>
  <text x="19" y="107" class="dim">600 m</text><text x="95" y="192" class="dim">450 m</text>
  <text x="152" y="148" class="dim" transform="rotate(-40 152 148)">AC=750</text>
</svg>`,
     questions:[
       {pts:7,text:"Montrer que AC = 750 m.",ans:"AC² = 600² + 450² = 562500. AC = 750 m ✓"},
       {pts:7,text:"Montrer que (DE) ∥ (AB) et calculer DE.",ans:"CD/CB = 0,6. (DE) ∥ (AB). DE = 600 × 0,6 = 360 m"},
       {pts:7,text:"Calculer l'aire du triangle CDE.",ans:"Aire CDE = 135000 × 0,36 = 48600 m²"}
     ]}
  ],
  algebre:[
    {title:"Algèbre — Programme de calcul",notion:"Algèbre",pts:20,
     intro:"Voici un programme de calcul :",
     calcProgram:[{label:"Choisir un nombre",val:"x"},{label:"× (−2)",val:"×(−2)"},{label:"+ 4",val:"+ 4"},{label:"× 4",val:"× 4"},{label:"Résultat",val:"?"}],
     questions:[
       {pts:5,text:"Montrer que pour x = 1, le résultat est 8.",ans:"1×(−2)=−2. −2+4=2. 2×4=8 ✓"},
       {pts:5,text:"Résultat pour x = −2 ?",ans:"−2×(−2)=4. 4+4=8. 8×4=32"},
       {pts:5,text:"Montrer que le résultat s'écrit −8x + 16.",ans:"x → −2x → −2x+4 → 4(−2x+4) = −8x+16 ✓"},
       {pts:5,text:"Résoudre −8x + 16 = 4.",ans:"−8x = −12. x = 3/2 = 1,5"}
     ]},
    {title:"Algèbre — Rectangle et équation",notion:"Algèbre",pts:20,
     intro:"Rectangle ABCD avec AD = x et AB = 16−2x. Carré EFGH avec EF = 2x. On cherche x pour que les périmètres soient égaux.",
     figure:`<svg viewBox="0 0 320 140" xmlns="http://www.w3.org/2000/svg">
  <defs><style>text{font:12px 'DM Sans',sans-serif;fill:#0a0a0a}.lb{font-weight:700}.dim{fill:#002FA7;font-size:11px;font-weight:500}</style></defs>
  <rect x="20" y="25" width="150" height="75" fill="rgba(0,47,167,.05)" stroke="#002FA7" stroke-width="2" rx="3"/>
  <text x="18" y="19" class="lb">A</text><text x="170" y="19" class="lb">B</text><text x="170" y="118" class="lb">C</text><text x="18" y="118" class="lb">D</text>
  <text x="78" y="19" class="dim">16 − 2x</text><text x="176" y="68" class="dim">x</text>
  <rect x="230" y="25" width="75" height="75" fill="rgba(13,122,62,.06)" stroke="#0d7a3e" stroke-width="2" rx="3"/>
  <text x="228" y="19" class="lb">E</text><text x="306" y="19" class="lb">F</text><text x="306" y="118" class="lb">G</text><text x="228" y="118" class="lb">H</text>
  <text x="247" y="69" fill="#0d7a3e" style="font:11px 'DM Sans',sans-serif;font-weight:500">EF = 2x</text>
</svg>`,
     questions:[
       {pts:5,text:"Pour x = 1,5, calculer le périmètre du carré EFGH.",ans:"EF = 3 cm. Périmètre = 12 cm"},
       {pts:5,text:"Pour x = 1,5, calculer AB. Vérifier AB > 0.",ans:"AB = 13 cm > 0 ✓"},
       {pts:5,text:"Montrer que le périmètre du rectangle s'écrit −2x + 32.",ans:"P = 2(x + 16−2x) = 32−2x ✓"},
       {pts:5,text:"Trouver x pour que les deux périmètres soient égaux.",ans:"−2x+32 = 8x → x = 3,2 cm"}
     ]}
  ],
  puissances:[
    {title:"Puissances & notation scientifique",notion:"Puissances",pts:15,
     intro:"Exercice de calcul sur les puissances de 10.",
     questions:[
       {pts:5,text:"Écrire en puissance de 10 : a) 10⁴ × 10³   b) 10⁷ ÷ 10²   c) (10³)²",ans:"a) 10⁷   b) 10⁵   c) 10⁶"},
       {pts:5,text:"Écrire en notation scientifique : a) 0,000 045   b) 12 800 000",ans:"a) 4,5 × 10⁻⁵   b) 1,28 × 10⁷"},
       {pts:5,text:"Diamètre d'un atome : 2,4 × 10⁻¹⁰ m. Atomes pour couvrir 1 mm ?",ans:"N = 10⁻³ ÷ (2,4×10⁻¹⁰) ≈ 4,2 × 10⁶ atomes"}
     ]}
  ],
  pgcd:[
    {title:"Arithmétique — PGCD et lots",notion:"Arithmétique",pts:15,
     intro:"350 poissons de type A et 300 de type B à répartir en lots identiques.",
     questions:[
       {pts:5,text:"Décomposer 300 en facteurs premiers.",ans:"300 = 2² × 3 × 5²"},
       {pts:5,text:"Décomposer 350 en facteurs premiers.",ans:"350 = 2 × 5² × 7"},
       {pts:5,text:"Calculer le PGCD et le nombre maximal de lots.",ans:"PGCD = 50. Maximum 50 lots : 7 poissons A et 6 poissons B par lot."}
     ]}
  ],
  programmation:[
    {title:"Algorithmique — Deux programmes",notion:"Algorithmique",pts:20,
     intro:"Les deux programmes Scratch ci-dessous utilisent un nombre x saisi par l'utilisateur.",
     figure:`<div style="margin:14px 0">
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
    <div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--k);margin-bottom:6px">Programme A</div>
      <div class="scratch-code"><div class="scratch-hat sb-event">🏁 Quand ⚑ est cliqué</div><div class="scratch-block sb-sensor">Demander <span class="scratch-val">Choisir x</span> et attendre</div><div class="scratch-block sb-variable">Mettre <span class="scratch-oval">résA</span> à <span class="scratch-oval">(réponse × 3 + 15) ÷ 3 − réponse</span></div><div class="scratch-block sb-looks">Dire <span class="scratch-oval">résA</span></div></div>
    </div>
    <div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:#0d7a3e;margin-bottom:6px">Programme B</div>
      <div class="scratch-code"><div class="scratch-hat sb-event">🏁 Quand ⚑ est cliqué</div><div class="scratch-block sb-sensor">Demander <span class="scratch-val">Choisir x</span> et attendre</div><div class="scratch-block sb-variable">Mettre <span class="scratch-oval">résB</span> à <span class="scratch-oval">(réponse−1)×(réponse−6)+5</span></div><div class="scratch-block sb-looks">Dire <span class="scratch-oval">résB</span></div></div>
    </div>
  </div>
</div>`,
     questions:[
       {pts:5,text:"Montrer que pour x = 4, A donne 5.",ans:"4×3=12. 12+15=27. 27÷3=9. 9−4=5 ✓"},
       {pts:5,text:"Justifier que A donne toujours le même résultat.",ans:"x → 3x → 3x+15 → x+5 → x+5−x = 5 ✓"},
       {pts:5,text:"Pour x = 10, quel résultat donne B ?",ans:"(10−1)×(10−6)+5 = 9×4+5 = 41"},
       {pts:5,text:"Trouver les deux valeurs pour lesquelles A = B.",ans:"x²−7x+6=0 → x=1 ou x=6"}
     ]}
  ],
  volumes:[
    {title:"Volumes — Aquariums",notion:"Volumes",pts:18,
     intro:"Il faut ≥ 15 L par poisson. Aquariums remplis aux 4/5 de leur hauteur.",
     questions:[
       {pts:7,text:"Aquarium cylindrique : ∅ 30 cm, h = 25 cm. Volume d'eau ? Suffisant ?",ans:"V eau = π×15²×25×(4/5) ≈ 14137 cm³ ≈ 14,1 L < 15 L — insuffisant."},
       {pts:7,text:"Aquarium pavé droit 28×28×30 cm. Volume d'eau ? Convient-il ?",ans:"V eau = 23520 × 0,8 = 18816 cm³ = 18,8 L > 15 L — convient ✓"},
       {pts:4,text:"Poisson : 15 €, aquarium : 40 €. Remise de 15%. Prix final ?",ans:"Total = 55 €. Remise = 8,25 €. Prix = 46,75 €"}
     ]}
  ],

  // ═══════════ NOUVEAUX EXERCICES DNB 2023 + DNB Amérique du Nord mai 2024 ═══════════

  probabilites2023:[
    {title:"Probabilités — Jeu de 32 cartes",notion:"Probabilités",pts:20,
     intro:"Un jeu de 32 cartes comprend 4 familles (trèfle, carreau, cœur, pique), chacune avec 8 cartes : 7, 8, 9, 10, valet, dame, roi, as. On tire une carte au hasard.",
     questions:[
       {pts:6,text:"Quelle est la probabilité d'obtenir le 8 de pique ?",ans:"1 carte sur 32. P(8 de pique) = 1/32"},
       {pts:8,text:"Quelle est la probabilité d'obtenir un roi ou un cœur ? Justifier.",ans:"4 rois + 8 cœurs − 1 roi de cœur = 11 cartes. P = 11/32"},
       {pts:6,text:"On pioche une carte, on la remet, puis on pioche une seconde. Probabilité d'obtenir deux rois ?",ans:"P(roi) = 4/32 = 1/8. Tirages indépendants → P(deux rois) = 1/8 × 1/8 = 1/64"}
     ]},
    {title:"Probabilités — Urne boules noires et rouges",notion:"Probabilités",pts:22,
     intro:"Une urne contient 3 boules noires (numérotées 1 à 3) et 4 boules rouges (numérotées 1 à 4), toutes indiscernables au toucher. — DNB Centres étrangers juin 2023",
     questions:[
       {pts:6,text:"On pioche une boule. Quelle est la probabilité de tirer une boule rouge ?",ans:"P(rouge) = 4/7"},
       {pts:6,text:"Quelle est la probabilité de tirer une boule portant un nombre pair ?",ans:"Pairs : noire 2, rouges 2 et 4 → 3 boules paires sur 7. P = 3/7"},
       {pts:10,text:"On pioche une boule, on la remet, puis on pioche une seconde. On gagne en tirant la boule rouge n°1 ET une boule noire. Quelle est la probabilité de gagner ?",ans:"P(rouge1 puis noire) = 1/7 × 3/7 = 3/49. P(noire puis rouge1) = 3/7 × 1/7 = 3/49. P(gagner) = 6/49"}
     ]},
    {title:"Probabilités — Sac de boules et roue numérotée",notion:"Probabilités",pts:18,
     intro:"Jeu 1 : sac de 5 boules (1 N, 2 G, 2 P). Jeu 2 : roue à 6 secteurs égaux numérotés 1 à 6. — DNB Polynésie juin 2023",
     questions:[
       {pts:5,text:"Jeu 1 : montrer que la probabilité de tirer G est 2/5.",ans:"2 boules G sur 5 au total → P(G) = 2/5 ✓"},
       {pts:5,text:"Jeu 2 : quelle est la probabilité de s'arrêter sur un nombre premier ?",ans:"Nombres premiers de 1 à 6 : 2, 3, 5 → 3 secteurs sur 6. P = 3/6 = 1/2"},
       {pts:8,text:"Jeu combiné : on tire une boule ET on tourne la roue. On gagne si G et un nombre premier. Probabilité de gagner ?",ans:"Événements indépendants. P = 2/5 × 1/2 = 1/5"}
     ]},
    {title:"Probabilités — Roue et urne, nombres à deux chiffres",notion:"Probabilités",pts:20,
     intro:"Une roue à 4 secteurs égaux (1,2,3,4) donne le chiffre des dizaines. Une urne avec 3 boules (2,3,4) donne le chiffre des unités. — DNB Amérique du Sud nov. 2023",
     questions:[
       {pts:5,text:"Écrire la liste des 12 issues possibles.",ans:"12, 13, 14, 22, 23, 24, 32, 33, 34, 42, 43, 44"},
       {pts:5,text:"Quelle est la probabilité d'obtenir un nombre impair ?",ans:"Unités impaires = 3 → issues : 13, 23, 33, 43 → 4 issues. P = 4/12 = 1/3"},
       {pts:5,text:"Probabilité que le nombre formé soit un nombre premier inférieur à 30 ?",ans:"Nombres premiers parmi les issues : 13, 23 → 2 issues. P = 2/12 = 1/6"},
       {pts:5,text:"Montrer que la probabilité d'obtenir un multiple de 11 est 0,25.",ans:"Multiples de 11 parmi les issues : 22, 33, 44 → 3 issues. P = 3/12 = 1/4 = 0,25 ✓"}
     ]},
    {title:"Probabilités — Urne 15 boules numérotées",notion:"Probabilités",pts:20,
     intro:"Une urne contient 15 boules indiscernables numérotées de 1 à 15. — DNB Amérique du Nord mai 2024",
     questions:[
       {pts:8,text:"L'affirmation 'la probabilité de tirer un nombre premier est 7/15' est-elle vraie ? Justifier.",ans:"Nombres premiers de 1 à 15 : 2,3,5,7,11,13 → 6 nombres (1 n'est pas premier). P = 6/15 = 2/5. L'affirmation est FAUSSE."},
       {pts:6,text:"Calculer la probabilité de tirer un multiple de 3.",ans:"Multiples de 3 de 1 à 15 : 3,6,9,12,15 → 5 boules. P = 5/15 = 1/3"},
       {pts:6,text:"L'affirmation 'l'aire du triangle A'B'C' est 3 fois celle du triangle ABC' (homothétie de rapport −3) est-elle vraie ?",ans:"Rapport de l'homothétie = −3, donc les longueurs sont multipliées par 3. Les aires sont multipliées par 3² = 9. L'affirmation est FAUSSE (facteur 9, pas 3)."}
     ]}
  ],

  statistiques2023:[
    {title:"Statistiques — Prix des hôtels, moyenne et médiane",notion:"Statistiques",pts:20,
     intro:"Prix facturés pour une nuit dans les hôtels d'une ville — DNB Amérique du Nord, 31 mai 2023",
     tableData:{headers:["Prix/nuit (€)","60","80","85","90","110","120","350","500"],rows:[["Effectif","1200","1350","1000","1100","1200","1300","900","300"]]},
     questions:[
       {pts:5,text:"Déterminer l'étendue des prix facturés.",ans:"Étendue = 500 − 60 = 440 €"},
       {pts:8,text:"Calculer la moyenne des prix facturés pour une nuit (arrondir à l'euro près).",ans:"Somme pondérée = 60×1200+80×1350+85×1000+90×1100+110×1200+120×1300+350×900+500×300 = 972 000. Effectif total = 8350. Moyenne ≈ 116 €"},
       {pts:7,text:"L'association affirme : 'au moins la moitié des nuits est facturée à moins de 100 €'. Est-ce vrai ?",ans:"Effectifs ≤ 90 € : 1200+1350+1000+1100 = 4650 sur 8350 total ≈ 55,7 % > 50 %. VRAI ✓"}
     ]},
    {title:"Statistiques — Ventes de pots de glace",notion:"Statistiques",pts:24,
     intro:"Pots de glace vendus en juillet–août 2022 — DNB Asie, 19 juin 2023",
     tableData:{headers:["","Sem. 1","Sem. 2","Sem. 3","Sem. 4"],rows:[["Juillet","453","649","786","854"],["Août","860","1003","957","838"]]},
     questions:[
       {pts:8,text:"Calculer le nombre moyen de pots vendus par semaine sur les 8 semaines.",ans:"Total = 453+649+786+854+860+1003+957+838 = 6400. Moyenne = 6400/8 = 800 pots/semaine"},
       {pts:8,text:"67 % des pots sont à 1 boule (2,80 €), les autres à 2 boules (3,50 €). Calculer la somme rapportée par la vente.",ans:"Pots 1 boule : 0,67×6400 = 4288 → 4288×2,80 = 12 006,40 €. Pots 2 boules : 2112 → 2112×3,50 = 7 392 €. Total = 19 398,40 €"},
       {pts:8,text:"Montrer que le volume d'une boule de glace de diamètre 4,2 cm est d'environ 39 cm³. (V = 4/3 × π × r³)",ans:"r = 2,1 cm. V = 4/3 × π × 2,1³ = 4/3 × π × 9,261 ≈ 38,79 cm³ ≈ 39 cm³ ✓"}
     ]},
    {title:"Statistiques — Entrées à la piscine",notion:"Statistiques",pts:22,
     intro:"Entrées mensuelles à la piscine sur une année — DNB Métropole, 18 septembre 2023",
     tableData:{headers:["Mois","Jan","Fév","Mar","Avr","Mai","Jui","Jul","Aoû","Sep","Oct","Nov","Déc"],rows:[["Entrées","12500","13700","10400","13600","12300","11700","10400","11600","10200","13800","12600","11800"]]},
     questions:[
       {pts:7,text:"Calculer le nombre moyen d'entrées par mois.",ans:"Total = 144 600. Moyenne = 144 600 / 12 = 12 050 entrées/mois"},
       {pts:7,text:"Calculer l'étendue du nombre d'entrées par mois.",ans:"Max = 13 800 (oct.). Min = 10 200 (sep.). Étendue = 3 600"},
       {pts:8,text:"La piscine est un pavé droit de 50 m × 25 m × 3 m. Calculer le volume d'eau évacué lors d'une vidange complète.",ans:"V = 50 × 25 × 3 = 3 750 m³"}
     ]},
    {title:"Statistiques — Lunettes de soleil et prix moyen",notion:"Statistiques",pts:20,
     intro:"5 modèles de lunettes vendus en 2022 — DNB Métropole Antilles-Guyane, 26 juin 2023",
     tableData:{headers:["Modèle","1","2","3","4","5"],rows:[["Paires vendues","1200","950","875","250","300"],["Prix unit. (€)","75","100","110","140","160"]]},
     questions:[
       {pts:5,text:"Montrer que l'étendue des prix est de 85 €.",ans:"Étendue = 160 − 75 = 85 € ✓"},
       {pts:7,text:"Calculer le nombre total de paires vendues en 2022.",ans:"Total = 1200+950+875+250+300 = 3 575 paires"},
       {pts:8,text:"Calculer le montant total des ventes et le prix moyen par paire (arrondi au centime).",ans:"Ventes = 1200×75+950×100+875×110+250×140+300×160 = 364 250 €. Prix moyen = 364 250/3575 ≈ 101,89 €"}
     ]},
    {title:"Statistiques — Prix vêtements, moyenne et médiane",notion:"Statistiques",pts:20,
     intro:"Prix d'un vêtement dans différents magasins (€) : 12 ; 15 ; 10 ; 7 ; 13 — DNB Amérique du Nord, 29 mai 2024",
     questions:[
       {pts:7,text:"La moyenne est-elle 11,40 € ? Justifier.",ans:"Moyenne = (7+10+12+13+15)/5 = 57/5 = 11,40 €. VRAIE ✓"},
       {pts:7,text:"La médiane est-elle 10 € ? Justifier.",ans:"Valeurs triées : 7, 10, 12, 13, 15. 3e valeur = 12 €. L'affirmation 'médiane = 10' est FAUSSE."},
       {pts:6,text:"Quelle est l'étendue des prix ?",ans:"Étendue = 15 − 7 = 8 €"}
     ]}
  ],

  geometrie2023:[
    {title:"Géométrie — Triangle LNA et triangles semblables",notion:"Géométrie",pts:22,
     intro:"AN = 13 cm, LN = 5 cm, AL = 12 cm, ON = 3 cm. O ∈ [LN], H ∈ [NA]. Triangles LNA et ONH semblables. — DNB Amérique du Nord, 31 mai 2023",
     questions:[
       {pts:5,text:"Montrer que le triangle LNA est rectangle en L.",ans:"LN² + AL² = 25 + 144 = 169 = 13² = AN². Par réciproque de Pythagore, LNA est rectangle en L ✓"},
       {pts:7,text:"Montrer que OH = 7,2 cm.",ans:"Triangles semblables LNA et ONH : ON/LN = OH/AL → 3/5 = OH/12 → OH = 7,2 cm ✓"},
       {pts:10,text:"Calculer l'angle LNA (à l'unité). Calculer l'aire du quadrilatère LOHA et sa proportion par rapport à l'aire du triangle LNA.",ans:"sin(LNA) = AL/AN = 12/13 → angle LNA ≈ 67°. Aire LNA = (5×12)/2 = 30 cm². Aire ONH = (3×7,2)/2 = 10,8 cm². Aire LOHA = 30 − 10,8 = 19,2 cm². Proportion = 19,2/30 = 64 %"}
     ]},
    {title:"Géométrie — Triangles semblables EGF et LGH",notion:"Géométrie",pts:20,
     intro:"EF=18 cm, FG=24 cm, EG=30 cm, GH=38,4 cm. (LH)⊥(FH). Angle EGF = angle LGH. — DNB Amérique du Sud, nov. 2023",
     questions:[
       {pts:5,text:"Montrer que le triangle EFG est rectangle en F.",ans:"EF²+FG² = 324+576 = 900 = 30² = EG². Par réciproque de Pythagore, EFG rectangle en F ✓"},
       {pts:5,text:"Calculer l'angle EGF (au degré près).",ans:"cos(EGF) = FG/EG = 24/30 = 0,8 → angle EGF ≈ 37°"},
       {pts:5,text:"Montrer que les triangles EGF et LGH sont semblables.",ans:"Angle EGF = Angle LGH (données). Angle EFG = Angle LHG = 90°. Deux angles égaux → triangles semblables ✓"},
       {pts:5,text:"Calculer le coefficient d'agrandissement de EGF vers LGH puis le périmètre de LGH.",ans:"k = GH/GF = 38,4/24 = 1,6. LH = 18×1,6 = 28,8 cm. LG = 30×1,6 = 48 cm. Périmètre = 28,8+38,4+48 = 115,2 cm"}
     ]},
    {title:"Géométrie — Piste d'hippodrome",notion:"Géométrie",pts:18,
     intro:"La piste est composée de 2 segments de 850 m et 2 demi-cercles de rayon 40 m. — DNB Amérique du Nord, 31 mai 2023",
     questions:[
       {pts:5,text:"Montrer que la longueur d'un tour de piste est d'environ 1 951 m.",ans:"Droites = 2×850 = 1700 m. Cercle = 2π×40 ≈ 251,3 m. Total ≈ 1 951 m ✓"},
       {pts:7,text:"Un cheval parcourt un tour en 2 min 9 s. Calculer sa vitesse en m/s (à l'unité) puis en km/h.",ans:"Durée = 129 s. v = 1951/129 ≈ 15 m/s. En km/h : 15 × 3,6 = 54 km/h"},
       {pts:6,text:"Aire de la piste ≈ 73 027 m². Marque A : 500 m²/sac à 141,95 €. Marque B : 400 m²/sac à 87,90 €. Marque C : 300 m²/sac à 66,50 €. Quelle marque choisir pour un coût minimum ?",ans:"Sacs A : ⌈73027/500⌉=147 → 147×141,95≈20 867 €. Sacs B : ⌈73027/400⌉=183 → 183×87,90≈16 086 €. Sacs C : ⌈73027/300⌉=244 → 244×66,50≈16 226 €. Choisir la marque B."}
     ]},
    {title:"Géométrie — Triangle équilatéral et Scratch",notion:"Géométrie",pts:19,
     intro:"Triangle ABC équilatéral, AB = 240 mm. Point C sur [AE] avec CE = 80 mm. (DE)∥(AB). — DNB Amérique du Nord, 29 mai 2024",
     questions:[
       {pts:7,text:"Montrer que le triangle ABC est équilatéral.",ans:"Angle ACB = 60° et les codages montrent AB = BC. Triangle isocèle avec angle au sommet 60° → tous les angles valent 60° → triangle équilatéral ✓"},
       {pts:6,text:"Montrer que les droites (DE) et (AB) sont parallèles.",ans:"D ∈ [BC], E ∈ [AC], et CE/CA = DE/AB (les codages montrent CE = 80 = AB/3). Par la réciproque du théorème de Thalès dans le triangle CAB, (DE)∥(AB) ✓"},
       {pts:6,text:"Dans le programme Scratch, la variable côté prend la valeur 240 pour le grand triangle, puis côté/3 pour le petit. Expliquer et calculer le côté du petit triangle.",ans:"CE = 80 mm = 240/3 mm. Le petit triangle CDE est une réduction de rapport 1/3. côté/3 = 240/3 = 80 mm."}
     ]},
    {title:"Géométrie — Escalier et trigonométrie",notion:"Géométrie",pts:20,
     intro:"Escalier de hauteur totale 272 cm. Hauteur d'une marche = 17 cm. Profondeur = 27 cm. — DNB Métropole Antilles-Guyane, 26 juin 2023",
     questions:[
       {pts:5,text:"Montrer qu'il faut prévoir 16 marches.",ans:"272 ÷ 17 = 16 marches exactement ✓"},
       {pts:5,text:"Montrer que la longueur de la base AB est 432 cm.",ans:"16 × 27 = 432 cm ✓"},
       {pts:10,text:"Calculer l'angle BAC (au degré près). L'escalier permet-il une montée agréable (25° à 40°) ?",ans:"tan(BAC) = BC/AB = 272/432 ≈ 0,630 → angle BAC ≈ 32°. 25° < 32° < 40° → montée agréable ✓"}
     ]},
    {title:"Géométrie — Terrasse en béton",notion:"Géométrie",pts:21,
     intro:"Terrasse en L : EFGH rectangle (HG=10 m, EH=6 m). Un coin (3m × 4m) est découpé. Hauteur de la terrasse : 15 cm = 0,15 m. — DNB Amérique du Nord, 29 mai 2024",
     questions:[
       {pts:5,text:"Montrer que FJ = 4 m.",ans:"EF = HG = 10 m. EJ = EH − JH = 6 m correspond à la largeur totale de la partie rectangulaire. La partie découpée a IJ = 15 cm. Vue de dessus : FJ = HG − partie restante. EJ = 6 m → FJ = 10 − 6 = 4 m ✓"},
       {pts:8,text:"Calculer la longueur minimale de planches à acheter (périmètre de la terrasse).",ans:"Périmètre = 10 + 6 + 4 + 3 + 6 + 3 = 32 m"},
       {pts:8,text:"Montrer que le volume de la terrasse est inférieur à 4 m³.",ans:"Aire = 10×6 − 4×3 = 60 − 12 = 48 m². V = 48 × 0,15 = 7,2 m³. En réalité la forme L : (6×3)+(4×6) = 18+24=42 m² ou le calcul direct en lisant la figure. V = 42×0,15 = 6,3 m³ > 4 m³ → les 4 m³ commandés ne suffisent pas pour la terrasse complète."}
     ]}
  ],

  algebre2023:[
    {title:"Algèbre — Deux programmes de calcul (Amir & Sonia)",notion:"Algèbre",pts:15,
     intro:"Voici les deux programmes de calcul utilisés dans cet exercice.",
     figure:`<div style="margin:14px 0">
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
    <div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--k);margin-bottom:6px">Programme Amir</div>
      <div class="scratch-code"><div class="scratch-block sb-sensor">Demander <span class="scratch-val">x =</span> et attendre</div><div class="scratch-block sb-variable">Mettre <span class="scratch-oval">n</span> à <span class="scratch-oval">réponse − 5</span></div><div class="scratch-block sb-variable">Mettre <span class="scratch-oval">n</span> à <span class="scratch-oval">n × 2</span></div><div class="scratch-block sb-looks">Dire <span class="scratch-oval">n</span></div></div>
    </div>
    <div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:#0d7a3e;margin-bottom:6px">Programme Sonia</div>
      <div class="scratch-code"><div class="scratch-block sb-sensor">Demander <span class="scratch-val">x =</span> et attendre</div><div class="scratch-block sb-variable">Mettre <span class="scratch-oval">n</span> à <span class="scratch-oval">réponse + 3</span></div><div class="scratch-block sb-variable">Mettre <span class="scratch-oval">n</span> à <span class="scratch-oval">n × réponse</span></div><div class="scratch-block sb-variable">Mettre <span class="scratch-oval">n</span> à <span class="scratch-oval">n − 16</span></div><div class="scratch-block sb-looks">Dire <span class="scratch-oval">n</span></div></div>
    </div>
  </div>
</div>`,
     questions:[
       {pts:5,text:"Montrer que pour x=6, Amir donne 2 et Sonia donne 38.",ans:"Amir : (6−5)×2 = 2 ✓. Sonia : (6+3)×6 − 16 = 54−16 = 38 ✓"},
       {pts:5,text:"D'après le tableau de valeurs, pour quel nombre les deux programmes donnent-ils le même résultat ?",ans:"Pour x=2 : Amir = −6 et Sonia = −6. Les deux programmes sont égaux pour x = 2 (et x = −3)."},
       {pts:5,text:"Montrer que le résultat de Sonia s'écrit x² + 3x − 16. Résoudre (x−2)(x+3) = 0.",ans:"Sonia : (x+3)×x − 16 = x²+3x−16 ✓. (x−2)(x+3)=0 → x=2 ou x=−3"}
     ]},
    {title:"Algèbre — Fonctions affines et tarifs cinéma",notion:"Algèbre",pts:20,
     intro:"Tarif Classique : h(x)=11x. Tarif Essentiel : f(x)=50+5x. Tarif Liberté : g(x)=240. — DNB Amérique du Nord, 29 mai 2024",
     questions:[
       {pts:5,text:"Avec le tarif Classique, quel est le prix pour 3 entrées ?",ans:"h(3) = 11×3 = 33 €"},
       {pts:5,text:"Montrer qu'avec le tarif Essentiel, aller 8 fois au cinéma coûte 90 €.",ans:"f(8) = 50+5×8 = 90 € ✓"},
       {pts:5,text:"Quel tarif donne un prix proportionnel au nombre d'entrées ? Justifier.",ans:"Tarif Classique : h(x)=11x est une fonction linéaire → prix proportionnel au nombre d'entrées."},
       {pts:5,text:"À partir de combien d'entrées le tarif Liberté est-il le plus intéressant par rapport au tarif Essentiel ?",ans:"240 < 50+5x → 5x > 190 → x > 38. Le tarif Liberté est plus intéressant à partir de 39 entrées."}
     ]},
    {title:"Algèbre — Tarifs piscine et équation",notion:"Algèbre",pts:22,
     intro:"Tarif A : 5,90 €/entrée. Tarif B : 30 € abonnement + 4,40 €/entrée. — DNB Métropole, 18 sept. 2023",
     questions:[
       {pts:6,text:"Calculer le prix pour 10 entrées avec chaque tarif.",ans:"Tarif A : 5,90×10 = 59 €. Tarif B : 4,40×10+30 = 74 €"},
       {pts:8,text:"Résoudre 5,90x = 4,40x + 30. Quel est le nombre d'entrées pour lequel les tarifs sont égaux ?",ans:"1,50x = 30 → x = 20 entrées"},
       {pts:8,text:"Pour x < 20, quel tarif est le moins cher ? Pour x > 20 ?",ans:"x < 20 (ex. 10 entrées) : A=59€ < B=74€ → tarif A. x > 20 (ex. 30 entrées) : A=177€ > B=162€ → tarif B."}
     ]},
    {title:"Algèbre — Programme de calcul 10x²",notion:"Algèbre",pts:20,
     intro:"Voici le programme Scratch utilisé dans cet exercice.",
     figure:`<div style="margin:14px 0">
  <div class="scratch-code"><div class="scratch-hat sb-event">🏁 Quand ⚑ est cliqué</div><div class="scratch-block sb-sensor">Demander <span class="scratch-val">Entrer x</span> et attendre</div><div class="scratch-block sb-variable">Mettre <span class="scratch-oval">n</span> à <span class="scratch-oval">réponse × réponse</span></div><div class="scratch-block sb-variable">Mettre <span class="scratch-oval">n</span> à <span class="scratch-oval">n × 5</span></div><div class="scratch-block sb-variable">Mettre <span class="scratch-oval">n</span> à <span class="scratch-oval">n + 4</span></div><div class="scratch-block sb-variable">Mettre <span class="scratch-oval">n</span> à <span class="scratch-oval">n × 2</span></div><div class="scratch-block sb-variable">Mettre <span class="scratch-oval">n</span> à <span class="scratch-oval">n − 8</span></div><div class="scratch-block sb-looks">Dire <span class="scratch-oval">n</span></div></div>
  <div style="margin-top:8px;padding:10px 14px;background:#f0f0f0;border-radius:6px;font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:#555">
    x² → ×5 → +4 → ×2 → −8 = <span style="color:var(--k)">10x²</span>
  </div>
</div>`,
     questions:[
       {pts:5,text:"Montrer que pour x=3, le résultat est 90.",ans:"3²=9 → ×5=45 → +4=49 → ×2=98 → −8=90 ✓"},
       {pts:5,text:"Montrer que pour x=2 et x=−2, on obtient le même résultat.",ans:"(−2)²=4 = 2² → mêmes calculs ensuite → même résultat 40 ✓"},
       {pts:5,text:"Montrer que le résultat du programme s'écrit 10x².",ans:"x → x² → 5x² → 5x²+4 → 10x²+8 → 10x²+8−8 = 10x² ✓"},
       {pts:5,text:"Trouver la valeur exacte de l'antécédent positif de 30 par f(x)=10x².",ans:"10x²=30 → x²=3 → x=√3 (valeur exacte)"}
     ]},
    {title:"Algèbre — Programme de calcul, factorisation (2024)",notion:"Algèbre",pts:20,
     intro:"Le programme Scratch ci-dessous comporte deux branches. Il calcule le produit des deux résultats.",
     figure:`<div style="margin:14px 0">
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
    <div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--k);margin-bottom:6px">Branche 1</div>
      <div class="scratch-code"><div class="scratch-block sb-variable">Mettre <span class="scratch-oval">b1</span> à <span class="scratch-oval">(x + 2) × 4</span></div></div>
    </div>
    <div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:#0d7a3e;margin-bottom:6px">Branche 2</div>
      <div class="scratch-code"><div class="scratch-block sb-variable">Mettre <span class="scratch-oval">b2</span> à <span class="scratch-oval">x × 5 − 3</span></div></div>
    </div>
  </div>
  <div class="scratch-code"><div class="scratch-hat sb-event">🏁 Quand ⚑ est cliqué</div><div class="scratch-block sb-sensor">Demander <span class="scratch-val">Entrer x</span> et attendre</div><div class="scratch-block sb-variable">Mettre <span class="scratch-oval">résultat</span> à <span class="scratch-oval">b1 × b2</span></div><div class="scratch-block sb-looks">Dire <span class="scratch-oval">résultat</span></div></div>
</div>`,
     questions:[
       {pts:5,text:"Montrer que pour x=2, le résultat est 112.",ans:"Branche 1 : (2+2)×4=16. Branche 2 : 2×5−3=7. 16×7=112 ✓"},
       {pts:5,text:"Quel résultat pour x=−3 ?",ans:"Branche 1 : (−3+2)×4=−4. Branche 2 : −3×5−3=−18. Résultat = (−4)×(−18) = 72"},
       {pts:5,text:"Quelle expression traduit correctement ce programme parmi A:(x+2×4)(x×5−3), B:(4x+2)(5x−3), C:(4x+8)(5x−3) ?",ans:"L'expression correcte est C : (4x+8)(5x−3) = 4(x+2)(5x−3). C et D = (x+2)×4×(5x−3) sont correctes."},
       {pts:5,text:"Développer et réduire (4x+8)(5x−3). Trouver les deux valeurs donnant 0.",ans:"20x²−12x+40x−24 = 20x²+28x−24. Pour 0 : 4x+8=0 → x=−2 ou 5x−3=0 → x=3/5"}
     ]},
    {title:"Algèbre — Programmes A et B, fonctions affines",notion:"Algèbre",pts:20,
     intro:"Les programmes A et B sont réalisés avec Scratch. Ils correspondent aux fonctions affines f et g représentées graphiquement.",
     figure:`<div style="margin:14px 0">
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
    <div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--k);margin-bottom:6px">Programme A — f(x) = −2x+5</div>
      <div class="scratch-code"><div class="scratch-block sb-sensor">Demander <span class="scratch-val">x =</span> et attendre</div><div class="scratch-block sb-variable">Mettre <span class="scratch-oval">n</span> à <span class="scratch-oval">réponse × (−2)</span></div><div class="scratch-block sb-variable">Mettre <span class="scratch-oval">n</span> à <span class="scratch-oval">n + 5</span></div><div class="scratch-block sb-looks">Dire <span class="scratch-oval">n</span></div></div>
    </div>
    <div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:#0d7a3e;margin-bottom:6px">Programme B — g(x) = 3x−4</div>
      <div class="scratch-code"><div class="scratch-block sb-sensor">Demander <span class="scratch-val">x =</span> et attendre</div><div class="scratch-block sb-variable">Mettre <span class="scratch-oval">n</span> à <span class="scratch-oval">réponse − 5</span></div><div class="scratch-block sb-variable">Mettre <span class="scratch-oval">n</span> à <span class="scratch-oval">n × 3</span></div><div class="scratch-block sb-variable">Mettre <span class="scratch-oval">n</span> à <span class="scratch-oval">n + 11</span></div><div class="scratch-block sb-looks">Dire <span class="scratch-oval">n</span></div></div>
    </div>
  </div>
</div>`,
     questions:[
       {pts:5,text:"Montrer que pour x=−3, le programme A donne 11.",ans:"(−3)×(−2)+5 = 6+5 = 11 ✓"},
       {pts:5,text:"Montrer que le résultat du programme B s'écrit 3x−4.",ans:"(x−5)×3+11 = 3x−15+11 = 3x−4 ✓"},
       {pts:5,text:"Les fonctions f(x)=−2x+5 et g(x)=3x−4 sont tracées. Par lecture graphique, donner la valeur pour laquelle f(x)=g(x).",ans:"D'après le graphique, les deux droites se croisent pour x ≈ 1,8"},
       {pts:5,text:"Calculer précisément le nombre de départ pour lequel les programmes A et B donnent le même résultat.",ans:"−2x+5 = 3x−4 → −5x = −9 → x = 9/5 = 1,8"}
     ]}
  ],

  proportionnalite2023:[
    {title:"Proportionnalité — Visiteurs d'un site touristique",notion:"Proportionnalité",pts:20,
     intro:"Site touristique : 187 216 visiteurs en 2020, 219 042 en 2021. Objectif du maire : +15 % minimum. — DNB Amérique du Nord, 31 mai 2023",
     questions:[
       {pts:7,text:"Calculer le taux d'évolution entre 2020 et 2021. L'objectif a-t-il été atteint ?",ans:"Taux = (219042−187216)/187216 × 100 ≈ 17 %. Objectif 15 % atteint ✓"},
       {pts:7,text:"Si la progression se poursuit à +17 % par an, combien de visiteurs en 2022 ?",ans:"219042 × 1,17 ≈ 256 279 visiteurs"},
       {pts:6,text:"Le coefficient d'agrandissement du polygone 2 par rapport au polygone 1 est 3. Aire du polygone 1 = 11 cm². Calculer l'aire du polygone 2.",ans:"L'aire est multipliée par k²=9. Aire polygone 2 = 11×9 = 99 cm²"}
     ]}
  ],

  arithmetique2023:[
    {title:"Arithmétique — PGCD paniers de légumes",notion:"Arithmétique",pts:18,
     intro:"José dispose de 39 salades (3×13), 78 carottes et 51 aubergines. Il veut des paniers identiques utilisant tous les légumes. — DNB Nouvelle-Calédonie, déc. 2023",
     questions:[
       {pts:6,text:"Décomposer 78 et 51 en produit de facteurs premiers.",ans:"78 = 2×3×13. 51 = 3×17"},
       {pts:6,text:"Calculer le PGCD(39,78,51) et en déduire le nombre maximal de paniers.",ans:"PGCD(39,78)=39. PGCD(39,51)=3. PGCD(39,78,51)=3. Maximum 3 paniers."},
       {pts:6,text:"José fait 13 paniers. Combien d'aubergines par panier ? Combien sans panier ?",ans:"51÷13=3 reste 12. Chaque panier : 3 aubergines. 12 aubergines non utilisées → il faut en cueillir 1 de plus."}
     ]},
    {title:"Arithmétique — PGCD lots figurines et autocollants",notion:"Arithmétique",pts:22,
     intro:"195 figurines et 234 autocollants (234=2×3²×13). Lots identiques, tout doit être utilisé. — DNB Centres étrangers, 14 juin 2023",
     questions:[
       {pts:6,text:"Peut-on faire 3 lots identiques ? Justifier.",ans:"195÷3=65 ✓. 234÷3=78 ✓. Oui, 3 est un diviseur commun."},
       {pts:8,text:"Décomposer 195 en facteurs premiers. Calculer PGCD(195,234).",ans:"195 = 3×5×13. PGCD(195,234) = 3×13 = 39"},
       {pts:8,text:"Nombre maximal de lots ? Composition de chaque lot ?",ans:"Nombre max = 39 lots. Figurines/lot = 195/39 = 5. Autocollants/lot = 234/39 = 6."}
     ]},
    {title:"Arithmétique — PPCM course de karting",notion:"Arithmétique",pts:22,
     intro:"Un professionnel fait un tour en 60 s, un amateur en 72 s. Ils partent ensemble. — DNB Polynésie, 23 juin 2023",
     questions:[
       {pts:7,text:"Décomposer 60 et 72 en produit de facteurs premiers.",ans:"60 = 2²×3×5. 72 = 2³×3²"},
       {pts:8,text:"Au bout de combien de secondes se retrouveront-ils ensemble pour la première fois ?",ans:"PPCM(60,72) = 2³×3²×5 = 360 s = 6 minutes"},
       {pts:7,text:"Combien de tours chacun aura-t-il effectués ?",ans:"Professionnel : 360/60 = 6 tours. Amateur : 360/72 = 5 tours"}
     ]},
    {title:"Arithmétique — Décomposition et baguettes",notion:"Arithmétique",pts:16,
     intro:"Nombre de baguettes et prix (1→1,10€, 2→2,20€, 3→3,30€, 4→4€). Engrenage : roue A à 8 dents, roue B à 12 dents. — DNB Amérique du Sud, nov. 2023",
     questions:[
       {pts:5,text:"Le prix est-il proportionnel au nombre de baguettes ? Justifier.",ans:"Pour 4 baguettes : 4€ ≠ 4×1,10€ = 4,40€. Le rapport n'est pas constant → pas de proportionnalité. FAUX."},
       {pts:5,text:"L'engrenage sera-t-il dans la même position au bout de 6 tours pour la roue A et 4 tours pour la roue B ?",ans:"6×8 = 48 dents pour A. 4×12 = 48 dents pour B. Même nombre de dents engrenées → VRAI ✓"},
       {pts:6,text:"Décomposer 780 en produit de facteurs premiers.",ans:"780 = 2²×3×5×13"}
     ]}
  ],

  volumes2023:[
    {title:"Volumes — Bac à sable sous cabane",notion:"Volumes",pts:24,
     intro:"Bac à sable (pavé droit) : 200 cm × 180 cm × 20 cm. Volume = 0,72 m³. Mélange sable maçonner/sable fin ratio 3:2. — DNB Centres étrangers, 14 juin 2023",
     questions:[
       {pts:6,text:"Calculer le volume du bac en cm³.",ans:"V = 200×180×20 = 720 000 cm³"},
       {pts:8,text:"Vérifier que le volume de sable à maçonner est 0,432 m³ et de sable fin 0,288 m³.",ans:"Ratio 3:2 → 5 parts. Maçonner = 3/5×0,72 = 0,432 m³ ✓. Fin = 2/5×0,72 = 0,288 m³ ✓"},
       {pts:10,text:"Sacs maçonner : 35 kg / 0,022 m³ / 2,95 €. Sacs fin : 25 kg / 0,016 m³ / 5,95 €. Calculer le coût total (sacs entiers).",ans:"Sacs maçonner : ⌈0,432/0,022⌉=20 → 20×2,95=59 €. Sacs fin : ⌈0,288/0,016⌉=18 → 18×5,95=107,10 €. Total = 166,10 €"}
     ]},
    {title:"Volumes — Béton et ratio de mélange",notion:"Volumes",pts:21,
     intro:"4 m³ de béton à réaliser. Ratio ciment:gravier:sable = 2:7:5. 1 m³ nécessite 250 kg de ciment. Surface à peindre = 48 m². — DNB Amérique du Nord, 29 mai 2024",
     questions:[
       {pts:7,text:"Calculer la masse de ciment nécessaire pour 4 m³ de béton.",ans:"4×250 = 1 000 kg de ciment"},
       {pts:7,text:"Calculer la masse de gravier et de sable pour 4 m³.",ans:"1 part ciment = 1000/2 = 500 kg. Gravier = 7×500 = 3 500 kg. Sable = 5×500 = 2 500 kg"},
       {pts:7,text:"On peint 48 m² en 2 couches (1 L = 5 m²/couche). Pots A=5L à 79,90 €, Pots B=10L à 129,90 €, offre : −50% sur le 2e article identique. Quel est le choix le moins cher ?",ans:"Volume = 2×48/5 = 19,2 L. 2 pots B : 129,90+64,95=194,85 € (20 L). 4 pots A : 79,90×2+39,95×2=239,70 €. Choisir 2 pots B."}
     ]},
    {title:"Volumes — Rampe d'accès prisme triangulaire",notion:"Volumes",pts:20,
     intro:"Rampe prisme triangulaire : AC=30 cm (hauteur), angle ACB=90°, AB=124 cm, longueur BE=9 m. — DNB Polynésie, sept. 2023",
     questions:[
       {pts:6,text:"Montrer que BC ≈ 120 cm.",ans:"BC = √(AB²−AC²) = √(15376−900) = √14476 ≈ 120,3 cm ≈ 120 cm ✓"},
       {pts:6,text:"Calculer l'angle ABC (au degré près).",ans:"tan(ABC) = AC/BC = 30/120 = 0,25 → angle ABC ≈ 14°"},
       {pts:8,text:"Les propriétaires prévoient 2 m³ de béton. Ce volume suffit-il pour la rampe ?",ans:"Aire base = (1/2)×120×30 = 1800 cm² = 0,18 m². V rampe = 0,18×9 = 1,62 m³ < 2 m³. Oui, suffisant ✓"}
     ]},
    {title:"Volumes — Bougies cylindriques",notion:"Volumes",pts:16,
     intro:"Bougie cylindrique : rayon 3 cm, hauteur 12 cm. Volume de cire = 9/10 du volume total. Densité cire = 0,7 g/cm³. — DNB Amérique du Sud, nov. 2023",
     questions:[
       {pts:6,text:"Montrer que le volume d'une bougie est d'environ 339 cm³.",ans:"V = π×3²×12 = 108π ≈ 339,3 cm³ ≈ 339 cm³ ✓"},
       {pts:5,text:"Calculer la masse de cire nécessaire pour une bougie (au gramme près).",ans:"V cire = 9/10×339 = 305,1 cm³. Masse = 305,1×0,7 ≈ 214 g"},
       {pts:5,text:"Objectif production : moyenne de 7 900 bougies/mois sur 3 mois. Janvier : 6 500. Février : 8 000. Combien faut-il en produire en mars ?",ans:"Total objectif = 7900×3 = 23 700. Déjà produit = 6500+8000 = 14500. Mars = 23700−14500 = 9 200 bougies"}
     ]}
  ],

  algorithmique2023:[
    {title:"Algorithmique — Motif Fleur (Scratch)",notion:"Algorithmique",pts:20,
     source:"DNB Amérique du Nord, 31 mai 2023",
     intro:"Le programme Scratch ci-dessous trace une fleur composée de 5 pétales en forme de parallélogramme (35 pas × 20 pas, angles 60° et 120°).",
     figure:`<div class="scratch-wrap"><div class="scratch-code"><div class="scratch-hat sb-event">🏁 Quand ⚑ est cliqué</div><div class="scratch-block sb-looks">Définir <b>Pétale</b></div><div class="scratch-block sb-motion">Avancer de <span class="scratch-val">35</span> pas</div><div class="scratch-block sb-motion">Tourner ↺ de <span class="scratch-val">60</span> °</div><div class="scratch-block sb-motion">Avancer de <span class="scratch-val">20</span> pas</div><div class="scratch-block sb-motion">Tourner ↺ de <span class="scratch-val">120</span> °</div><div class="scratch-block sb-motion">… (× 2)</div><div style="height:6px"></div><div class="scratch-hat sb-looks">Définir <b>Fleur</b></div><div class="scratch-repeat">Répéter <span class="scratch-val">5</span> fois<div class="scratch-repeat-body"><div class="scratch-block sb-looks">Pétale</div><div class="scratch-block sb-motion">Tourner ↻ de <span class="scratch-val">72</span> °</div></div></div><div class="scratch-block sb-looks">Fleur</div></div><div class="scratch-result"><div class="scratch-result-label">Résultat affiché</div><svg viewBox="-120 -120 240 240" width="180" height="180" xmlns="http://www.w3.org/2000/svg">
  <g id="petale" transform="rotate(0)">
    <ellipse cx="40" cy="0" rx="35" ry="18" fill="#ff6680" opacity=".85" stroke="#cc3355" stroke-width="1"/>
  </g>
  <use href="#petale" transform="rotate(72)"/>
  <use href="#petale" transform="rotate(144)"/>
  <use href="#petale" transform="rotate(216)"/>
  <use href="#petale" transform="rotate(288)"/>
  <circle cx="0" cy="0" r="6" fill="#ffcc00" stroke="#cc9900" stroke-width="1"/>
</svg></div></div>`,
     questions:[
       {pts:6,text:"Expliquer pourquoi le bloc Fleur utilise 72° entre chaque pétale.",ans:"360° ÷ 5 pétales = 72°. Cela garantit un placement régulier sur tout le tour."},
       {pts:7,text:"Combien de fois faut-il répéter le bloc Pétale pour une fleur à 5 pétales ?",ans:"5 fois (5 rotations de 72° = 360° → retour à la position initiale)."},
       {pts:7,text:"On modifie pour une fleur à 6 pétales. Quelles modifications apporter ?",ans:"Nombre de répétitions : 6. Angle de rotation : 360°/6 = 60°."}
     ]},
    {title:"Algorithmique — Carrés imbriqués avec Scratch",notion:"Algorithmique",pts:19,
     source:"DNB Polynésie, sept. 2023",
     intro:"Le programme Scratch ci-dessous trace 10 carrés emboîtés. Le côté du premier carré mesure 300 pixels. À chaque itération, le côté est multiplié par 0,8 (réduction de 20 %).",
     figure:`<div class="scratch-wrap"><div class="scratch-code"><div class="scratch-hat sb-event">🏁 Quand ⚑ est cliqué</div><div class="scratch-block sb-variable">Mettre <span class="scratch-oval">Côté</span> à <span class="scratch-val">300</span></div><div class="scratch-repeat">Répéter <span class="scratch-val">10</span> fois<div class="scratch-repeat-body"><div class="scratch-repeat">Répéter <span class="scratch-val">4</span> fois<div class="scratch-repeat-body"><div class="scratch-block sb-motion">Avancer de <span class="scratch-oval">Côté</span> pas</div><div class="scratch-block sb-motion">Tourner ↻ de <span class="scratch-val">90</span> °</div></div></div><div class="scratch-block sb-motion">Tourner ↻ de <span class="scratch-val">10</span> °</div><div class="scratch-block sb-variable">Mettre <span class="scratch-oval">Côté</span> à <span class="scratch-oval">Côté × 0.8</span></div></div></div></div><div class="scratch-result"><div class="scratch-result-label">10 carrés imbriqués</div><svg viewBox="-160 -160 320 320" width="180" height="180" xmlns="http://www.w3.org/2000/svg">
  <rect x="-150.0" y="-150.0" width="300.0" height="300.0" fill="none" stroke="#002FA7" stroke-width="2"/>
  <rect x="-120.0" y="-120.0" width="240.0" height="240.0" fill="none" stroke="#1a4fc4" stroke-width="2"/>
  <rect x="-96.0" y="-96.0" width="192.0" height="192.0" fill="none" stroke="#3366cc" stroke-width="2"/>
  <rect x="-76.8" y="-76.8" width="153.6" height="153.6" fill="none" stroke="#4d80d9" stroke-width="2"/>
  <rect x="-61.4" y="-61.4" width="122.9" height="122.9" fill="none" stroke="#6699e6" stroke-width="2"/>
  <rect x="-49.2" y="-49.2" width="98.3" height="98.3" fill="none" stroke="#80b3f0" stroke-width="2"/>
  <rect x="-39.3" y="-39.3" width="78.6" height="78.6" fill="none" stroke="#99c6f5" stroke-width="2"/>
  <rect x="-31.5" y="-31.5" width="62.9" height="62.9" fill="none" stroke="#b3d9f8" stroke-width="2"/>
  <rect x="-25.2" y="-25.2" width="50.3" height="50.3" fill="none" stroke="#ccebfc" stroke-width="2"/>
  <rect x="-20.1" y="-20.1" width="40.3" height="40.3" fill="none" stroke="#e6f5ff" stroke-width="2"/>
</svg></div></div>`,
     questions:[
       {pts:5,text:"Montrer que le côté du 2e carré mesure 240 pixels.",ans:"300×0,8 = 240 pixels ✓"},
       {pts:7,text:"Quelle est la longueur du dernier carré (10e) ? Arrondir au pixel.",ans:"300 × 0,8⁹ = 300 × 0,1342… ≈ 40 pixels"},
       {pts:7,text:"Le script exécute 'mettre Côté à Côté×0,8' dans une boucle. Quelle est la valeur du côté après 3 itérations ?",ans:"300 → 240 → 192 → 153,6 ≈ 154 pixels"}
     ]},
    {title:"Algorithmique — Triangle et Scratch (2024)",notion:"Algorithmique",pts:19,
     source:"DNB Amérique du Nord, 29 mai 2024",
     intro:"Le programme Scratch ci-dessous trace deux triangles équilatéraux. La variable côté est saisie par l'utilisateur pour le grand triangle ABC (AB = 240 mm), puis recalculée pour le petit triangle CDE.",
     figure:`<div class="scratch-wrap"><div class="scratch-code"><div class="scratch-hat sb-event">🏁 Quand ⚑ est cliqué</div><div class="scratch-block sb-motion">Aller à x: <span class="scratch-val">-180</span> y: <span class="scratch-val">-150</span></div><div class="scratch-block sb-motion">Stylo en position d'écriture</div><div class="scratch-block sb-variable">Mettre <span class="scratch-oval">côté</span> à <span class="scratch-val">?</span></div><div class="scratch-repeat">Répéter <span class="scratch-val">3</span> fois<div class="scratch-repeat-body"><div class="scratch-block sb-motion">Avancer de <span class="scratch-oval">côté</span> pas</div><div class="scratch-block sb-motion">Tourner ↻ de <span class="scratch-val">120</span> °</div></div></div><div class="scratch-block sb-motion">Aller à x: <span class="scratch-val">?</span> y: <span class="scratch-val">?</span></div><div class="scratch-block sb-variable">Mettre <span class="scratch-oval">côté</span> à <span class="scratch-oval">côté / 3</span></div><div class="scratch-repeat">Répéter <span class="scratch-val">3</span> fois<div class="scratch-repeat-body"><div class="scratch-block sb-motion">Avancer de <span class="scratch-oval">côté</span> pas</div><div class="scratch-block sb-motion">Tourner ↻ de <span class="scratch-val">120</span> °</div></div></div></div><div class="scratch-result"><div class="scratch-result-label">Triangles tracés</div><svg viewBox="-20 -20 300 280" width="200" height="190" xmlns="http://www.w3.org/2000/svg">
  <defs><style>text{font:11px 'Barlow Condensed',sans-serif;fill:#0a0a0a;font-weight:700}.dim{fill:#002FA7;font-size:10px}</style></defs>
  <!-- Grand triangle ABC équilatéral côté 240 -->
  <!-- A bas-gauche, B bas-droite, C sommet -->
  <polygon points="0,240 240,240 120,32" fill="rgba(0,47,167,.07)" stroke="#002FA7" stroke-width="2.5" stroke-linejoin="round"/>
  <text x="-14" y="254">A</text>
  <text x="243" y="254">B</text>
  <text x="115" y="22">C</text>
  <!-- Petit triangle CDE — C sommet, D et E sur les côtés CA et CB, côté=80 -->
  <!-- D sur CA à 80 pas de C, E sur CB à 80 pas de C -->
  <!-- CA va de (120,32) à (0,240) → direction (-120,208), longueur 240 -->
  <!-- D = C + (80/240)*(-120,208) = (120-40, 32+69) = (80,101) -->
  <!-- E = C + (80/240)*(120,208) = (120+40, 32+69) = (160,101) -->
  <polygon points="120,32 80,101 160,101" fill="rgba(13,122,62,.12)" stroke="#0d7a3e" stroke-width="2" stroke-linejoin="round"/>
  <text x="70" y="118" fill="#0d7a3e">D</text>
  <text x="163" y="118" fill="#0d7a3e">E</text>
  <!-- Dimensions -->
  <text x="100" y="260" class="dim">AB = 240 mm</text>
  <text x="88" y="85" class="dim" fill="#0d7a3e">DE = 80 mm</text>
  <!-- Codages côtés égaux -->
  <line x1="56" y1="137" x2="68" y2="131" stroke="#002FA7" stroke-width="1.5"/>
  <line x1="62" y1="140" x2="74" y2="134" stroke="#002FA7" stroke-width="1.5"/>
  <line x1="175" y1="131" x2="187" y2="137" stroke="#002FA7" stroke-width="1.5"/>
  <line x1="181" y1="134" x2="193" y2="140" stroke="#002FA7" stroke-width="1.5"/>
</svg></div></div>`,
     questions:[
       {pts:5,text:"Quelles sont les coordonnées du point de départ du lutin ?",ans:"Ligne 2 du programme : aller à x:−180, y:−150. Coordonnées = (−180 ; −150)"},
       {pts:7,text:"Quelle valeur saisir à la ligne 4 (mettre côté à ...) pour tracer le grand triangle ?",ans:"côté = 240 (AB = 240 mm = 240 pas)"},
       {pts:7,text:"Expliquer l'instruction 'côté/3' (ligne 8) et calculer le côté du petit triangle.",ans:"CE = 80 mm = 240/3 → réduction de rapport 1/3. côté/3 = 240/3 = 80 pas."}
     ]}
  ]
};

/* ═══════════════════════════════
   SETUP
═══════════════════════════════ */
function selTimer(el){
  document.querySelectorAll('.timer-chip').forEach(c=>c.classList.remove('sel'));
  el.classList.add('sel'); selMin = parseInt(el.dataset.min);
  const h=Math.floor(selMin/60),m=selMin%60;
  document.getElementById('setupTimerVal').textContent = h>0?(m>0?`${h}h${m}`:h+'h'):m+' min';
}
function selChap(el){
  const id=el.dataset.id;
  if(id==='all'){
    document.querySelectorAll('.chap-chip').forEach(c=>{c.classList.remove('sel');c.querySelector('.chk').textContent='';});
    el.classList.add('sel'); el.querySelector('.chk').textContent='✓';
    selChaps=['all'];
  } else {
    const allC=document.querySelector('.chap-chip[data-id="all"]');
    allC.classList.remove('sel'); allC.querySelector('.chk').textContent='';
    el.classList.toggle('sel');
    el.querySelector('.chk').textContent = el.classList.contains('sel')?'✓':'';
    selChaps=[...document.querySelectorAll('.chap-chip.sel')].map(c=>c.dataset.id).filter(i=>i!=='all');
    if(!selChaps.length){ allC.classList.add('sel'); allC.querySelector('.chk').textContent='✓'; selChaps=['all']; }
  }
}

/* ═══════════════════════════════
   EXAM
═══════════════════════════════ */
function pickExercises(){
  let pool=[];
  if(selChaps.includes('all')){
    Object.values(BANK).forEach(arr=>pool.push(...arr));
  } else {
    selChaps.forEach(ch=>{
      // Include base key and all extended keys (e.g. probabilites + probabilites2023 + probabilites2023a)
      Object.keys(BANK).filter(k=>k===ch||k.startsWith(ch)).forEach(k=>pool.push(...BANK[k]));
    });
  }
  for(let i=pool.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[pool[i],pool[j]]=[pool[j],pool[i]];}
  return pool.slice(0,5);
}

function startExam(){
  const picked=pickExercises(); if(!picked.length) return;
  exerciseData=picked; scores={}; validated={}; feedbacks={};
  go('screen-exam',null);
  document.getElementById('exContainer').innerHTML='';
  document.getElementById('examFooter').style.display='none';
  document.getElementById('loadingBox').style.display='block';
  document.getElementById('examSub').textContent='Chargement…';
  startTimer(selMin*60);
  setTimeout(renderExam, 300);
}

function renderExam(){
  document.getElementById('loadingBox').style.display='none';
  const container=document.getElementById('exContainer');
  const pills=document.getElementById('pillsBar');
  pills.innerHTML=''; container.innerHTML='';
  document.getElementById('examSub').textContent=[...new Set(exerciseData.map(e=>e.notion))].join(' · ');

  exerciseData.forEach((ex,ei)=>{
    const exId=`ex${ei+1}`;
    const totalPts=ex.questions.reduce((s,q)=>s+q.pts,0);

    const pill=document.createElement('button');
    pill.className='pill'; pill.id=`pill-${exId}`;
    pill.textContent=`Ex. ${ei+1} — ${ex.notion}`;
    pill.onclick=()=>document.getElementById(exId)?.scrollIntoView({behavior:'smooth',block:'start'});
    pills.appendChild(pill);

    let tableHTML='';
    if(ex.tableData){tableHTML=`<table><tr>${ex.tableData.headers.map(h=>`<th>${h}</th>`).join('')}</tr>${ex.tableData.rows.map(r=>`<tr>${r.map(cell=>`<td>${cell}</td>`).join('')}</tr>`).join('')}</table>`;}

    // Figure & program rendering
    let figureHTML='';
    if(ex.figure){
      figureHTML=`<div class="ex-figure">${ex.figure}</div>`;
    } else if(ex.calcProgram){
      const steps=ex.calcProgram.map(s=>`<div class="calc-step"><div class="calc-step-label">${s.label}</div><div class="calc-step-val">${s.val}</div></div>`).join('<div class="calc-arrow">→</div>');
      figureHTML=`<div class="calc-program"><div class="calc-program-title">Programme de calcul</div><div class="calc-program-steps">${steps}</div></div>`;
    } else if(ex.calcProgram2){
      const progs=ex.calcProgram2.map(p=>{
        const steps=p.steps.map(s=>`<div class="calc-step"><div class="calc-step-label">${s.label}</div><div class="calc-step-val">${s.val}</div></div>`).join('<div class="calc-arrow">→</div>');
        return `<div style="margin-bottom:12px"><div style="font-size:11px;font-weight:600;color:var(--klein);margin-bottom:8px;letter-spacing:1px;text-transform:uppercase">${p.name}</div><div class="calc-program-steps">${steps}</div></div>`;
      }).join('');
      figureHTML=`<div class="calc-program"><div class="calc-program-title">Programmes de calcul</div><div style="padding:14px 20px 4px">${progs}</div></div>`;
    }

    let qHTML='';
    ex.questions.forEach((q,qi)=>{
      const qId=`${exId}q${qi+1}`;
      const ae=escQ(q.ans);
      qHTML+=`<div class="question">
        <div class="q-head"><span class="q-num">Question ${ei+1}.${qi+1}</span><span class="q-pts-badge">${q.pts} pts</span></div>
        <div class="q-text">${q.text}</div>
        <div class="answer-zone">
          <div class="answer-lbl">Ma réponse</div>
          <textarea class="answer-ta" id="a-${qId}" placeholder="Rédigez votre réponse ici…" oninput="onType(this)"></textarea>
          <div class="val-bar">
            <button class="btn-val" id="vbtn-${qId}" onclick="doVal('${qId}','${exId}',${q.pts},'${ae}')" disabled>✓ Valider</button>
            <button class="btn-edit" id="ebtn-${qId}" onclick="doEdit('${qId}','${exId}')">✎ Modifier</button>
            <span class="val-tag" id="vtag-${qId}">✅ Validée</span>
            <span class="val-hint" id="vhint-${qId}">Rédigez puis validez</span>
          </div>
          <div class="ai-result" id="ar-${qId}"></div>
          <div class="inline-corr-wrap" id="corrq-${qId}" style="display:none"></div>
        </div>
      </div>`;
    });

    const corrBlocks=ex.questions.map((q,qi)=>`<div class="corr-block"><div class="corr-title">Q${ei+1}.${qi+1}</div><p>${q.ans}</p></div>`).join('');

    container.insertAdjacentHTML('beforeend',`<div class="exercise" id="${exId}">
      <div class="ex-head">
        <div>
          <div class="ex-eyebrow">Exercice ${ei+1}</div>
          <div class="ex-title">${ex.title}</div>
          <div class="ex-notion">${ex.notion}${ex.source?` <span style="font-size:10px;color:var(--ink4);font-weight:500;font-style:italic">· ${ex.source}</span>`:''}</div>
        </div>
        <div class="ex-pts"><div class="n">${totalPts}</div><div class="l">points</div></div>
      </div>
      <div class="ex-body">
        <p>${ex.intro}</p>${figureHTML}${tableHTML}${qHTML}
        <div class="corr-toggle">
          <button class="btn-see" id="cBtn-${exId}" onclick="toggleCorr('corr-${exId}','cBtn-${exId}')" disabled>▶ Voir la correction</button>
          <span class="corr-hint" id="chint-${exId}">La correction s'affiche après chaque réponse validée</span>
        </div>
        <div class="correction" id="corr-${exId}">
          <div class="corr-head"><div class="corr-badge">✓</div><span>Correction détaillée</span></div>
          ${corrBlocks}
        </div>
      </div>
    </div>`);
  });

  document.getElementById('examFooter').style.display='flex';
  updateLive();
}

function escQ(s){return(s||'').replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'&quot;');}

/* ═══════════════════════════════
   TIMER
═══════════════════════════════ */
function startTimer(s){ clearInterval(timerIv); secsLeft=s; renderTimer(); timerIv=setInterval(()=>{secsLeft--;renderTimer();if(secsLeft<=0){clearInterval(timerIv);endExam();}},1000); }
function renderTimer(){ const h=Math.floor(secsLeft/3600),m=Math.floor((secsLeft%3600)/60),s=secsLeft%60; const el=document.getElementById('timerFace'); el.textContent=`${p2(h)}:${p2(m)}:${p2(s)}`; el.className='timer-face'+(secsLeft<300?' danger':secsLeft<600?' warn':''); }
function p2(n){return String(n).padStart(2,'0');}
function endEarly(){endExam();}

/* ═══════════════════════════════
   ANSWERS
═══════════════════════════════ */
function onType(el){
  const has=el.value.trim().length>0; el.classList.toggle('has-content',has);
  const qId=el.id.replace('a-','');
  const btn=document.getElementById('vbtn-'+qId); if(btn)btn.disabled=!has;
  const hint=document.getElementById('vhint-'+qId); if(hint)hint.textContent=has?'Cliquez pour valider':'Rédigez puis validez';
}

async function doVal(qId,exId,maxPts,ae){
  const ta=document.getElementById('a-'+qId);
  const answer=ta.value.trim(); if(!answer)return;
  validated[qId]=true; ta.classList.add('locked'); ta.readOnly=true;
  document.getElementById('vbtn-'+qId).style.display='none';
  document.getElementById('ebtn-'+qId).style.display='inline-flex';
  document.getElementById('vtag-'+qId).classList.add('show');
  const hint=document.getElementById('vhint-'+qId); if(hint)hint.textContent='';
  const ar=document.getElementById('ar-'+qId);
  ar.classList.add('visible');
  ar.innerHTML='';
  const corrQEl2 = document.getElementById('corrq-'+qId);
  if(corrQEl2){
    corrQEl2.style.display='block';
    corrQEl2.innerHTML='<div style="padding:12px 16px;background:var(--bg2);border:1.5px solid var(--rule);display:flex;align-items:center;gap:10px"><span class="mini-sp"></span><span style=\'font-family:Barlow Condensed,sans-serif;font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--ink4)\'>Correction en cours…</span></div>';
  }
  const officialAns=ae.replace(/&quot;/g,'"');
  const prompt=`Tu es un correcteur du brevet des collèges en mathématiques. La question vaut ${maxPts} points.\nRéponse officielle : "${officialAns}"\nRéponse de l'élève : "${answer}"\nRéponds UNIQUEMENT en JSON valide : {"pts":<entier 0 à ${maxPts}>,"feedback":"<1-2 phrases courtes en français>"}`;
  let pts=0,feedback='';
  try{
    const resp=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:200,messages:[{role:'user',content:prompt}]})});
    const data=await resp.json();
    const raw=data.content?.[0]?.text||'{}';
    const parsed=JSON.parse(raw.replace(/```json|```/g,'').trim());
    pts=Math.max(0,Math.min(maxPts,Math.round(parsed.pts))); feedback=parsed.feedback||'';
  }catch(e){feedback='Correction indisponible.';}
  scores[qId]=pts; feedbacks[qId]=feedback;
  updateLive(); updatePill(exId); checkAllValidated();
  const ratio=pts/maxPts;
  let cls,icon,label;
  if(ratio>=.85){cls='correct';icon='✓';label='Correct';}
  else if(ratio>=.4){cls='partial';icon='~';label='Partiellement correct';}
  else{cls='wrong';icon='✗';label='Incorrect';}
  // Score flash animation
  const qEl=document.getElementById(qId);
  if(qEl){
    const flash=document.createElement('span');
    flash.className='q-score-flash '+cls;
    flash.textContent=(pts>0?'+':'')+pts+' pt'+(pts>1?'s':'');
    flash.style.position='relative';
    const qHead=qEl.querySelector('.q-head');
    if(qHead){qHead.style.position='relative';qHead.appendChild(flash);}
    setTimeout(()=>flash.remove(),700);
    // Update pts badge in q-head
    const badge=qEl.querySelector('.q-pts-badge');
    if(badge){
      badge.textContent=pts+'/'+maxPts+' pts';
      badge.className='q-pts-badge q-pts-earned '+(cls==='correct'?'earned-full':cls==='partial'?'earned-partial':'earned-none');
    }
  }
  // Build correction HTML for this specific question
  const corrQEl = document.getElementById('corrq-'+qId);
  if(corrQEl){
    corrQEl.innerHTML = `<div class="inline-corr ${cls}-corr">
      <span class="inline-corr-icon">${icon}</span>
      <div class="inline-corr-body">
        <div class="inline-corr-label">${label} · ${pts}/${maxPts} pts</div>
        <div class="inline-corr-feedback">${feedback}</div>
        <div class="inline-corr-official"><strong>Correction :</strong> ${officialAns}</div>
      </div>
    </div>`;
    corrQEl.style.display = 'block';
  }
  ar.innerHTML=`<div class="ai-rh ${cls}-bg"><span class="ai-rl" style="color:${cls==='correct'?'var(--green)':cls==='partial'?'var(--gold)':'var(--red)'}">${icon} ${label}</span><span class="ai-sc ${cls}-col">${pts}<span style="font-size:13px;opacity:.5;font-weight:400"> / ${maxPts} pts</span></span></div><div class="ai-fb">${feedback}</div>`;
}

function doEdit(qId,exId){
  validated[qId]=false; delete scores[qId]; delete feedbacks[qId];
  const ta=document.getElementById('a-'+qId); ta.classList.remove('locked'); ta.readOnly=false; ta.focus();
  document.getElementById('vbtn-'+qId).style.display='inline-flex';
  document.getElementById('vbtn-'+qId).disabled=false;
  document.getElementById('ebtn-'+qId).style.display='none';
  document.getElementById('vtag-'+qId).classList.remove('show');
  const hint=document.getElementById('vhint-'+qId); if(hint)hint.textContent='Modifiez puis revalidez';
  const ar=document.getElementById('ar-'+qId); ar.classList.remove('visible'); ar.innerHTML='';
  const corrQElEdit=document.getElementById('corrq-'+qId);
  if(corrQElEdit){corrQElEdit.style.display='none';corrQElEdit.innerHTML='';}
  updateLive(); updatePill(exId);
}

function toggleCorr(corrId,btnId){
  const p=document.getElementById(corrId),b=document.getElementById(btnId);
  const open=p.classList.contains('open');
  if(open){p.classList.remove('open');b.textContent='▶ Voir la correction';b.classList.remove('active');}
  else{p.classList.add('open');b.textContent='▼ Masquer';b.classList.add('active');setTimeout(()=>p.scrollIntoView({behavior:'smooth',block:'nearest'}),80);}
}

/* ═══════════════════════════════
   SCORING
═══════════════════════════════ */
function totalScore(){return Object.values(scores).reduce((s,v)=>s+v,0);}
function checkAllValidated(){
  if(!exerciseData.length) return;
  const allQIds = exerciseData.flatMap((ex,i)=>ex.questions.map((_,j)=>`ex${i+1}q${j+1}`));
  const total = allQIds.length;
  const doneCount = allQIds.filter(q=>scores[q]!==undefined).length;
  const btn = document.getElementById('btnEnd');
  if(!btn) return;
  if(doneCount === total && total > 0){
    btn.disabled = false;
    btn.classList.add('btn-end-ready');
    btn.title = 'Toutes les réponses validées — cliquez pour voir votre score';
    // Show small toast
    showToast('Toutes les réponses validées — vous pouvez terminer !');
  } else {
    btn.disabled = true;
    btn.classList.remove('btn-end-ready');
    btn.title = `Encore ${total-doneCount} réponse(s) à valider`;
  }
}

let toastTimeout;
function showToast(msg){
  let t = document.getElementById('examToast');
  if(!t){ t=document.createElement('div'); t.id='examToast'; t.className='exam-toast'; document.body.appendChild(t); }
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimeout);
  toastTimeout = setTimeout(()=>t.classList.remove('show'), 3500);
}

function updateLive(){
  const t=totalScore();
  const maxTotal=exerciseData.reduce((s,ex)=>s+ex.questions.reduce((s2,q)=>s2+q.pts,0),0);
  const el=document.getElementById('liveSc');
  if(el){
    const prev=parseInt(el.textContent)||0;
    el.textContent=t;
    if(t>prev){
      el.classList.add('bump');
      setTimeout(()=>el.classList.remove('bump'),350);
    }
  }
  const maxEl=document.getElementById('liveScMax');
  if(maxEl) maxEl.textContent='/'+maxTotal;
  const fe=document.getElementById('footerSc'); if(fe)fe.textContent=t;
  const pct=maxTotal>0?Math.round(t/maxTotal*100):0;
  const prog=document.getElementById('examProgressFill');
  if(prog){
    prog.style.width=pct+'%';
    prog.style.background=pct>=70?'#0a6b38':pct>=40?'#ff8c1a':'#4c97ff';
  }
  const fbar=document.getElementById('footerBarFill');
  if(fbar){fbar.style.width=pct+'%';fbar.style.background=pct>=70?'var(--green)':pct>=50?'var(--amber)':'var(--k)';}
}
function updatePill(exId){
  const idx=parseInt(exId.replace('ex',''))-1;
  const ex=exerciseData[idx]; if(!ex)return;
  const qIds=ex.questions.map((_,i)=>`${exId}q${i+1}`);
  const pill=document.getElementById(`pill-${exId}`); if(!pill)return;
  const anyVal=qIds.some(q=>validated[q]);
  const allGraded=qIds.every(q=>scores[q]!==undefined);
  pill.classList.toggle('answered',anyVal&&!allGraded);
  pill.classList.toggle('corrected',allGraded);
  const cBtn=document.getElementById(`cBtn-${exId}`);
  const chint=document.getElementById(`chint-${exId}`);
  if(cBtn){
    const rem=qIds.filter(q=>!validated[q]).length;
    if(anyVal){cBtn.disabled=false;if(chint)chint.textContent=allGraded?'Correction complète':'Correction partielle disponible';}
    if(allGraded){if(chint)chint.textContent='Correction complète';}
    else if(false&&anyVal){if(chint)chint.textContent=`Encore ${rem} réponse${rem>1?'s':''} à valider`;}
  }
}
function getMention(s){
  if(s>=80)return'Mention Très Bien';
  if(s>=70)return'Mention Bien';
  if(s>=60)return'Mention Assez Bien';
  if(s>=50)return'Encourageant';
  return'À retravailler';
}

/* ═══════════════════════════════
   END EXAM
═══════════════════════════════ */
function endExam(){
  clearInterval(timerIv);
  const total=totalScore();
  const maxTotal=exerciseData.reduce((s,ex)=>s+ex.questions.reduce((s2,q)=>s2+q.pts,0),0);
  const scaled=Math.round(total/maxTotal*100);
  saveSession(scaled);
  go('screen-results',null);
  document.getElementById('resScore').innerHTML=`${scaled} <span>/ 100</span>`;
  document.getElementById('resMention').textContent=getMention(scaled);
  const barCol=scaled>=70?'#1d6b3a':scaled>=50?'#a06c00':'#c0392b';
  setTimeout(()=>{document.getElementById('resBar').style.width=scaled+'%';document.getElementById('resBar').style.background=barCol;},100);

  let correct=0,partial=0,wrong=0;
  exerciseData.forEach((ex,i)=>{ex.questions.forEach((q,j)=>{const r=(scores[`ex${i+1}q${j+1}`]||0)/q.pts;if(r>=.85)correct++;else if(r>=.4)partial++;else wrong++;});});
  document.getElementById('resCorrect').textContent=correct;
  document.getElementById('resPartial').textContent=partial;
  document.getElementById('resWrong').textContent=wrong;

  const ns={};
  exerciseData.forEach((ex,i)=>{const n=ex.notion;if(!ns[n])ns[n]={e:0,m:0};ex.questions.forEach((q,j)=>{const qId=`ex${i+1}q${j+1}`;ns[n].e+=scores[qId]||0;ns[n].m+=q.pts;});});
  let nH='';
  Object.entries(ns).forEach(([n,v])=>{const pct=Math.round(v.e/v.m*100);const col=pct>=70?'var(--green)':pct>=40?'var(--gold)':'var(--red)';nH+=`<div class="bdown-row"><div><div class="bdown-notion">${n}</div><div class="bdown-pct"><div class="bdown-pct-fill" style="width:${pct}%;background:${col}"></div></div></div><div class="bdown-pts" style="color:${col}">${v.e}/${v.m}</div></div>`;});
  document.getElementById('resByNotion').innerHTML=nH||'<p style="color:var(--ink4);font-style:italic">Aucune question validée.</p>';

  let eH='',ec=0;
  exerciseData.forEach((ex,i)=>{ex.questions.forEach((q,j)=>{const qId=`ex${i+1}q${j+1}`;const sc=scores[qId]||0;if(sc<q.pts*.85&&feedbacks[qId]){ec++;const col=sc===0?'var(--red)':'var(--gold)';eH+=`<div class="err-card"><div class="err-q">${q.text.substring(0,90)}…</div><div class="err-sc" style="color:${col}">${sc}/${q.pts} pts</div><div class="err-fb">${feedbacks[qId]}</div></div>`;}});});
  document.getElementById('resErrors').innerHTML=ec?eH:'<p style="color:var(--green);font-weight:600">🎉 Excellente performance !</p>';

  setTimeout(()=>document.querySelectorAll('.bdown-pct-fill').forEach(el=>{const w=el.style.width;el.style.width='0';setTimeout(()=>el.style.width=w,50);}),100);

  // ── Generate immediate AI comment on score ──
  generateComment(scaled, correct, partial, wrong, ns);
  // ── Generate AI revision advice ──
  generateAdvice(scaled, ns, feedbacks, scores);
}

async function generateComment(scaled, correct, partial, wrong, ns){
  const el = document.getElementById('resComment');
  if(!el) return;

  const mention = getMention(scaled);
  const total = correct + partial + wrong;
  const weakNotions = Object.entries(ns)
    .filter(([,v])=>Math.round(v.e/v.m*100)<50)
    .map(([n])=>n).slice(0,2).join(', ') || null;

  const prompt = `Tu es un professeur de maths bienveillant. Un élève de 3ème vient d'obtenir ${scaled}/100 (${mention}) à son brevet blanc. ${correct} réponses correctes, ${partial} partielles, ${wrong} incorrectes sur ${total} questions.${weakNotions?' Notions faibles : '+weakNotions+'.':''}
Écris UNE SEULE phrase de commentaire personnalisée, chaleureuse et directe. Commence par une constatation du score, puis une motivation ou un conseil en une phrase. Maximum 25 mots. En français. Réponds uniquement avec la phrase, sans guillemets.`;

  try{
    const resp = await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:80,messages:[{role:'user',content:prompt}]})
    });
    const data = await resp.json();
    const comment = (data.content?.[0]?.text||'').trim();
    if(comment){
      el.innerHTML = `<div class="res-comment-text"><strong>${mention}</strong>${comment}</div>`;
      // Save comment to last session
      saveCommentToSession(comment);
    }
  }catch(e){
    const fallback = `Score de ${scaled}/100 — ${mention}.`;
    el.innerHTML = `<div class="res-comment-text"><strong>${mention}</strong>${fallback}</div>`;
    saveCommentToSession(fallback);
  }
}

async function saveCommentToSession(comment){
  try{
    const d = await window.storage.get('sessions');
    if(!d?.value) return;
    const sessions = JSON.parse(d.value);
    if(sessions.length > 0){
      sessions[sessions.length-1].comment = comment;
      await window.storage.set('sessions', JSON.stringify(sessions));
    }
  }catch(e){}
}

async function generateAdvice(scaled, notionScores, feedbacksObj, scoresObj){
  const adviceEl = document.getElementById('resAdvice');
  if(!adviceEl) return;

  const weak=[], mid=[], strong=[];
  Object.entries(notionScores).forEach(([n,v])=>{
    const pct = Math.round(v.e/v.m*100);
    if(pct<40) weak.push({n,pct});
    else if(pct<70) mid.push({n,pct});
    else strong.push({n,pct});
  });

  const errorDetails = exerciseData.flatMap((ex,i)=>
    ex.questions.map((q,j)=>{
      const qId=`ex${i+1}q${j+1}`;
      const sc=scoresObj[qId]||0;
      return sc<q.pts*.85 ? {notion:ex.notion,q:q.text.substring(0,80),sc,max:q.pts,fb:feedbacksObj[qId]||''} : null;
    })
  ).filter(Boolean).slice(0,8);

  const mention = scaled>=90?'Excellent':scaled>=80?'Très Bien':scaled>=70?'Bien':scaled>=60?'Assez Bien':scaled>=50?'Admis':'À retravailler';

  const prompt = `Tu es un professeur de mathématiques bienveillant préparant des élèves de 3ème au Brevet (DNB).
Un élève vient de terminer un brevet blanc. Score : ${scaled}/100 (${mention}).
Notions maîtrisées (≥70%) : ${strong.map(x=>x.n+'('+x.pct+'%)').join(', ')||'aucune'}
Notions à consolider (40-70%) : ${mid.map(x=>x.n+'('+x.pct+'%)').join(', ')||'aucune'}
Notions faibles (<40%) : ${weak.map(x=>x.n+'('+x.pct+'%)').join(', ')||'aucune'}
Erreurs : ${errorDetails.map(e=>'['+e.notion+'] '+e.q+(e.fb?' → '+e.fb:'')).join(' | ')||'aucune'}
Réponds UNIQUEMENT en JSON valide sans markdown :
{"encouragement":"<1 phrase personnalisée chaleureuse>","priorites":[{"notion":"<nom>","priorite":"haute|moyenne|faible","conseil":"<conseil concret 1-2 phrases>","tag":"<mot-clé court>"}],"methodologie":"<1 conseil méthode personnalisé>","objectif":"<1 objectif concret pour la prochaine session>"}
Maximum 3 priorités. Sois concret et bienveillant. En français.`;

  try{
    const resp = await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:700,messages:[{role:'user',content:prompt}]})
    });
    const data = await resp.json();
    const raw = (data.content?.[0]?.text||'{}').replace(/```json|```/g,'').trim();
    const advice = JSON.parse(raw);

    const prioColors = {haute:'red',moyenne:'amber',faible:'green'};
    const prioLabels = {haute:'Priorité haute',moyenne:'À consolider',faible:'Presque acquis'};

    let html = '';
    if(advice.priorites?.length){
      html += '<div class="advice-section"><div class="advice-section-title">Priorités de révision</div>';
      advice.priorites.forEach(p=>{
        const col = prioColors[p.priorite]||'blue';
        const cls = p.priorite==='haute'?'high':p.priorite==='moyenne'?'mid':'low';
        html += `<div class="advice-item priority-${cls}"><span class="advice-tag ${col}">${prioLabels[p.priorite]||p.priorite}${p.tag?' · '+p.tag:''}</span><div><strong style="font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:800;text-transform:uppercase;letter-spacing:.3px">${p.notion}</strong></div><div style="margin-top:4px;font-size:13px">${p.conseil}</div></div>`;
      });
      html += '</div>';
    }
    if(advice.methodologie){
      html += `<div class="advice-section"><div class="advice-section-title">Méthode de travail</div><div class="advice-item">${advice.methodologie}</div></div>`;
    }
    if(advice.objectif){
      html += `<div class="advice-section"><div class="advice-section-title">Prochain objectif</div><div class="advice-item priority-low" style="border-left-color:var(--k)">${advice.objectif}</div></div>`;
    }
    if(advice.encouragement){
      html += `<div class="advice-encouragement">${advice.encouragement}</div>`;
    }
    adviceEl.innerHTML = html || '<p style="color:var(--ink4);font-style:italic;font-size:13px">Conseils non disponibles.</p>';
  }catch(e){
    adviceEl.innerHTML = '<p style="color:var(--ink4);font-style:italic;font-size:13px">Analyse temporairement indisponible.</p>';
  }
}

/* ═══════════════════════════════
   STORAGE
═══════════════════════════════ */
async function saveSession(scaled){
  const s={date:new Date().toLocaleDateString('fr-FR'),ts:Date.now(),score:scaled,notions:[...new Set(exerciseData.map(e=>e.notion))],duration:selMin,comment:'',errors:[]};
  exerciseData.forEach((ex,i)=>{ex.questions.forEach((q,j)=>{const qId=`ex${i+1}q${j+1}`;const sc=scores[qId]||0;if(sc<q.pts*.85)s.errors.push({notion:ex.notion,pts:sc,maxPts:q.pts,fb:feedbacks[qId]||'',qText:q.text.substring(0,80)});});});
  try{
    let sessions=[];
    try{const d=await window.storage.get('sessions');if(d)sessions=JSON.parse(d.value);}catch(e){}
    sessions.push(s);
    if(sessions.length>100)sessions.splice(0,sessions.length-100);
    await window.storage.set('sessions',JSON.stringify(sessions));
  }catch(e){}
}

/* ═══════════════════════════════
   DASHBOARD
═══════════════════════════════ */
async function renderDash(){
  let sessions=[];
  try{const d=await window.storage.get('sessions');if(d?.value)sessions=JSON.parse(d.value);}catch(e){}

  if(!sessions.length){
    document.getElementById('dashStats').innerHTML='';
    document.getElementById('chartSection').style.display='none';
    document.getElementById('dashGrid').innerHTML=`<div class="empty-state" style="grid-column:1/-1;padding:60px 20px;text-align:center">
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--ink5);margin-bottom:16px">Aucune session</div>
      <p style="color:var(--ink4);font-size:14px;margin-bottom:24px">Effectuez votre premier brevet blanc pour voir vos statistiques et recevoir des conseils personnalisés.</p>
      <button class="btn btn-primary" onclick="go('screen-setup','navSetup')">Commencer un brevet</button>
    </div>`;
    return;
  }

  const avg=Math.round(sessions.reduce((s,x)=>s+x.score,0)/sessions.length);
  const best=Math.max(...sessions.map(x=>x.score));
  const last=sessions[sessions.length-1].score;
  const trend=sessions.length>1?last-sessions[sessions.length-2].score:0;
  const trendStr=trend>0?`+${trend} pts`:trend<0?`${trend} pts`:'stable';
  const trendCol=trend>0?'var(--green)':trend<0?'var(--red)':'var(--ink4)';

  // Mention pour le dernier score
  const lastMention = getMention(last);
  const mentionCol = last>=80?'var(--green)':last>=60?'var(--amber)':'var(--red)';

  document.getElementById('dashStats').innerHTML=`
    <div class="stat-card"><div class="sc-val blue">${sessions.length}</div><div class="sc-lbl">Brevets effectués</div></div>
    <div class="stat-card"><div class="sc-val green">${avg}<span style="font-size:16px;font-weight:600;color:var(--ink4)">/100</span></div><div class="sc-lbl">Moyenne générale</div></div>
    <div class="stat-card"><div class="sc-val gold">${best}<span style="font-size:16px;font-weight:600;color:var(--ink4)">/100</span></div><div class="sc-lbl">Meilleur score</div></div>
    <div class="stat-card"><div class="sc-val" style="font-size:22px;color:${trendCol}">${trendStr}</div><div class="sc-lbl">Évolution</div></div>
    <div class="stat-card"><div class="sc-val" style="font-size:18px;color:${mentionCol}">${lastMention}</div><div class="sc-lbl">Dernier résultat</div></div>`;

  // Chart
  if(sessions.length>=2){
    document.getElementById('chartSection').style.display='block';
    const recent=sessions.slice(-12);
    document.getElementById('chartWrap').innerHTML=recent.map(s=>{
      const h=Math.max(4,Math.round(s.score));
      const col=s.score>=80?'var(--green)':s.score>=60?'var(--amber)':'var(--red)';
      return `<div class="chart-col"><div class="chart-val">${s.score}</div><div class="chart-bar" style="height:${h}px;background:${col};opacity:.8" title="${s.date}: ${s.score}/100"></div><div class="chart-lbl">${s.date.split('/').slice(0,2).join('/')}</div></div>`;
    }).join('');
  } else {
    document.getElementById('chartSection').style.display='none';
  }

  // Col 1: Historique
  let hH=`<table class="hist-table"><thead><tr><th>Date</th><th>Score</th><th>Mention</th><th>Commentaire</th></tr></thead><tbody>`;
  [...sessions].reverse().slice(0,15).forEach(s=>{
    const mention=getMention(s.score);
    const col=s.score>=80?'var(--green)':s.score>=60?'var(--amber)':'var(--red)';
    hH+=`<tr>
      <td style="font-size:12px;white-space:nowrap">${s.date}</td>
      <td style="white-space:nowrap"><strong style="font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:900;color:${col}">${s.score}/100</strong></td>
      <td style="white-space:nowrap"><span style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:${col}">${mention}</span></td>
      <td style="font-size:12px;color:var(--ink3);font-style:italic;line-height:1.4;max-width:220px">${s.comment||'<span style="color:var(--ink5)">—</span>'}</td>
    </tr>`;
  });
  hH+='</tbody></table>';

  // Col 2: Points faibles par notion
  const nErrs={};
  sessions.forEach(s=>{(s.errors||[]).forEach(e=>{if(!nErrs[e.notion])nErrs[e.notion]=0;nErrs[e.notion]++;});});
  const sorted=Object.entries(nErrs).sort((a,b)=>b[1]-a[1]);
  let wH='';
  if(!sorted.length){
    wH='<p style="color:var(--green);font-family:Barlow Condensed,sans-serif;font-size:12px;font-weight:700;letter-spacing:1px;text-transform:uppercase">Aucun point faible identifié</p>';
  } else {
    const mx=Math.max(...sorted.map(([,v])=>v),1);
    sorted.slice(0,8).forEach(([n,v])=>{
      const pct=Math.round(v/mx*100);
      const col=pct>60?'var(--red)':pct>30?'var(--amber)':'var(--green)';
      wH+=`<div class="nb-row"><div class="nb-label">${n}</div><div class="nb-track"><div class="nb-fill" style="width:0%;background:${col}" data-w="${pct}%"></div></div><div class="nb-count">${v}</div></div>`;
    });
  }

  // Col 3: Conseils IA
  const adviceHtml = `<div class="dash-advice-col">
    <div class="res-col-title">Conseils pour progresser</div>
    <div id="dashAdvice"><div class="advice-loading"><span class="mini-sp" style="width:14px;height:14px;border-width:2px"></span><span>Analyse en cours…</span></div></div>
  </div>`;

  document.getElementById('dashGrid').innerHTML=`
    <div>
      <div class="res-col-title">Historique des sessions</div>
      ${hH}
    </div>
    <div>
      <div class="res-col-title">Points faibles par notion</div>
      <div id="weakNotions">${wH}</div>
    </div>
    ${adviceHtml}`;

  setTimeout(()=>{
    document.querySelectorAll('.nb-fill[data-w]').forEach(el=>{
      const w=el.getAttribute('data-w');
      setTimeout(()=>el.style.width=w,50);
    });
  },100);

  // Generate AI advice for dashboard
  generateDashAdvice(sessions, avg, best, sorted);
}

async function generateDashAdvice(sessions, avg, best, weakNotions){
  const adviceEl = document.getElementById('dashAdvice');
  if(!adviceEl) return;

  const last = sessions[sessions.length-1];
  const trend = sessions.length>1 ? last.score - sessions[sessions.length-2].score : 0;
  const scores_list = sessions.slice(-5).map(s=>s.score).join(', ');
  const top3weak = weakNotions.slice(0,3).map(([n,v])=>n+'('+v+' erreurs)').join(', ') || 'aucune';
  const lastMention = getMention(last.score);

  const prompt = `Tu es un professeur de maths bienveillant. Voici le profil d'un élève de 3ème qui prépare le Brevet DNB :
- Nombre de brevets blancs effectués : ${sessions.length}
- Scores récents (du plus ancien au plus récent) : ${scores_list}
- Moyenne générale : ${avg}/100 (${lastMention} sur le dernier)
- Meilleur score : ${best}/100
- Tendance : ${trend>0?'+'+trend+' pts (progression)':trend<0?trend+' pts (régression)':'stable'}
- Notions avec le plus d'erreurs accumulées : ${top3weak}

Génère des conseils de révision personnalisés pour aider cet élève à progresser. Réponds UNIQUEMENT en JSON valide (pas de markdown) :
{
  "bilan": "<1 phrase sur l'état général de l'élève>",
  "conseils": [
    {"titre":"<court>","texte":"<conseil concret 2-3 phrases>","priorite":"haute|normale"}
  ],
  "plan": "<plan de révision concret pour les prochaines sessions, 2-3 phrases>"
}
Maximum 3 conseils. Bienveillant, précis, en français.`;

  try {
    const resp = await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:600,messages:[{role:'user',content:prompt}]})
    });
    const data = await resp.json();
    const raw = (data.content?.[0]?.text||'{}').replace(/```json|```/g,'').trim();
    const advice = JSON.parse(raw);

    let html = '';
    if(advice.bilan){
      html += `<div style="font-size:13px;color:var(--ink2);padding:10px 14px;background:var(--k-bg);border-left:3px solid var(--k);margin-bottom:16px;line-height:1.6">${advice.bilan}</div>`;
    }
    (advice.conseils||[]).forEach(c=>{
      const border = c.priorite==='haute' ? 'var(--red)' : 'var(--k)';
      html += `<div class="advice-item" style="border-left-color:${border};margin-bottom:10px">
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:800;letter-spacing:.5px;text-transform:uppercase;margin-bottom:4px;color:var(--ink3)">${c.titre}</div>
        <div style="font-size:13px;line-height:1.6;color:var(--ink2)">${c.texte}</div>
      </div>`;
    });
    if(advice.plan){
      html += `<div style="margin-top:14px;padding:12px 14px;background:var(--ink);font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:600;color:#fff;line-height:1.55;letter-spacing:.2px">${advice.plan}</div>`;
    }
    adviceEl.innerHTML = html || '<p style="color:var(--ink4);font-size:13px;font-style:italic">Conseils non disponibles.</p>';
  } catch(e) {
    adviceEl.innerHTML = '<p style="color:var(--ink4);font-size:13px;font-style:italic">Analyse temporairement indisponible.</p>';
  }
}
</script>
</body>
</html>
